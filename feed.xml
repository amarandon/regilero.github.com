<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0">
	<channel>
		<title>RBleug</title>
		<description>Regilero's blog; Mostly tech things about web stuff.</description>
		<link>http://regilero.github.io</link>
		
			<item>
				<title>SaltStack, Manage entries in unmanaged files with File Blockreplace</title>
				<description>&lt;p&gt;Makina Corpus recently started to use Salt-stack, and by using it I mean we also started some contributions.
Salt-stack is a great set of tools, but sometimes your needs aren't covered yet, and in theses cases you'll find that salt-stack is also very easy to improve. The community is very open to contributions, on this blog post we'll study one of out first addition, &lt;a href=&quot;http://docs.saltstack.com/ref/states/all/salt.states.file.html#salt.states.file.blockreplace&quot;&gt;&lt;code&gt;file.blockreplace&lt;/code&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;h2&gt;Managed files and unmanaged ones&lt;/h2&gt;

&lt;p&gt;When using salt-stack, one of the most important task is usually to &lt;strong&gt;set some configuration parameters&lt;/strong&gt; for your system services. To do that one of the very useful tool available in the salt-stack toolkit is the
&lt;a href=&quot;http://docs.saltstack.com/ref/states/all/salt.states.file.html#salt.states.file.managed&quot;&gt;&lt;code&gt;file.managed&lt;/code&gt;&lt;/a&gt;. This let you use a file, retrieved from the salt server, computed with a template language like jinja. And you can do almost everything with that, you have a very flexible language, some variables coming from your state, and you create the final setting file. You even have some magic tools like &lt;a href=&quot;http://docs.saltstack.com/ref/states/all/salt.states.file.html#salt.states.file.accumulated&quot;&gt;&lt;code&gt;file.accumulated&lt;/code&gt;&lt;/a&gt; that I will explain in a next post.&lt;/p&gt;

&lt;p&gt;But using this implies that salt will be the &lt;strong&gt;only master&lt;/strong&gt; on this file. On every highstate run from salt the file could be recreated, updated or even removed (not with the managed state, but &lt;code&gt;file.absent&lt;/code&gt; would do that).&lt;/p&gt;

&lt;p&gt;So sometimes &lt;em&gt;managing the whole file is not what you want to do&lt;/em&gt;. Let's see some examples of files that I would not manage with &lt;code&gt;managed&lt;/code&gt;:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;A file inherited from a package, and having a lot of different forms depending on the host, like an apache central configuration file, compare RedHat and Debian versions, Trying to handle that with &lt;code&gt;managed&lt;/code&gt; would maybe mean re-doing the package maintainers job&lt;/li&gt;
&lt;li&gt;A file where salt is not the only actor, like &lt;code&gt;~/.ssh/authorized_keys&lt;/code&gt; or &lt;code&gt;/etc/hosts&lt;/code&gt;. Theses files may contain previous entries from humans and may get edited later by theses same people.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In most cases you have one simple solution for that, a lot of daemons and services allows for an directory-inclusion of configuration files, usually this means a directory &lt;code&gt;foo.d/&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;If you have a look at a debian system you have for example:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;/etc/mysql/conf.d&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/etc/apache2/conf.d&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/etc/apt/sources.list.d/&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/etc/cron.d/&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/etc/cron.daily/&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;(...)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;And this would let you use a &lt;code&gt;file.managed&lt;/code&gt; state to add your local configuration, without altering the package maintained files. Good thing.&lt;/p&gt;

&lt;p&gt;But still not covering all the needs, there is no &lt;code&gt;/etc/hosts.d/&lt;/code&gt; and no &lt;code&gt;/etc/postgresql/pg_hba.conf.d/&lt;/code&gt;. To edit the postgresql access file or your local hosts file you must work on the existing files.&lt;/p&gt;

&lt;p&gt;You need a way to edit some files, to replace some key values, &lt;strong&gt;while not managing the whole file&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;The file module has two tools for such needs:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://docs.saltstack.com/ref/states/all/salt.states.file.html#salt.states.file.replace&quot;&gt;&lt;code&gt;file.replace&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://docs.saltstack.com/ref/states/all/salt.states.file.html#salt.states.file.blockreplace&quot;&gt;&lt;code&gt;file.blockreplace&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The first one is a python based replacement for the old &lt;code&gt;file.sed&lt;/code&gt; function, it let you use some regex to find a content and replace it. But there's some drawbacks in its usage, at least on my point of view:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;MULTILINE regex are not supported, even if the documentation says it works, @see &lt;a href=&quot;https://github.com/saltstack/salt/issues/7999&quot;&gt;issue #7999&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;the file is altered at each salt run, errors may break it badly (empyt or partially empty), and access to the file whil salt is editing it should not happen (partial content), @see &lt;a href=&quot;https://github.com/saltstack/salt/issues/8051&quot;&gt;issue #8051&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;the MULTILINE regex issue was a big problem for us, because our first usage of unmanaged files edition was managing hosts files, with several lines added and &lt;em&gt;managed&lt;/em&gt;.
So we wanted to add a simple way to manage several lines in a file, without regex support (using replace for that), and we made it with blockreplace.&lt;/p&gt;

&lt;h2&gt;File.blockreplace&lt;/h2&gt;

&lt;p&gt;The main idea under &lt;strong&gt;blockreplace&lt;/strong&gt; is to &lt;strong&gt;manage blocks of edited contents&lt;/strong&gt; in files where everything outside of theses blocks is ignored by Salt-stack.&lt;/p&gt;

&lt;p&gt;With this module and/or state salt-stack can :&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Add&lt;/strong&gt; the block of content (on top or on bottom) if it is not present&lt;/li&gt;
&lt;li&gt;manage &lt;strong&gt;several lines&lt;/strong&gt; inside the block&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;remove&lt;/strong&gt; content from a block&lt;/li&gt;
&lt;li&gt;identify &lt;strong&gt;several different blocks&lt;/strong&gt; in the same file&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Block identity targeting and delimitation is done by a comment. By default it use a &lt;code&gt;bash&lt;/code&gt; type of comment with &lt;code&gt;#&lt;/code&gt; characters. But you can alter it, if your target is an html file you could use &lt;code&gt;&amp;lt;!-- --&amp;gt;&lt;/code&gt; comments, if it's a code file you could use &lt;code&gt;/* */&lt;/code&gt; comments, etc.&lt;/p&gt;

&lt;p&gt;If you need several blocks in the same file you will need a way to identify theses different blocks, so inside theses comments there should be a unique block identifier. The whole marker line is searched, so the whole marker is this unique identifier. But if you make several blocks from the same marker model you should maybe add inside a unique variation, this is why the &lt;a href=&quot;http://docs.saltstack.com/ref/states/all/salt.states.file.html#salt.states.file.blockreplace&quot;&gt;state documentation&lt;/a&gt; example show usage of a jinja &lt;code&gt;myvar&lt;/code&gt; variable present in the state id and in the block marker (imagine theses states running in a jinja for loop, with &lt;code&gt;myvar&lt;/code&gt; taking severa values.&lt;/p&gt;

&lt;p&gt;The module documentation shows an example of a managed block content in a file (the result):&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;(...)
# START managed zone 42 -DO-NOT-EDIT-
First line of content
text 2
text 3
text 4
# END managed zone 42 --
(...)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Here the block is delimited by the 'markers', the starting marker is &lt;code&gt;# START managed zone 42 -DO-NOT-EDIT-&lt;/code&gt; and the ending one is &lt;code&gt;# END managed zone 42 --&lt;/code&gt;. And the job of the state writer (you) is to keep theses markers unique in the file so that salt could indentify the block without any mistakes. Use long markers, short ones could work, of course, but with long markers you will avoid more easily the bad situation in which a part of your block content may contain the same thing as you end marker.&lt;/p&gt;

&lt;h2&gt;Step by step: Blockreplace real example with hosts&lt;/h2&gt;

&lt;p&gt;So now, to get a little deeper, we'll have a look at a real complete example. All theses examples are available in a github repository &lt;a href=&quot;https://github.com/regilero/regilero-blog-examples/tree/master/blockreplace-step-by-step&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Note that you can find other examples of usage &lt;a href=&quot;https://github.com/saltstack/salt/blob/develop/tests/unit/modules/file_test.py&quot;&gt;in the module unit test cases&lt;/a&gt;, search for &lt;code&gt;FileBlockReplaceTestCase&lt;/code&gt; class. And feel free to add your test cases (and issues) if you find something wrong.&lt;/p&gt;

&lt;p&gt;Back on our step by step, let's say I want to add some entries in a hosts file. In this example we'll say that the salt minion is building some services and knows several aliases for theses services (db.local.net, http.local.net, etc) that should be added on the hosts file, all targeting the 127.0.0.1 IP.&lt;/p&gt;

&lt;p&gt;The first step is to start with a very simple state, we will use it to see if at least salt can create the block in &lt;code&gt;/etc/hosts&lt;/code&gt;. This state is written in a &lt;code&gt;hostsedit1.sls&lt;/code&gt; file which should be on your salt states root directory (if it's not directly on the root, add &lt;code&gt;path.to.this.state.directory&lt;/code&gt; in the salt-call calls). Here is this state:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;test-etc-hosts-blockreplace-services:
  file.blockreplace:
    - name: /etc/hosts
    - marker_start: &quot;# BLOCK TOP : salt managed zone : local services : please do not edit&quot;
    - marker_end: &quot;# BLOCK BOTTOM : end of salt managed zone --&quot;
    - content: '# here be dragons'
    - show_changes: True
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Here you can see I used a full name for the &lt;strong&gt;state id&lt;/strong&gt; (1st line), and not just the file path, as using full descriptive and unique ids is a very good habit. And using the name shortcut as a state id is maybe more readable in examples but it can lead to states overwrites, bad things. So I won't do that.&lt;/p&gt;

&lt;p&gt;The content is a comment, it's a test. I did &lt;strong&gt;not&lt;/strong&gt; alter manually the &lt;code&gt;/etc/hosts&lt;/code&gt; file to add my markers inside.&lt;/p&gt;

&lt;p&gt;Let's run the test (and not a highstate, only this simple sls), run it with a user having write access on the targeted hosts file, like the root user:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#$: salt-call state.sls hostsedit1    
local:
----------
    State: - file
    Name:      /etc/hosts
    Function:  blockreplace
    Result:    False
    Comment:   An exception occurred in this state: Traceback (most recent call last):
  File &quot;/path/to/salt/state.py&quot;, line 1325, in call
    *cdata['args'], **cdata['kwargs'])
  File &quot;path/to/salt/states/file.py&quot;, line 1882, in blockreplace
    show_changes=show_changes)
  File &quot;path/to/salt/modules/file.py&quot;, line 1105, in blockreplace
    raise CommandExecutionError(&quot;Cannot edit marked block. Markers were not found in file.&quot;)
CommandExecutionError: Cannot edit marked block. Markers were not found in file.
    Changes:   

Summary
------------
Succeeded: 0
Failed:    1
------------
Total:     1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And if fails. Because the block is not found in the file. We need to tell salt that in this case the block should be added on top (&lt;code&gt;append_if_not_found&lt;/code&gt;) or on the bottom of the file (&lt;code&gt;prepend_if_not_found&lt;/code&gt;). You're maybe wondering why the state fails badly instead of creating the block by default. The reason is that you may have edited the marker (to add some variables) or you may have edited the file and remove an important thing (like the bottom marker), and you would not want the state to overwrite a part of your file or to duplicate the block. I prefer having exception when something bad happens, and no changes on the targeted file.
We need to add the append instruction, this is done in hostsedit2 (on this step by step I use different states, but you could edit the same state file)&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;test-etc-hosts-blockreplace-services:
  file.blockreplace:
    - name: /etc/hosts
    - marker_start: &quot;# BLOCK TOP : salt managed zone : local services : please do not edit&quot;
    - marker_end: &quot;# BLOCK BOTTOM : end of salt managed zone --&quot;
    - content: '# here be dragons'
    - show_changes: True
    - append_if_not_found: True
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Run it:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#$: salt-call state.sls hostsedit2
 local:
----------
    State: - file
    Name:      /etc/hosts
    Function:  blockreplace
        Result:    True
        Comment:   Changes were made
        Changes:   Invalid Changes data: --- 
+++ 
@@ -45,3 +45,6 @@
 192.168.1.52.3 toto3.foo.com
 192.168.1.52.4 toto4.foo.com
 192.168.1.52.5 toto5.foo.com
+# BLOCK TOP : salt managed zone : local services : please do not edit
+# here be dragons
+# BLOCK BOTTOM : end of salt managed zone --


Summary
------------
Succeeded: 1
Failed:    0
------------
Total:     1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The &lt;code&gt;Invalid Changes data&lt;/code&gt; is a known bug that should get fixed soon, is a false positive (changes should be a list of changes and not just the string I think, something like that), the changes are in fact OK. You can chek the hosts file, the block of text was added at the end of the file.&lt;/p&gt;

&lt;p&gt;And if you launch the state a second time you will see that no changes were detected, so the file is untouched.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;local:
----------
    State: - file
    Name:      /etc/hosts
    Function:  blockreplace
        Result:    True
        Comment:   No changes were made
        Changes:   
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Note that using an empty content argument would empty your block in /etc/hosts, while leaving in place the block markers comments.&lt;/p&gt;

&lt;p&gt;So now we'll add some more realistic content in the hosts file, some IP and DNS data. We'll do that in a &lt;code&gt;hostedit3.sls&lt;/code&gt; file:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;test-etc-hosts-blockreplace-services:
  file.blockreplace:
    - name: /etc/hosts
    - marker_start: &quot;# BLOCK TOP : salt managed zone : local services : please do not edit&quot;
    - marker_end: &quot;# BLOCK BOTTOM : end of salt managed zone --&quot; 
    - content: |
        127.0.0.1 db.local.net
        127.0.0.1 http.local.net
        127.0.0.1 foo bar foo.local.net bar.local.net
        127.0.0.1 foobar # with a comment
    - show_changes: True
    - append_if_not_found: True
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Look at the &lt;code&gt;|&lt;/code&gt; this is used for multiline input in yaml, with newlines preservation.
Spaces, as always in yaml, are very important, If I show the first spaces with &lt;code&gt;x&lt;/code&gt; you can see that you need 4 more spaces after this pipe:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;test-etc-hosts-blockreplace-services:
xxfile.blockreplace:
xxxx- name: /etc/hosts
xxxx- marker_start: &quot;# BLOCK TOP : salt managed zone : local services : please do not edit&quot;
xxxx- marker_end: &quot;# BLOCK BOTTOM : end of salt managed zone --&quot; 
xxxx- content: |
xxxxxxxx127.0.0.1 db.local.net
xxxxxxxx127.0.0.1 http.local.net
xxxxxxxx127.0.0.1 foo bar foo.local.net bar.local.net
xxxxxxxx127.0.0.1 foobar # with a comment
xxxx- show_changes: True
xxxx- append_if_not_found: True
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And run it:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#$: salt-call state.sls hostsedit3
 local:
----------
    State: - file
    Name:      /etc/hosts
    Function:  blockreplace
        Result:    True
        Comment:   Changes were made
        Changes:   Invalid Changes data: --- 
+++ 
@@ -46,5 +46,9 @@

 #-- end salt managed zoneend --
 # BLOCK TOP : salt managed zone : local services : please do not edit
-# here be dragons
+127.0.0.1 db.local.net
+127.0.0.1 http.local.net
+127.0.0.1 foo bar foo.local.net bar.local.net
+127.0.0.1 foobar # with a comment
+
 # BLOCK BOTTOM : end of salt managed zone --
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And we will end this first example by managing two different blocks in the same file.&lt;/p&gt;

&lt;p&gt;Let's say we will now manage two different blocks on the file, one with local services, and one with external services, this is &lt;code&gt;hostedit4.sls&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;test-etc-hosts-blockreplace-services-local:
  file.blockreplace:
    - name: /etc/hosts
    - marker_start: &quot;# BLOCK TOP : salt managed zone : local services : please do not edit&quot;
    - marker_end: &quot;# BLOCK BOTTOM : local : end of salt managed zone --&quot; 
    - content: |
        127.0.0.1 db.local.net
        127.0.0.1 http.local.net
        127.0.0.1 foo bar foo.local.net bar.local.net
        127.0.0.1 foobar # with a comment
    - show_changes: True
    - append_if_not_found: True

test-etc-hosts-blockreplace-services-central:
  file.blockreplace:
    - name: /etc/hosts
    - marker_start: &quot;# BLOCK TOP : salt managed zone : central services : please do not edit&quot;
    - marker_end: &quot;# BLOCK BOTTOM : central : end of salt managed zone --&quot; 
    - content: |
        8.8.8.8 ns1.dns.net
        8.8.4.4 ns2.dns.net
    - show_changes: True
    - append_if_not_found: True
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The states ids are altered with &lt;code&gt;-local&lt;/code&gt; and &lt;code&gt;-central&lt;/code&gt; and the second state uses a different marker message. If I had used the same marker messages the second would have overwritten the first one. You may also see that I have added a  &lt;code&gt;central&lt;/code&gt; and a  &lt;code&gt;local&lt;/code&gt; keyword on the &lt;code&gt;marker_end&lt;/code&gt; sections. This way end markers are also uniques, the states could work with non unique end marker, the block end is detected on the first match of the end marker. But with unique end markers you will detect more easily broken blocks.&lt;/p&gt;

&lt;p&gt;And if I do not alter the &lt;code&gt;/etc/hosts&lt;/code&gt; file before running theses states I should see an example of broken block, because I altered the end marker for the first block, and salt cannot find this end marker on the current file, let's test it (let's be mad):&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#$: salt-call state.sls hostsedit4
local:
----------
    State: - file
    Name:      /etc/hosts
    Function:  blockreplace
        Result:    False
        Comment:   An exception occurred in this state: Traceback (most recent call last):
  File &quot;/path/to/salt/state.py&quot;, line 1325, in call
    *cdata['args'], **cdata['kwargs'])
  File &quot;/path/to/salt/states/file.py&quot;, line 1882, in blockreplace
    show_changes=show_changes)
  File &quot;/path/to/salt/modules/file.py&quot;, line 1095, in blockreplace
    raise CommandExecutionError(&quot;Unterminated marked block. End of file reached before marker_end.&quot;)
CommandExecutionError: Unterminated marked block. End of file reached before marker_end.

 Changes:   
----------
    State: - file
    Name:      /etc/hosts
    Function:  blockreplace
        Result:    True
        Comment:   Changes were made
        Changes:   Invalid Changes data: --- 
+++ 
@@ -52,3 +52,6 @@
 127.0.0.1 foobar # with a comment

 # BLOCK BOTTOM : end of salt managed zone --
    +# BLOCK TOP : salt managed zone : central services : please do not edit
+8.8.8.8 ns1.dns.net
8.8.4.4 ns2.dns.net

+# BLOCK BOTTOM : central : end of salt managed zone --


Summary
------------
Succeeded: 1
Failed:    1
------------
Total:     2
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Perfect, the second block was added and salt detected that the first state's block was now invalid &lt;code&gt;Unterminated marked block. End of file reached before marker_end&lt;/code&gt;. The block was not removed from the hosts file, simply salt is now unable to manage it.&lt;/p&gt;

&lt;p&gt;The fix here is either:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;to edit the /etc/hosts and replace the marker end comment of the first block from &lt;code&gt;# BLOCK BOTTOM : end of salt managed zone --&lt;/code&gt; to &lt;code&gt;# BLOCK BOTTOM : local : end of salt managed zone --&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;to do the contrary in the state, let the first block end on the &lt;code&gt;# BLOCK BOTTOM : end of salt managed zone --&lt;/code&gt; marker.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;You can test it, You'll get two working salt states, both editing the same hosts file and managing two different sections of the file.&lt;/p&gt;

&lt;h2&gt;Next?&lt;/h2&gt;

&lt;p&gt;On a future post we will have a look at &lt;a href=&quot;http://docs.saltstack.com/ref/states/all/salt.states.file.html#salt.states.file.accumulated&quot;&gt;&lt;code&gt;file.accumulated&lt;/code&gt;&lt;/a&gt; examples with managed files, and also with blockreplace. As accumulated data can be used to collect data on several states, which makes this sort of tools very useful in combination with edited blocks managments.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://twitter.com/regilero&quot;&gt;Stay tuned on twitter, @regilero&lt;/a&gt;, &lt;a href=&quot;https://twitter.com/makinacorpus&quot;&gt;@makinacorpus&lt;/a&gt;&lt;/p&gt;
</description>
				<published>2014-01-20 00:00:00 +0100</published>
				<link>http://regilero.github.io/SaltStack/English/2014/01/20/saltstack_step_by_step_file_blockreplace/</link>
			</item>
		
			<item>
				<title>Warning Chrooted php-fpm and Apc with multiple pools</title>
				<description>&lt;p&gt;PHP-fpm used as a fastgi backend for nginx or Apache is a very nice tool.&lt;br/&gt;
And the ability to chroot the php-fpm pool use a nice way to enforce projects separations.
I once wrote a detailled exemple for Apache (but I really prefer nginx),
with details on &lt;code&gt;open_basedir&lt;/code&gt; and temporary files
separation for each PHP project.&lt;br/&gt;
You should really use your PHP projets in such way to avoid having the least secure project
on your host used to attack other projects.&lt;/p&gt;

&lt;p&gt;But recently I discovered that using several projects on the same host, all using &lt;strong&gt;APC&lt;/strong&gt; opcode and &lt;strong&gt;php-fpm chroot&lt;/strong&gt; I ended up
with sources files from one project used on the others.. source code &lt;strong&gt;mix&lt;/strong&gt; .. and then really bad things happened...&lt;/p&gt;

&lt;h2&gt;WTF: Why are the conf files mixed between projects?&lt;/h2&gt;

&lt;p&gt;At first we were working with one php-fpm per host. On configurations where you have several hosts for the same project this
happens more than sharing one host for several projects.&lt;/p&gt;

&lt;p&gt;Then one day on some of theses hosts we deployed a clone of the project. On a different directory, with a second php-fpm pool,
where the only difference between the 2 projects were the &lt;code&gt;prefix&lt;/code&gt; in the php-fpm pool and the project's application settings
(where at least the base url name and database backend were different).&lt;/p&gt;

&lt;p&gt;This should be OK, and without APC it was OK. But as soon as APC were used some pages were randomly broken, using domain of
the first project for css files of the second project, or showing pages of second project in the fist one, a big random mess.
In our case the random thing was done by the fact several hosts were load balanced between several hosts and did not used the
same buggy files on each hosts.&lt;/p&gt;

&lt;p&gt;The problem is easy (well, it took me long minutes to find it the fist time),
APC is storing a compiled version of each file in his opcode cache, and
&lt;strong&gt;the cache key of this file is  the file name (full path)&lt;/strong&gt;.&lt;br/&gt;
If two chrooted projects &lt;strong&gt;share the same file names, only one version of this file is stored in APC!&lt;/strong&gt;&lt;br/&gt;
Without the chroot this never happens on a regular filesystem. But, by definition, using
a chroot your projects are using a shorter relative path to files, seing it as the real full path.&lt;/p&gt;

&lt;p&gt;So chances are that the configuration files on two projects where one is the production version and one the
test version will both be seen as (this is a Drupal setting for example):&lt;/p&gt;

&lt;pre&gt;
  /www/sites/default/settings.php
&lt;/pre&gt;


&lt;p&gt;Whereas the real filesystem paths are:&lt;/p&gt;

&lt;pre&gt;
  /var/www/app/production/www/sites/default/settings.php
  /var/www/app/test/www/sites/default/settings.php
&lt;/pre&gt;


&lt;p&gt;As of course the chroots are &lt;code&gt;var/www/app/production&lt;/code&gt; and &lt;code&gt;/var/www/app/test&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Quite easy te see on projects where key files like configuration files gets the same name.&lt;br/&gt;
But it could also happen with several projects having a lot of differences in file naming,
and where just one or two file names would conflict. It would make the bug harder to detect.&lt;/p&gt;

&lt;h2&gt;Solutions? one process per pool?&lt;/h2&gt;

&lt;p&gt;There is of course one solution for this problem which is either:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;to remove APC&lt;/li&gt;
&lt;li&gt;or only use one php-fpm pool per host&lt;/li&gt;
&lt;li&gt;or only use one php-fpm pool per php-fpm process, and run &lt;strong&gt;several php-fpm daemons&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So when you want to have 2, 3 or more projects on one host, all using APC and a chrooted php-fpm pools you will duplicate the
php-fpm daemon for each project to ensure each pool is really independent of the other pools, and that a new APC, with a new shared
memory segment will be used on this new PHP daemon. You cannot use the default classical way with one daemon and several pools on this daemon.&lt;/p&gt;

&lt;p&gt;You can find examples of this. &lt;strong&gt;But&lt;/strong&gt; the process is not a simple a simply creating a new daemon with a new
configuration file. On debian, for example, the start/stop init script will likely kill all the php-fpm process running
on the Hosts, ignoring the fact they are from several different daemons.&lt;/p&gt;

&lt;p&gt;So let's study it in details&lt;/p&gt;

&lt;h3&gt;Duplicate the php-fpm daemon process&lt;/h3&gt;

&lt;p&gt;The first thing to do is to create a new php-fpm configuration for the new php-fpm process. The first process/daemon will be &lt;strong&gt;php-fpm&lt;/strong&gt;,
we will call the second &lt;strong&gt;php-fpm-test&lt;/strong&gt;. So this new conf file will also have the &lt;strong&gt;-test&lt;/strong&gt; extension.&lt;/p&gt;

&lt;p&gt;Usually, at least on debian, the main configuration file is loading all pools from the pool diectory with
this instruction:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;php&quot;&gt;&lt;span class=&quot;x&quot;&gt;include=/etc/php5/fpm/pool.d/*.conf&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;We alter the configuration file to only include one pool. Then we make the copy and alter this name in the second file,
we also alter the pid setting reference.&lt;br/&gt;
After that a diff should give something like that:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;diff -bBNaur /etc/php5/fpm/php-fpm.conf /etc/php5/fpm/php-fpm-test.conf
--- /etc/php5/fpm/php-fpm.conf  2013-04-10 16:48:23.000000000 +0200
+++ /etc/php5/fpm/php-fpm-test.conf  2013-04-10 18:34:12.000000000 +0200
@@ -22,7 +22,7 @@
 ; Pid file
 ; Note: the default prefix is /var
 ; Default Value: none
-pid &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; /var/run/php5-fpm.pid
+pid &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; /var/run/php5-fpm-test.pid
 
 ; Error log file
 ; If it&lt;span class=&quot;err&quot;&gt;&amp;#39;&lt;/span&gt;s &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;to &lt;span class=&quot;s2&quot;&gt;&amp;quot;syslog&amp;quot;&lt;/span&gt;, log is sent to syslogd instead of being written
@@ -118,5 +118,5 @@
 
 ; To configure the pools it is recommended to have one .conf file per
 ; pool in the following directory:
-include&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/etc/php5/fpm/pool.d/my-pool.conf
+include&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/etc/php5/fpm/pool.d/my-pool-test.conf
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Now we need an init script starting a new php-fpm daemon using this &lt;code&gt;php-fpm-test.conf&lt;/code&gt; file.&lt;br/&gt;
Copy the main startup script on a new one with test extension and alter it so that at least you obtain this diff:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;diff -bBNaur /etc/init.d/php5-fpm /etc/init.d/php5-fpm-test
--- /etc/init.d/php5-fpm  2012-07-23 13:59:30.000000000 +0200
+++ /etc/init.d/php5-fpm-test  2013-04-10 18:56:22.000000000 +0200
@@ -1,24 +1,24 @@
 &lt;span class=&quot;c&quot;&gt;#!/bin/sh&lt;/span&gt;
 &lt;span class=&quot;c&quot;&gt;### BEGIN INIT INFO&lt;/span&gt;
-# Provides:          php-fpm php5-fpm
+# Provides:          php-fpm-test php5-fpm-test
 &lt;span class=&quot;c&quot;&gt;# Required-Start:    $remote_fs $network&lt;/span&gt;
 &lt;span class=&quot;c&quot;&gt;# Required-Stop:     $remote_fs $network&lt;/span&gt;
 &lt;span class=&quot;c&quot;&gt;# Default-Start:     2 3 4 5&lt;/span&gt;
 &lt;span class=&quot;c&quot;&gt;# Default-Stop:      0 1 6 &lt;/span&gt;
-# Short-Description: starts php5-fpm
-# Description:       Starts PHP5 FastCGI Process Manager Daemon
+# Short-Description: starts php5-fpm-test
+# Description:       Starts PHP5 FastCGI Process Manager Daemon &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;test&lt;/span&gt;
 &lt;span class=&quot;c&quot;&gt;### END INIT INFO&lt;/span&gt;
 
 &lt;span class=&quot;c&quot;&gt;# Author: Ondrej Sury &amp;lt;ondrej@debian.org&amp;gt;&lt;/span&gt;
 
 &lt;span class=&quot;nv&quot;&gt;PATH&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/sbin:/usr/sbin:/bin:/usr/bin
 &lt;span class=&quot;nv&quot;&gt;DESC&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;PHP5 FastCGI Process Manager&amp;quot;&lt;/span&gt;
 &lt;span class=&quot;nv&quot;&gt;NAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;php5-fpm
 &lt;span class=&quot;nv&quot;&gt;DAEMON&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/sbin/&lt;span class=&quot;nv&quot;&gt;$NAME&lt;/span&gt;
-DAEMON_ARGS&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;--fpm-config /etc/php5/fpm/php-fpm.conf&amp;quot;&lt;/span&gt;
-PIDFILE&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/var/run/php5-fpm.pid
+DAEMON_ARGS&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;--fpm-config /etc/php5/fpm/php-fpm-test.conf&amp;quot;&lt;/span&gt;
+PIDFILE&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/var/run/php5-fpm-test.pid
 &lt;span class=&quot;nv&quot;&gt;TIMEOUT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;30
-SCRIPTNAME&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/etc/init.d/&lt;span class=&quot;nv&quot;&gt;$NAME&lt;/span&gt;
+SCRIPTNAME&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/etc/init.d/&lt;span class=&quot;nv&quot;&gt;$NAME&lt;/span&gt;-test
 
 &lt;span class=&quot;c&quot;&gt;# Exit if the package is not installed&lt;/span&gt;
 &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; -x &lt;span class=&quot;s2&quot;&gt;&amp;quot;$DAEMON&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;exit &lt;/span&gt;0
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Do not forget to add this script on start/stop levels if you want it after reboot.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt;  update-rc.d default php5-fpm-test defaults
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Start this new php-fpm, it should be ok.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt; /etc/init.d/php5-fpm-test start
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Test it with this  &lt;code&gt;ps&lt;/code&gt; command, you sholuld see the two daemons and the children, one pool per daemon
(number of children depends on your pool's settings):&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt; ps auxf|grep php
 
 1005     30688  0.0  0.0   9616   904 pts/0    S+   13:47   0:00              &lt;span class=&quot;se&quot;&gt;\_&lt;/span&gt; grep php
 root     17906  0.0  0.1 667208  5236 ?        Ss   May07   0:13 php-fpm: master process &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;/etc/php5/fpm/php-fpm-test.conf&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
 1005      9753  0.0  3.0 733316 122300 ?       S    04:13   0:06  &lt;span class=&quot;se&quot;&gt;\_&lt;/span&gt; php-fpm: pool my-pool-test
 1005      9754  0.0  1.9 691336 81188 ?        S    04:13   0:04  &lt;span class=&quot;se&quot;&gt;\_&lt;/span&gt; php-fpm: pool my-pool-test
 1005     17920  0.0  3.0 733316 123152 ?       S    05:41   0:05  &lt;span class=&quot;se&quot;&gt;\_&lt;/span&gt; php-fpm: pool my-pool-test                                     
 root     19130  0.0  0.1 667908  5940 ?        Ss   May07   0:14 php-fpm: master process &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;/etc/php5/fpm/php-fpm.conf&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
 1005     10731  0.1  2.7 699296 110940 ?       S    May14   1:30  &lt;span class=&quot;se&quot;&gt;\_&lt;/span&gt; php-fpm: pool my-pool
 1005     10816  0.1  2.4 688676 99048 ?        S    May14   1:35  &lt;span class=&quot;se&quot;&gt;\_&lt;/span&gt; php-fpm: pool my-pool
 1005     10817  0.1  2.5 694604 104196 ?       S    May14   1:18  &lt;span class=&quot;se&quot;&gt;\_&lt;/span&gt; php-fpm: pool my-pool
 1005     10912  0.1  2.6 696708 108364 ?       S    May14   1:27  &lt;span class=&quot;se&quot;&gt;\_&lt;/span&gt; php-fpm: pool my-pool
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;Watch the nice crash on start/stop&lt;/h3&gt;

&lt;p&gt;It's not the end!&lt;/p&gt;

&lt;p&gt;If you try to stop one of the 2 daemons you will have a long running stop, and then after 30s the 2 daemons will be down.&lt;br/&gt;
Redo the ps to see it.&lt;/p&gt;

&lt;p&gt;Problem is coming fom the &lt;code&gt;do_stop&lt;/code&gt; function in the init script:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt;&lt;span class=&quot;c&quot;&gt;#&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# Function that stops the daemon/service&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#&lt;/span&gt;
do_stop&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;c&quot;&gt;# Return&lt;/span&gt;
  &lt;span class=&quot;c&quot;&gt;#   0 if daemon has been stopped&lt;/span&gt;
  &lt;span class=&quot;c&quot;&gt;#   1 if daemon was already stopped&lt;/span&gt;
  &lt;span class=&quot;c&quot;&gt;#   2 if daemon could not be stopped&lt;/span&gt;
  &lt;span class=&quot;c&quot;&gt;#   other if a failure occurred&lt;/span&gt;
  start-stop-daemon --stop --quiet --retry&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;QUIT/&lt;span class=&quot;nv&quot;&gt;$TIMEOUT&lt;/span&gt;/TERM/5/KILL/5 --pidfile &lt;span class=&quot;nv&quot;&gt;$PIDFILE&lt;/span&gt; --name &lt;span class=&quot;nv&quot;&gt;$NAME&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;RETVAL&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;$?&amp;quot;&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;$RETVAL&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 2 &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return &lt;/span&gt;2
  &lt;span class=&quot;c&quot;&gt;# Wait for children to finish too if this is a daemon that forks&lt;/span&gt;
  &lt;span class=&quot;c&quot;&gt;# and if the daemon is only ever run from this initscript.&lt;/span&gt;
  &lt;span class=&quot;c&quot;&gt;# If the above conditions are not satisfied then add some other code&lt;/span&gt;
  &lt;span class=&quot;c&quot;&gt;# that waits for the process to drop all resources that could be&lt;/span&gt;
  &lt;span class=&quot;c&quot;&gt;# needed by services started subsequently.  A last resort is to&lt;/span&gt;
  &lt;span class=&quot;c&quot;&gt;# sleep for some time.&lt;/span&gt;
  start-stop-daemon --stop --quiet --oknodo --retry&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0/30/TERM/5/KILL/5 --exec &lt;span class=&quot;nv&quot;&gt;$DAEMON&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;$?&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 2 &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return &lt;/span&gt;2
  &lt;span class=&quot;c&quot;&gt;# Many daemons don&amp;#39;t delete their pidfiles when they exit.&lt;/span&gt;
  rm -f &lt;span class=&quot;nv&quot;&gt;$PIDFILE&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;$RETVAL&amp;quot;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The &lt;code&gt;start-stop-daemon&lt;/code&gt; command is a first stop on the right daemon, based on the pid.
But after that a second stop is running, ensuring no ghost
child stay alive, and this second &lt;code&gt;start-stop-daemon&lt;/code&gt; command is running with option &lt;code&gt;--exec&lt;/code&gt; :&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;−x, −−exec executable&lt;/p&gt;

&lt;p&gt;Check for processes that are instances of this executable (according to /proc/pid/exe).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Let's see whet is this &lt;code&gt;/proc/pid/exe&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;cat /var/run/php5-fpm.pid 
1246
&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;ls -alh /proc/1246/exe
lrwxrwxrwx 1 root root 0 15 mai   13:30 /proc/1246/exe -&amp;gt; /usr/sbin/php5-fpm
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;So this second stop is waiting for &lt;strong&gt;any&lt;/strong&gt; process whose executable is &lt;code&gt;/usr/sbin/php5-fpm&lt;/code&gt;,
and if it do not stop after 30 seconds, a SIGTERM and then a SIGKILL is launched.&lt;br/&gt;
When stopping the php-fpm-test version every other parallel php-daemon running will finally get killed.
Same for the first daemon.&lt;/p&gt;

&lt;p&gt;That's not very nice.&lt;/p&gt;

&lt;h3&gt;Fix the stop/killal problems&lt;/h3&gt;

&lt;p&gt;First step, indicate a different binary in &lt;strong&gt;/etc/init.d/php5-fpm-test&lt;/strong&gt;:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt;-NAME&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;php5-fpm
+NAME&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;php5-fpm-test
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Then this binary should exists, doing a symbolic link from php5-fpm-test to php5-fpm will not fool
the  &lt;code&gt;/proc/pid/exe&lt;/code&gt; link. So one ugly solution is to make a real copy of the binary:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt;cp /usr/sbin/php5-fpm /usr/sbin/php5-fpm-test
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;One caveat: when upgrading php5-fpm package you will have to redo this manual copy of the binary.&lt;/p&gt;

&lt;p&gt;One other solution is to comment the second start-stop-daemon line, but you'll get a less robust stop script.&lt;/p&gt;

&lt;p&gt;If you can think of a third solution send me an email.&lt;/p&gt;
</description>
				<published>2013-05-16 00:00:00 +0200</published>
				<link>http://regilero.github.io/Drupal/English/2013/05/16/Warning_chrooted_php_fpm_and_apc/</link>
			</item>
		
			<item>
				<title>Drupal - Mongodb statistics module published</title>
				<description>&lt;h3&gt;What is this about?&lt;/h3&gt;

&lt;p&gt;Just a few words, as I've other some things to do.&lt;/p&gt;

&lt;p&gt;I've just published a development version of &lt;a href=&quot;http://github.com/regilero/drupal_mongodb_statistics&quot;&gt;mongodb-statistics&lt;/a&gt; on github.&lt;/p&gt;

&lt;p&gt;This module is a first try on replacing heavy MySQL operations done by the core statistics module.&lt;/p&gt;

&lt;p&gt;It's copy-and-alter of the core statistics module, with some additions.
So it's not the nicest piece of code I could write :-)&lt;/p&gt;

&lt;p&gt;On the things added :&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;batch migration of previous node_counter statistics if any (not yet for accesslog)&lt;/li&gt;
&lt;li&gt;post-synchronisation of node_counter mongodb table to a sql table (via cron), so that you could query it via views (not for accesslog, are you mad?)&lt;/li&gt;
&lt;li&gt;time based caching of the popular content block&lt;/li&gt;
&lt;li&gt;Still lot of thing to do (see the &lt;a href=&quot;https://github.com/regilero/drupal_mongodb_statistics/blob/master/mongodb_statistics/TODO.txt&quot;&gt;TODO&lt;/a&gt;) but it was a nice way to learn &lt;strong&gt;mongodb&lt;/strong&gt;. I especially like the idea of &lt;a href=&quot;http://nosql.mypopescu.com/post/392418792/translate-sql-to-mongodb-mapreduce&quot;&gt;mapReduce&lt;/a&gt; functions applied for complex &lt;code&gt;GROUP BY&lt;/code&gt; equivalents.&lt;/li&gt;
&lt;/ul&gt;

</description>
				<published>2011-10-18 00:00:00 +0200</published>
				<link>http://regilero.github.io/Drupal/English/2011/10/18/drupal_mongodb_statistics_module_published/</link>
			</item>
		
			<item>
				<title>Separate cache Backends with Drupal6 and Drupal7.</title>
				<description>&lt;p&gt;Drupal use a lot of caches at different levels but all of them are by default stored in the database.&lt;/p&gt;

&lt;p&gt;In this article we'll study how to push all these caches in better places.&lt;/p&gt;

&lt;p&gt;Thi is a new feature of default Drupal7, but simple solutions are available if you want the same thing on a Drupal6 installation.&lt;/p&gt;

&lt;h3&gt;The default situation&lt;/h3&gt;

&lt;p&gt;Take your Drupal Database and check what are the cache tables used, here I'll use a quite basic default Drupal installation on Drupal6:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;sql&quot;&gt;&lt;span class=&quot;n&quot;&gt;mysql&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;show&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tables&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;like&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;cache%&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;---------------------------+&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Tables_in_expat6&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;cache&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;%&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;---------------------------+&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;cache&lt;/span&gt;                     &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cache_block&lt;/span&gt;               &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cache_content&lt;/span&gt;             &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cache_filter&lt;/span&gt;              &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cache_form&lt;/span&gt;                &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cache_menu&lt;/span&gt;                &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cache_page&lt;/span&gt;                &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cache_update&lt;/span&gt;              &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cache_views&lt;/span&gt;               &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cache_views_data&lt;/span&gt;          &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cache_admin_menu&lt;/span&gt;          &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;---------------------------+&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Let's try to get more informations on theses tables with a query on the INFORMATION_SCHEMA of MySQL, here a database named mydrupal&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;sql&quot;&gt;&lt;span class=&quot;n&quot;&gt;mysql&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; 
    &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;concat&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;table_schema&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;.&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;table_name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dbtable&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;concat&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;round&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;table_rows&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;K&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;rows&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;concat&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;round&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;data_length&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;M&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;DATA&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;concat&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;round&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;index_length&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;M&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;indexes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;concat&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;round&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;data_length&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;index_length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;M&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;total_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;round&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;index_length&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;data_length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;idxfrac&lt;/span&gt; 
    &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;  &lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;information_schema&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;TABLES&lt;/span&gt; 
    &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;  &lt;span class=&quot;k&quot;&gt;WHERE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;table_name&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;LIKE&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;cache%&amp;#39;&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;  &lt;span class=&quot;k&quot;&gt;AND&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;table_schema&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;&amp;quot;mydrupal&amp;quot;&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;  &lt;span class=&quot;k&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;BY&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;data_length&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;index_length&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;DESC&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;---------------------------+-------+-------+---------+------------+---------+&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dbtable&lt;/span&gt;                   &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;rows&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;DATA&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;indexes&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;total_size&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;idxfrac&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;---------------------------+-------+-------+---------+------------+---------+&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mydrupal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cache_menu&lt;/span&gt;       &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;02&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;19&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;M&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;06&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;M&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;26&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;M&lt;/span&gt;      &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;    &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;01&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; 
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mydrupal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cache_form&lt;/span&gt;       &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;01&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;99&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;M&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;01&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;M&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;M&lt;/span&gt;      &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;    &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; 
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mydrupal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cache_update&lt;/span&gt;     &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;86&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;M&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;01&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;M&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;86&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;M&lt;/span&gt;      &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;    &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;01&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; 
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mydrupal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cache_filter&lt;/span&gt;     &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;22&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;49&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;M&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;03&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;M&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;52&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;M&lt;/span&gt;      &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;    &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;06&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; 
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mydrupal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;cache&lt;/span&gt;            &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;01&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;46&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;M&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;01&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;M&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;46&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;M&lt;/span&gt;      &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;    &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;01&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; 
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mydrupal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cache_content&lt;/span&gt;    &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;17&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;35&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;M&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;01&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;M&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;36&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;M&lt;/span&gt;      &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;    &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;03&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; 
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mydrupal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cache_views&lt;/span&gt;      &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;01&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;23&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;M&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;01&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;M&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;23&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;M&lt;/span&gt;      &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;    &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;03&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; 
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mydrupal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cache_admin_menu&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;M&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;01&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;M&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;01&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;M&lt;/span&gt;      &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;   &lt;span class=&quot;mi&quot;&gt;96&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; 
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mydrupal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cache_page&lt;/span&gt;       &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;M&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;M&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;M&lt;/span&gt;      &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;    &lt;span class=&quot;k&quot;&gt;NULL&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; 
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mydrupal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cache_views_data&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;M&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;M&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;M&lt;/span&gt;      &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;    &lt;span class=&quot;k&quot;&gt;NULL&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; 
&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mydrupal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cache_block&lt;/span&gt;      &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;M&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;M&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;M&lt;/span&gt;      &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;    &lt;span class=&quot;k&quot;&gt;NULL&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; 
&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;c1&quot;&gt;---------------------------+-------+-------+---------+------------+---------+&lt;/span&gt;
&lt;span class=&quot;mi&quot;&gt;11&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;rows&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;00&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;So, well, here my example is a quite little website. Cache tables are small and not heavily used.
You would get bigger numbers on a big website.
But anyway, the real problem in term of performance here is not on the size of
caches or the size of the indexes, but on the number of read and write queries
running on theses tables.&lt;/p&gt;

&lt;p&gt;When the website will grow you will need to activate more internal caching,
maybe you will use good modules, which make their own cache tables and use them
&amp;amp; the existing ones to avoid recomputing all answers.
You may even use so much the cache that some queries on the website will be answered
by only requesting the cache table (aggressive cache mode with cache_page).&lt;/p&gt;

&lt;p&gt;Soon enough you will ask yourself &quot;Could I use some smarter solutions like Memcache for the cache storage?&quot;.&lt;/p&gt;

&lt;p&gt;And of course some existing modules could help you doing that.
The memcache module, for example.
And the &quot;cache router&quot; module applied some of the ideas we'll study later on this article.&lt;/p&gt;

&lt;p&gt;You may wonder why it is smart to use something which is not the database to perform the caching storage?&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;You could maybe avoid completely the database requests in aggressive mode&lt;/li&gt;
&lt;li&gt;Dedicated storage engine (cache engines) perform faster than a relational database both in write and read operations&lt;/li&gt;
&lt;li&gt;Reducing the number of requests made on MySQL is very important with Drupal, where a single page can be between 50 and 250 requests. With core modules only, adding Panels, some views and some other modules and you could grow up to 600 requests.&lt;/li&gt;
&lt;li&gt;data not managed in MySQl will never impact MySQL memory buffers management (smallest database will have more chances to avoid pagination)&lt;/li&gt;
&lt;li&gt;In some circumstances cache tables can get a lot of write operations and the query_cache for queries on theses tables will be wiped out frequently, which is bad for the query cache ratio and usage. But this is not always true, depends a lot on your Drupal cache usages&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I said before cache engines can be faster in both write and read operations.
So now you may ask &quot;why don't we use Cache engines for everything?&quot;. And the answer is that a relational database provides more services, it can for example provides a better persitency,
or manage better simultaneous writes, or allow handling relationship between objects.
&lt;strong&gt;Use the right tool for the right thing&lt;/strong&gt;.
But this is still a good question. Drupal 8 studies &amp;amp; discussions are actually requesting whether a document based backend for most Drupal storage wouldn't be  more appropriate than a relational database.
For now we'll just have a look at the cache tables problems.&lt;/p&gt;

&lt;h3&gt;Cache backends with Drupal7&lt;/h3&gt;

&lt;p&gt;Now comes Drupal7. The cache management has been rewritten, using cache router and memcached ideas and try to put the things one step further in the core.
Cache bins are used, for example the bin &lt;strong&gt;'foo'&lt;/strong&gt; will use the cache table &lt;strong&gt;cache_foo&lt;/strong&gt;.
And &lt;strong&gt;for each bin you can specify which storage backend will be used&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;Available cache backends are:&lt;/p&gt;
 * Database: the default one, like before
 * File (module filecache): a file-based storage which could be useful with fast disk storage (and a shared disk storage if you have several apache servers)
 * Apc (module apc): APC is not only an opcode (PHP code precompiler) it also  provides a local cache of shared memory. If you have several Apache servers you will have one APC cache per server, but it's not a big one, be careful (and part of the available memory space is occupied by the opcode). In case of full cache (overflow) the cache is completely wiped out, so do not use that for long persistency.
 * Memcache (module memcache): To use the well known memcached daemon. where you could use a basic mono-server setting or a complex multi-servers with replications usage&lt;/p&gt;

&lt;p&gt;But other backends could be written.
And you can already find two Redis backends implementations (&lt;strong&gt;Predis&lt;/strong&gt; &amp;amp; &lt;strong&gt;PhpRedis&lt;/strong&gt;) with the  &lt;a href=&quot;http://drupal.org/project/redis&quot;&gt;redis module&lt;/a&gt; (alpha).
Module maintained by &lt;strong&gt;pounard&lt;/strong&gt;, a Makina Corpus worker.
There is also a &lt;a href=&quot;http://drupal.org/project/mongodb&quot;&gt;MongoDB module&lt;/a&gt; providing a mongodb cache backend (beta2), that I did not test yet, powered by Damien Tournoud.&lt;/p&gt;

&lt;h3&gt;Having a drupal6? Or do you want some configuration details?&lt;/h3&gt;

&lt;p&gt;The only thing we need know is a documentation on how to configure these.
This is always (almost) provided in the module documentation but we will use the &lt;a href=&quot;http://drupal.org/project/cache_backport&quot;&gt;cache backport module&lt;/a&gt; documentation as an example.
This module, again maintained by  &lt;strong&gt;pounard&lt;/strong&gt;, is a backport of Drupal7 cache engine (separating  backends) for Drupal6.
So it's a replacement for Cache Router where you can reuse the cache parts of Drupal7 cache backends in a Drupal6 website.
And One of the good points of this module is that it provides a centralized documentation on several cache backends which is spread on the different modules for Drupal7.&lt;/p&gt;

&lt;p&gt;The first question is &quot;where should I put each separate cache bin (or each cache table for short) ?&quot;&lt;/p&gt;

&lt;p&gt;The &lt;strong&gt;cache&lt;/strong&gt; and &lt;strong&gt;cache_bootstrap&lt;/strong&gt; bins contains short and often used data.
They will love the APC cache backend.&lt;/p&gt;

&lt;p&gt;For all the others bins you could apply a different policy.
You may want to keep some bins in the database, but you should test the memcached/mongodb backend for most bins.
You could also try the filecache backend, with a modern linux kernel often used files will get mapped into memory buffers and you may get good results.&lt;/p&gt;

&lt;p&gt;There is no magic rules, the best tool will depend on your cache usage and on used modules.
MySQL is already working a lot, moving all caches outside of the  database will help MySQL.
But you will need to allow some memory (server?) for these new backends, maybe some of the memory given previously to MySQl or Apache.
Keep in mind that you should never make a server swap.&lt;/p&gt;

&lt;p&gt;Let's look at a complete configuration, for Drupal6 the cache backport module would require these lines:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;php&quot;&gt;&lt;span class=&quot;x&quot;&gt;  // Load the cache backport replacement for cache.inc:&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  $conf[&amp;#39;cache_inc&amp;#39;] = &amp;#39;sites/all/modules/cache_backport/cache.inc&amp;#39;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;And now for Drupal7 or Drupal6 we would have (of course it depends of the bins available on your installation, check the table created in MySQL to see what bin are requested by the modules):&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;php&quot;&gt;&lt;span class=&quot;x&quot;&gt;  // Define cache engines:&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // Database : &amp;#39;DrupalDatabaseCache&amp;#39;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  $conf[&amp;#39;cache_backends&amp;#39;][] = &amp;#39;sites/all/modules/cache_backport/database.inc&amp;#39;;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // FileCache : &amp;#39;DrupalFileCache&amp;#39;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  $conf[&amp;#39;cache_backends&amp;#39;][] = &amp;#39;sites/all/modules/filecache/filecache.inc&amp;#39;;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // APC : &amp;#39;DrupalAPCCache&amp;#39;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  $conf[&amp;#39;cache_backends&amp;#39;][] = &amp;#39;sites/all/modules/apc/drupal_apc_cache.inc&amp;#39;;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // Memcache from drupal 7 : &amp;#39;MemCacheDrupal&amp;#39;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  $conf[&amp;#39;cache_backends&amp;#39;][] = &amp;#39;sites/all/modules/memcache/memcache.inc&amp;#39;;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  &lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // Define cache bins, here&amp;#39;s the magic, deporting several cache on the&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // appropriate place depending on usage frequency, size, and others:&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // Please consider seriously doing brainstorming and benchmarking on your own&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // since this is only an example, and sites performance may vary depending&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // on modules and usage.&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // Cache name |  Usage/frequency/size&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // default    |  any/any/any          select memcache, apc, file or db&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  $conf[&amp;#39;cache_default_class&amp;#39;]          = &amp;#39;DrupalDatabaseCache&amp;#39;;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // WARNING: this one is &amp;#39;cache_class_cache&amp;#39; and not &amp;#39;cache_class_cache_cache&amp;#39;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // general    |  all/every/medium     select memcache &amp;gt; file &amp;gt; apc &amp;gt; db&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  $conf[&amp;#39;cache_class_cache&amp;#39;]            = &amp;#39;MemCacheDrupal&amp;#39;;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // bootstrap  |  all/every/medium     select apc &amp;gt; db&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  $conf[&amp;#39;cache_class_cache_bootstrap&amp;#39;]  = &amp;#39;DrupalAPCCache&amp;#39;;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // block      |  any/often/small      select memcache &amp;gt; db &amp;gt; file&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  $conf[&amp;#39;cache_class_cache_block&amp;#39;]      = &amp;#39;MemCacheDrupal&amp;#39;;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // field      |  page/some/large      select file &amp;gt; memcache &amp;gt; db&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  $conf[&amp;#39;cache_class_cache_content&amp;#39;]    = &amp;#39;DrupalFileCache&amp;#39;;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // filter     |  page/some/large      select file &amp;gt; memcache &amp;gt; db&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  $conf[&amp;#39;cache_class_cache_filter&amp;#39;]     = &amp;#39;DrupalFileCache&amp;#39;;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // form       |  edit/rare/medium     select file &amp;gt; memcache &amp;gt; db&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  $conf[&amp;#39;cache_class_cache_form&amp;#39;]       = &amp;#39;DrupalFileCache&amp;#39;;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // menu       |  any/often/large      select memcache &amp;gt; db &amp;gt; file&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  $conf[&amp;#39;cache_class_cache_menu&amp;#39;]       = &amp;#39;MemCacheDrupal&amp;#39;;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // page       |  page/often/large     select memcache &amp;gt; file &amp;gt; db&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  $conf[&amp;#39;cache_class_cache_page&amp;#39;]       = &amp;#39;MemCacheDrupal&amp;#39;;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // pathdst    |  any/some/medium      select memcache &amp;gt; db &amp;gt; file&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  $conf[&amp;#39;cache_class_cache_pathdst&amp;#39;]    = &amp;#39;MemCacheDrupal&amp;#39;;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // pathsrc    |  any/some/medium      select memcache &amp;gt; db &amp;gt; file&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  $conf[&amp;#39;cache_class_cache_pathsrc&amp;#39;]    = &amp;#39;MemCacheDrupal&amp;#39;;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // multiprice |  any/often/medium     select memcache &amp;gt; db &amp;gt; file&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  $conf[&amp;#39;cache_class_cache_uc_price&amp;#39;]   = &amp;#39;MemCacheDrupal&amp;#39;;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // update     |  system/rare/large,   select file &amp;gt; db&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  $conf[&amp;#39;cache_class_cache_update&amp;#39;]     = &amp;#39;DrupalFileCache&amp;#39;;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // users      |  any/some/large       select memcache &amp;gt; file &amp;gt; db&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  $conf[&amp;#39;cache_class_cache_users&amp;#39;]      = &amp;#39;MemCacheDrupal&amp;#39;;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // views      |  any/some/large       select memcache &amp;gt; file &amp;gt; db&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  $conf[&amp;#39;cache_class_cache_views&amp;#39;]      = &amp;#39;MemCacheDrupal&amp;#39;;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // views data |  any/often/small      select apc &amp;gt; db&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  $conf[&amp;#39;cache_class_cache_views_data&amp;#39;] = &amp;#39;DrupalAPCCache&amp;#39;;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  &lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // Define File Cache settings:&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // See README.TXT in FileCache directory for configuration details.&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  $conf[&amp;#39;filecache_fast_pagecache&amp;#39;] = TRUE; // set TRUE to enable fast page serving&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // you will need to define your $conf[&amp;#39;file_directory_temp&amp;#39;] = &amp;#39;/something/tmp&amp;#39;;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // before using this line. Put the directory in a place where drupal can write&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // (tmp, or files subdirectory) but that is not available via direct web&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // access, default Drupal conf protects .ht* directories, so default name is&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // .ht.filecache in the files directory if you provide no value for this setting&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  $conf[&amp;#39;filecache_directory&amp;#39;] = $conf[&amp;#39;file_directory_temp&amp;#39;] . DIRECTORY_SEPARATOR . &amp;#39;filecache&amp;#39;;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  &lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // Define APC settings.&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  $conf[&amp;#39;apc_show_debug&amp;#39;] = FALSE; // set TRUE to enable debug mode&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // TODO In order to use multiple Drupal instance on the same physical box,&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // each site settings.php file should provide a bin name prefix for APC and&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // most other bin. Currently APC is managing it internally with request&amp;#39;s&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // $_SERVER[&amp;#39;PHP_HOST&amp;#39;]. &lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  &lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // Define Memcache settings.&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  /* in case you use php-memcached and not php-memcache (for this one use php.ini settings)&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  $conf[&amp;#39;memcache_options&amp;#39;] = array(&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    Memcached::OPT_BINARY_PROTOCOL =&amp;gt; FALSE, // set TRUE to enable binary protocol when using memcached &amp;gt;= 1.4&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    Memcached::OPT_COMPRESSION =&amp;gt; FALSE, // set FALSE to disable compression for improved performance&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    Memcached::OPT_DISTRIBUTION =&amp;gt; Memcached::DISTRIBUTION_CONSISTENT, // set consistent distribution&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    Memcached::OPT_HASH =&amp;gt; Memcached::HASH_CRC, // set CRC32 hash method&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    Memcached::OPT_CONNECT_TIMEOUT =&amp;gt; 1000, // connection timeout in milliseconds&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    Memcached::OPT_SERVER_FAILURE_LIMIT =&amp;gt; 5, // failure limit for server connection attempts&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  );*/&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // This is not necessary if you have only 1 memcached server on default port&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // (11211) but could be used to map &amp;amp; replicate bins between several servers&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // (see memcached module documentation).&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  $conf[&amp;#39;memcache_servers&amp;#39;] = array(&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    &amp;#39;127.0.0.1:11211&amp;#39; =&amp;gt; &amp;#39;default&amp;#39;,&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  );&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // comment cache bins not used with memcached&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  $conf[&amp;#39;memcache_bins&amp;#39;] = array(&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    &amp;#39;cache&amp;#39;            =&amp;gt; &amp;#39;default&amp;#39;,&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    //&amp;#39;cache_bootstrap&amp;#39;  =&amp;gt; &amp;#39;default&amp;#39;,&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    &amp;#39;cache_block&amp;#39;      =&amp;gt; &amp;#39;default&amp;#39;,&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    //&amp;#39;cache_content&amp;#39;    =&amp;gt; &amp;#39;default&amp;#39;,&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    //&amp;#39;cache_filter&amp;#39;     =&amp;gt; &amp;#39;default&amp;#39;,&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    //&amp;#39;cache_form&amp;#39;       =&amp;gt; &amp;#39;default&amp;#39;,&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    &amp;#39;cache_menu&amp;#39;       =&amp;gt; &amp;#39;default&amp;#39;,&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    &amp;#39;cache_page&amp;#39;       =&amp;gt; &amp;#39;default&amp;#39;,&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    &amp;#39;cache_pathdst&amp;#39;    =&amp;gt; &amp;#39;default&amp;#39;,&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    &amp;#39;cache_pathsrc&amp;#39;    =&amp;gt; &amp;#39;default&amp;#39;,&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    &amp;#39;cache_uc_price&amp;#39;   =&amp;gt; &amp;#39;default&amp;#39;,&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    //&amp;#39;cache_update&amp;#39;     =&amp;gt; &amp;#39;default&amp;#39;,&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    &amp;#39;cache_users&amp;#39;      =&amp;gt; &amp;#39;default&amp;#39;,&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    &amp;#39;cache_views&amp;#39;      =&amp;gt; &amp;#39;default&amp;#39;,&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    //&amp;#39;cache_views_data&amp;#39; =&amp;gt; &amp;#39;default&amp;#39;,    &lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  );&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  &lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // Define Drupal cache settings:&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // Inactivate database connection if the cache backend doesn&amp;#39;t need it (for&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // cache_page bin only). If the page is not cached the db connection will be&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // made later.&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  $conf[&amp;#39;page_cache_without_database&amp;#39;] = TRUE;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // Avoid executing very early hooks in case of page cached (like hook_boot).&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  $conf[&amp;#39;page_cache_invoke_hooks&amp;#39;]     = TRUE;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // Cached page lifetime.&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  $conf[&amp;#39;page_cache_maximum_age&amp;#39;]      = 3600;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // Default lifetime for all cache entries (except form and page), if no&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  // lifetime is specified by the module.&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;  $conf[&amp;#39;cache_lifetime&amp;#39;]              = 0;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;And the sessions?&lt;/h3&gt;

&lt;p&gt;We've just been removing write and read requests from MySQL.
But if you're tracking the request &amp;amp; locks usage in MySQL you will see that the main problem  is not really the cache backends, it's the session managmenent.
Session Management in MySQL implies a very huge number of write operations in the session table.
This single table is used in a very special way, no other table in the database is used with such read/write/delete ratio.
So by definition it's quite hard to perform some fine tunning on the MySQL server if this table is not removed.
To be honest statistics tracking can also make a lot of write requests,  but this is yet another problem&lt;/p&gt;

&lt;p&gt;The Cache Backend management is not responsible of the session storage (at least  by default).
Memcache module is providing a tool for that, Cache Router module  was announcing it as well.
But The use of a new Module called &lt;a href=&quot;http://drupal.org/sandbox/pounard/1263216&quot;&gt;Session Proxy&lt;/a&gt; should be the definitive solution,
allowing usage of a cache backend or usage of PHP native sessions (which can be set to memcache, mongodb, redis, etc.).
Today it's still a sandboxed  module, no official release. available only with Drupal7.&lt;/p&gt;

&lt;p&gt;More on this module when released (like how to manage session locks, how to configure the cache backend for sessions, etc).&lt;/p&gt;

&lt;p&gt;We could also talk about the lock API in Drupal (lock.inc), with a default implementation using MySQL.
Some modules provides lock alternatives which are faster (like the Redis module)...&lt;/p&gt;
</description>
				<published>2011-10-03 00:00:00 +0200</published>
				<link>http://regilero.github.io/Drupal/English/2011/10/03/separate_cache_backends_d6_and_d7/</link>
			</item>
		
			<item>
				<title>Install Drupal in php-fpm (fastcgi) with Apache and a chroot php-fpm</title>
				<description>&lt;p&gt;Using PHP-fpm is a way to push PHP execution outside of Apache,
one of the main reasons to use it is freeing memory usage of PHP in the apache processes
and allowing usage of a threaded Apache server.&lt;/p&gt;

&lt;p&gt;In this article we'll explain what this sentence means :-) and will detail installation
and configuration of php-fpm for a Drupal project.&lt;br/&gt;
We'll try to keep all the good php settings for project separation we used &lt;a href=&quot;/Drupal/English/2011/09/02/Tune_your_php_settings_for_drupal/&quot;&gt;before&lt;/a&gt;,
and we'll try to provide a solution to the chrooted php-fpm problems.&lt;/p&gt;

&lt;h2&gt;Why do we need php-fpm to solve Apache memory problems with Drupal?&lt;/h2&gt;

&lt;p&gt;Well, first you are maybe not needing it.&lt;br/&gt;
But if you experience problems with the memory usage of Drupal
(usually big functionnal websites ask for more than 64M in PHP memory_limit)
and the number of parallel requests handled by apache, then you'll may find
a good solution with php-fpm.&lt;/p&gt;

&lt;h3&gt;Apache processes, PHP Memory, Prefork and Worker MPM&lt;/h3&gt;

&lt;p&gt;On a basic apache/PHP installation you're quite certainly using PHP as &lt;code&gt;mod_php&lt;/code&gt;,
it means it's an &lt;strong&gt;Apache module&lt;/strong&gt;. And when &lt;code&gt;memory_limit&lt;/code&gt; is set to &lt;code&gt;64M&lt;/code&gt;
it means &lt;strong&gt;each&lt;/strong&gt; Apache child process can grow up to 64M.
With &lt;code&gt;mod_php&lt;/code&gt; Apache is enforced in the &lt;strong&gt;prefork&lt;/strong&gt; model,
so &lt;strong&gt;each HTTP request use one Apache fork&lt;/strong&gt;, with &lt;code&gt;MaxClient&lt;/code&gt; limit (usually &lt;strong&gt;150&lt;/strong&gt; by default).
By default you handle 150 parallel HTTP request.&lt;br/&gt;
But there's also the &lt;code&gt;KeepAlive&lt;/code&gt; settings, by default &lt;strong&gt;15s&lt;/strong&gt; (but please set that to &lt;strong&gt;3s&lt;/strong&gt;),
so a forked Apache process stay online with the client browser for that amount of time,
and cannot handle a new request. &lt;br/&gt;
If you use long keepalives, and even with shorts ones, chances are you'll soon need more than
150 in MaxClients to handle parallel incoming HTTP requests.
And here comes the &lt;strong&gt;64M&lt;/strong&gt; of RAM per apache process.
If you want to push the MaxClients to 250 : &lt;code&gt;250 * 64M = 15,6 Go&lt;/code&gt; of RAM!&lt;/p&gt;

&lt;p&gt;The &lt;strong&gt;prefork mpm&lt;/strong&gt; is the very &lt;strong&gt;old&lt;/strong&gt; way to handle incoming requests for Apache.
One of the cool things coming with Apache 2 was the &lt;strong&gt;worker mpm&lt;/strong&gt;.
In this mode Apache forks a &lt;em&gt;few&lt;/em&gt; process (let's say 10 for example) and use threads inside
(from 25 to 75 by default), handling here &lt;code&gt;10*75 = 750&lt;/code&gt; HTTP requests in parallel.&lt;br/&gt;
It would be quite cool to use that on big websites,
for example all static files (js, css, images, ...) could be handled by parallel Apache threads,
maybe disabling KeepAlive completly, one request, one thread, simple and fast
(well, tests different combinations, it depends).&lt;br/&gt;
But &lt;strong&gt;mod_php cannot be used in the worker mpm&lt;/strong&gt;.&lt;br/&gt;
PHP 5 is multithread-enabled, but this is not the case for all PHP libraries.
Check documentation warnings on &lt;code&gt;setlocale()&lt;/code&gt;, here if you have several languages in your websites,
you may have mixed languages in the output if parallel threads in Apache are calling different &lt;code&gt;selocale()&lt;/code&gt;, quite bad.
And you could encounter this with a lot of PHP extension, hard to find, hard to debug,
this is why mod_php is always used with the old prefork model.&lt;/p&gt;

&lt;h2&gt;PHP as fastcgi&lt;/h2&gt;

&lt;p&gt;So we're not using all capabilities of Apache because of PHP? That's sad.&lt;br/&gt;
But if you extract PHP from Apache and run it in his own daemon then Apache is simply acting as a proxy of your PHP content generation.&lt;br/&gt;
This is one of the main ideas in &lt;code&gt;%cgi%&lt;/code&gt; things.
PHP is not only available as mod_php (apache module), it can be used in cli (command line interface), so it can be used as cgi.&lt;/p&gt;

&lt;p&gt;Strictly speaking cgi is a slow thing, this is why &lt;strong&gt;fastcgi&lt;/strong&gt; exists, and in the fastcgi familly there's quite a lot of possibilities
(fastcgi fcgid, etc). I'm too lazy to explain them all.&lt;/p&gt;

&lt;p&gt;The important thing is that &lt;strong&gt;php-fpm&lt;/strong&gt; is a way to &lt;strong&gt;run php as a fastcgi&lt;/strong&gt;.&lt;br/&gt;
When Apache 2.2.4 will be there (or if you are brave enough to use Apache unstable 2.2.3),
the right way to connect Apache and php-fpm will be the Apache module &lt;a href=&quot;http://httpd.apache.org/docs/2.4/fr/mod/mod_proxy_fcgi.html&quot;&gt;mod_proxy_fcgi&lt;/a&gt;.
The name says all, Apache is simply proxying a fastcgi thing outside, which produces results for each given HTTP request.&lt;br/&gt;
Waiting for that we'll instead use the apache module mod_fcgi.&lt;br/&gt;
It works quite well, but the behaviour is not as simple and clear as the proxy behavior.
Some Apache environment variables are still transfered to this module,
and we'll see that using php-fpm in a chrooted environment for each project will be a little more complex
than what it would be with the future &lt;strong&gt;mod_proxy_fastcgi&lt;/strong&gt;, anyway I'll explain a solution so we can now start the install.&lt;/p&gt;

&lt;h2&gt;Installing php-fpm on Debian step by step&lt;/h2&gt;

&lt;p&gt;This step by step was tested on a Debian squeeze (6.0).&lt;br/&gt;
You'd better start it on a fresh install.
Installing php-fpm on a server where mod_php with Apache in mpm_prefork is still needed is not possible.&lt;/p&gt;

&lt;h3&gt;Adding dotdeb &amp;amp; non-free repositories&lt;/h3&gt;

&lt;p&gt;We'll need the dotdeb repository&lt;/p&gt;

&lt;p&gt;Add this line in /etc/apt/sources.list&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt;    deb http://packages.dotdeb.org stable all
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;then add the GnuPG key&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt;    wget http://www.dotdeb.org/dotdeb.gpg
    cat dotdeb.gpg | sudo apt-key add -
    rm dotdeb.gpg
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Apache mod_fcgi is needed to link php-fpm (and not apache-fcgid) so add the non-free repository&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt;  &lt;span class=&quot;c&quot;&gt;# need non-free packages for FCGI (not FCGID)&lt;/span&gt;
  deb http://ftp.fr.debian.org/debian/ squeeze contrib non-free
  deb-src http://ftp.fr.debian.org/debian/ squeeze contrib non-free
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Then add contrib and non-free tags to the squeeze-update line to get:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt;  &lt;span class=&quot;c&quot;&gt;# squeeze-updates, previously known as &amp;#39;volatile&amp;#39;&lt;/span&gt;
  deb http://ftp.fr.debian.org/debian/ squeeze-updates main contrib non-free
  deb-src http://ftp.fr.debian.org/debian/ squeeze-updates main contrib non-free
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;And now that we set all the sources reload the sources informations&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt;  apt-get update
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;Adding packages&lt;/h3&gt;

&lt;p&gt;For PHP we'll need some packages, do that before installing apache packages, simplier&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt;  apt-get install php5 php5-fpm php-pear php5-common php5-mcrypt &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    php5-mysql php5-cli php5-gd php5-curl php5-apc
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;And now enforce Apache with the worker mode (using php-fpm with apache in prefork is useless)&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt;  apt-get install apache2-mpm-worker libapache2-mod-fastcgi
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;Apache modules configuration&lt;/h3&gt;

&lt;p&gt;We activate the apache modules fascgi and actions&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt;    a2enmod fastcgi actions
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;We add some more useful modules, headers, expires, status and rewrite&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt;   a2enmod expires headers status rewrite
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;And while we are working with apache modules let's removed some useles ones (this will reduce the memory footprint of Apache).
But check that in your own installation you do not need them.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;autoindex&lt;/strong&gt; is this awfull thing listing your directory contents when you forget to protect a directory,&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;cgid&lt;/strong&gt; is a pure cgi module (still running à perl cgi app from 1995?)&lt;/li&gt;
&lt;li&gt;and &lt;strong&gt;negotiation&lt;/strong&gt; allows some languages negociation in the HTTP protocol between the browser and the server -- you may need it, I don't--
it could also choose to use a file with same name as the request but not the right extension, strange behavoirs incoming!&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt;    a2dismod autoindex cgid negotiation
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;We add cronolog to avoid apache slowing because of log tasks. But this is not something required for php-fpm :-)&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt;apt-get install cronolog
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Usage of cronolog in your apache configuration is quite simple, instead of writing this:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;nb&quot;&gt;ErrorLog&lt;/span&gt; &lt;span class=&quot;sx&quot;&gt;/var/www/myproject/var/log/error-myproject.log&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;CustomLog&lt;/span&gt; &lt;span class=&quot;sx&quot;&gt;/var/www/myproject/var/log/access-myproject.log&lt;/span&gt; combined
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;You will use that:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;nb&quot;&gt;ErrorLog&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;|nice -n 10 /usr/bin/cronolog /var/www/myproject/var/log/%Y/%W/%d-myproject-error.log&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;CustomLog &amp;quot;&lt;/span&gt;|nice -n &lt;span class=&quot;m&quot;&gt;10&lt;/span&gt; &lt;span class=&quot;sx&quot;&gt;/usr/bin/cronolog&lt;/span&gt; &lt;span class=&quot;sx&quot;&gt;/var/www/myproject/var/log/&lt;/span&gt;%Y/%W/%d-myproject-access.log&lt;span class=&quot;err&quot;&gt;&amp;quot;&lt;/span&gt; combined
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;Project Tree&lt;/h3&gt;

&lt;p&gt;We'll use the project tree defined in a &lt;a href=&quot;/Drupal/English/2011/09/02/Tune_your_php_settings_for_drupal/&quot;&gt;previous article&lt;/a&gt;.
This article was about tunning the PHP configuration, but is also managing project trees,
so that having several Drupal projects running on the same host you encapsulate nicely each project in his own environment.&lt;br/&gt;
We will still try to encapsultate each php-fpm Drupal project &lt;strong&gt;in a separate environment&lt;/strong&gt; so everything stated there should
still apply in our new way of working.&lt;/p&gt;

&lt;p&gt;In this tree everything was in &lt;code&gt;/var/www/nameoftheproject&lt;/code&gt;, I'll add a company prefix, so the base of the tree for my projects
are &lt;code&gt;/var/www/makina/nameoftheproject&lt;/code&gt;. Inside I have a &lt;code&gt;www/&lt;/code&gt; directory (&lt;code&gt;documentRoot&lt;/code&gt;),
an &lt;code&gt;etc/&lt;/code&gt; directory for configuration files, a &lt;code&gt;var/&lt;/code&gt; directory for logs and temporary files, etc.&lt;/p&gt;

&lt;h3&gt;Minimal fastcgi.conf&lt;/h3&gt;

&lt;p&gt;The first thing to edit is the &lt;code&gt;fastcgi.conf&lt;/code&gt; file in &lt;code&gt;/etc/apache2/mods-available/fastcgi.conf&lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;ifmodule&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;mod_fastcgi.c=&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
         &lt;span class=&quot;nb&quot;&gt;FastCgiIpcDir&lt;/span&gt; &lt;span class=&quot;sx&quot;&gt;/var/www/makina/mydrupal/var/fcgi/&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;/ifmodule&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Which may be smaller than thee default one you may have. Most of these things will be set in the VirtualHost configuration instead.&lt;/p&gt;

&lt;p&gt;As you can see we need a &lt;code&gt;var/fcgi&lt;/code&gt; directory in our project tree.&lt;br/&gt;
It will be used to store the &lt;strong&gt;socket&lt;/strong&gt; making the connection between apache and php-fpm.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt;    mkdir -p /var/www/makina/mydrupal/var/fcgi/
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;We will leave the Apache configuration for a while and start the configuration of &lt;strong&gt;php-fpm&lt;/strong&gt;,
we'll get back on Apache with the VirtualHost, later.&lt;/p&gt;

&lt;h2&gt;FPM configuration&lt;/h2&gt;

&lt;h3&gt;Main php-fpm configuration&lt;/h3&gt;

&lt;p&gt;Backup conf example&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt;    mv /etc/php5/fpm/pool.d/www.conf /etc/php5/fpm/pool.d/www.conf.orig
    cp /etc/php5/fpm/php-fpm.conf /etc/php5/fpm/php-fpm.conf.bak
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Now edit the main php-fpm configuration file &lt;code&gt;/etc/php5/fpm/php-fpm.conf&lt;/code&gt; and alter it to get this content
(the most important thing is to really get the include of the &lt;strong&gt;pool.d directory&lt;/strong&gt; at the end, and only files ending in &lt;code&gt;.conf&lt;/code&gt;):&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;php&quot;&gt;&lt;span class=&quot;x&quot;&gt;;;;;;;;;;;;;;;;;;;;;;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; FPM Configuration ;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;;;;;;;;;;;;;;;;;;;;;;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; All relative paths in this configuration file are relative to PHP&amp;#39;s install&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; prefix (/usr). This prefix can be dynamicaly changed by using the&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; &amp;#39;-p&amp;#39; argument from the command line.&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; Include one or more files. If glob(3) exists, it is used to include a bunch of&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; files from a glob(3) pattern. This directive can be used everywhere in the&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; file.&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; Relative path can also be used. They will be prefixed by:&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;;  - the global prefix if it&amp;#39;s been set (-p arguement)&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;;  - /usr otherwise&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;;include=/etc/php5/fpm/*.conf&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;;;;;;;;;;;;;;;;;;;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; Global Options ;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;;;;;;;;;;;;;;;;;;;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;[global]&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; Pid file&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; Note: the default prefix is /var&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; Default Value: none&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;pid = /var/run/php5-fpm.pid&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; Error log file&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; Note: the default prefix is /var&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; Default Value: log/php-fpm.log&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;error_log = /var/log/php5-fpm.log&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; Log level&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; Possible Values: alert, error, warning, notice, debug&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; Default Value: notice&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;log_level = notice&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; If this number of child processes exit with SIGSEGV or SIGBUS within the time&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; interval set by emergency_restart_interval then FPM will restart. A value&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; of &amp;#39;0&amp;#39; means &amp;#39;Off&amp;#39;.&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; Default Value: 0&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;;emergency_restart_threshold = 0&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; Interval of time used by emergency_restart_interval to determine when&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; a graceful restart will be initiated.  This can be useful to work around&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; accidental corruptions in an accelerator&amp;#39;s shared memory.&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; Available Units: s(econds), m(inutes), h(ours), or d(ays)&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; Default Unit: seconds&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; Default Value: 0&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;;emergency_restart_interval = 0&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; Time limit for child processes to wait for a reaction on signals from master.&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; Available units: s(econds), m(inutes), h(ours), or d(ays)&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; Default Unit: seconds&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; Default Value: 0&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;;process_control_timeout = 0&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; Send FPM to background. Set to &amp;#39;no&amp;#39; to keep FPM in foreground for debugging.&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; Default Value: yes&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;;daemonize = yes&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;;;;;;;;;;;;;;;;;;;;;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; Pool Definitions ;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;;;;;;;;;;;;;;;;;;;;;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; Multiple pools of child processes may be started with different listening&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; ports and different management options.  The name of the pool will be&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; used in logs and stats. There is no limitation on the number of pools which&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; FPM can handle. Your system will tell you anyway :)&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt; &lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; To configure the pools it is recommended to have one .conf file per&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;; pool in the following directory:&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;include=/etc/php5/fpm/pool.d/*.conf&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;php-fpm Pool configuration&lt;/h3&gt;

&lt;p&gt;The &lt;strong&gt;pool&lt;/strong&gt; is your project.&lt;br/&gt;
php-fpm can run several pools, we'll use one for each separate project.&lt;br/&gt;
So for a project named &lt;em&gt;mydrupal&lt;/em&gt; we'll use a file &lt;code&gt;/etc/php5/fpm/pool.d/mydrupal.conf&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;you can read the &lt;code&gt;/etc/php5/fpm/pool.d/www.conf.orig&lt;/code&gt; file to see what a default pool can contain.
The most important parameters are &lt;strong&gt;prefix&lt;/strong&gt; and &lt;strong&gt;chroot&lt;/strong&gt;.&lt;br/&gt;
A complete pool configuration is given a few lines below. But before reading it we'll need to understand the &lt;strong&gt;chroot problem&lt;/strong&gt;.&lt;/p&gt;

&lt;h3&gt;Chrooted php-fpm&lt;/h3&gt;

&lt;p&gt;As said before &lt;strong&gt;mod_proxy_fcgi&lt;/strong&gt; will soon be the right way to connect Apache and php-fpm, especially if you want chrooted php-fpm instances.&lt;/p&gt;

&lt;p&gt;In &lt;strong&gt;mod_fastcgi&lt;/strong&gt; we cannot alter &lt;code&gt;DOCUMENT_ROOT&lt;/code&gt; and &lt;code&gt;SCRIPT_FILENAME&lt;/code&gt; environment variables,
and these variables contain the &lt;strong&gt;non-chrooted informations&lt;/strong&gt;.&lt;br/&gt;
I made a lot of tests with &lt;strong&gt;mod_rewrite&lt;/strong&gt;, php &lt;strong&gt;auto_prepend_file&lt;/strong&gt;, etc, no way to fix that.&lt;br/&gt;
While waiting for that solution the only &lt;em&gt;'solution'&lt;/em&gt; is to &lt;strong&gt;rebuild the real path&lt;/strong&gt; in the php-fpm's pool chroot
and &lt;strong&gt;link the www directory to the real one&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;Without the chroot things are quite simple, you can try it before if you want.&lt;br/&gt;
With the chroot options in php-fpm we enforce the php-fpm execution in &lt;code&gt;/var/www/makina/mydrupal&lt;/code&gt; (the pool prefix).&lt;br/&gt;
No way to get to a parent directory. Fine for parallel projects security.&lt;br/&gt;
But php-fpm receive a &lt;code&gt;DocumentRoot&lt;/code&gt; from apache, telling it should move (cd) into &lt;code&gt;var/www/makina/mydrupal/www&lt;/code&gt;.&lt;br/&gt;
Well we're already quite there, we would like just a move to &lt;code&gt;www/&lt;/code&gt;, but for php-fpm this means it needs to go to
&lt;code&gt;/var/www/makina/mydrupal/var/www/makina/mydrupal/www&lt;/code&gt;... And no way to alter this document root and script filename received instructions.&lt;/p&gt;

&lt;p&gt;So in our working project &lt;code&gt;/var/www/makina/mydrupal&lt;/code&gt; where php files are in &lt;code&gt;www/&lt;/code&gt; we do &lt;strong&gt;a symbolic link&lt;/strong&gt; of this too long path
to the short one we would like to have:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt;    &lt;span class=&quot;nb&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$pool&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;mydrupal
    &lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; /var/www/makina/&lt;span class=&quot;nv&quot;&gt;$pool&lt;/span&gt;
    mkdir -p var/www/makina/&lt;span class=&quot;nv&quot;&gt;$pool&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;# warn, not absolute /var... but relative var/....&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;var/www/makina/&lt;span class=&quot;nv&quot;&gt;$pool&lt;/span&gt;
    ln -s ../../../../www/ www
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Yes, &lt;strong&gt;that's ugly&lt;/strong&gt;, but at least we can now have a working php-fpm pool which is chrooted in &lt;code&gt;/var/www/makina/mydrupal&lt;/code&gt;.&lt;br/&gt;
Wait for &lt;strong&gt;mod_proxy_fcgi&lt;/strong&gt; or avoid using chroot in php-fpm if you do not want that.&lt;/p&gt;

&lt;p&gt;The final tree is:&lt;/p&gt;

&lt;pre&gt;
/ ==&gt; [/ for everyone except the chrooted php-fpm]
  \-/var/
    \-www/
      \-makina/
        \-mydrupal/ [base of the chroot for php-fpm (/ for him)
          \-etc/
          \-doc/
          \-www/ ===&gt; [A], DocumentRoot, here is Drupal
          \-var/
            \-tmp/
            \-log
            \-www/ ==&gt; empty
              \-makina/ ==&gt; empty
                \-mydrupal/ ==&gt; empty
                  \-www/ ===&gt; symbolic link to [A]
&lt;/pre&gt;


&lt;p&gt;&lt;strong&gt;Warning&lt;/strong&gt;: see update at the end of article, there is maybe one way of not doing that&lt;/p&gt;

&lt;p&gt;Let's have a look at this pool configuration file (&lt;code&gt;/etc/php5/fpm/pool.d/mydrupal.conf&lt;/code&gt;):&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;php&quot;&gt;&lt;span class=&quot;x&quot;&gt;    ; Start a new pool named &amp;#39;mydrupal&amp;#39;.&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    ; the variable $pool can we used in any directive and will be replaced by the&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    ; pool name (&amp;#39;mydrupal&amp;#39; here)&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    [mydrupal]&lt;/span&gt;

&lt;span class=&quot;x&quot;&gt;    ; Per pool prefix&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    ; It only applies on the following directives:&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    ; - &amp;#39;slowlog&amp;#39;, &amp;#39;listen&amp;#39;,&amp;#39;chroot&amp;#39;,&amp;#39;chdir&amp;#39;,&amp;#39;php_values&amp;#39;,&amp;#39;php_admin_values&amp;#39;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    prefix = /var/www/makina/$pool&lt;/span&gt;

&lt;span class=&quot;x&quot;&gt;    ; The address on which to accept FastCGI requests.&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    ;without prefix: listen = /var/www/makina/$pool/var/fcgi/$pool.sock&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    listen = var/fcgi/$pool.sock&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    listen.allowed_clients = 127.0.0.1&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    listen.owner = www-data&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    listen.group = www-data&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    listen.mode = 0660&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    user = www-data&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    group = www-data&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    pm = dynamic&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    pm.max_children = 50&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    pm.start_servers = 20&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    pm.min_spare_servers = 5&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    pm.max_spare_servers = 35&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    ;pm.max_requests = 500&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    pm.status_path = /myfpmstatus&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    request_terminate_timeout = 30s&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    request_slowlog_timeout = 10s&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    ; WARNING: chroot does not apply on this setting (??)&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    slowlog = /var/www/makina/$pool/var/log/$pool.log.slow&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    ; Chroot to this directory at the start. This value must be defined as an&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    ; absolute path. When this value is not set, chroot is not used.&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    chroot = $prefix&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    chdir = /&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    catch_workers_output = yes&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    env[HOSTNAME] = $HOSTNAME&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    env[TMP] = /var/tmp&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    env[TMPDIR] = /var/tmp&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    env[TEMP] = /var/tmp&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    env[DOCUMENT_ROOT] = /www&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    &lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    ; Additional php.ini defines, specific to this pool of workers. These settings&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;   &lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_admin_value[open_basedir] = &amp;quot;.:/www:/var/tmp&amp;quot;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_value[include_path]=&amp;quot;.:/www:/www/include&amp;quot;&lt;/span&gt;

&lt;span class=&quot;x&quot;&gt;    ; UPLOAD&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_admin_flag[file_uploads]=1&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_admin_value[upload_tmp_dir]=&amp;quot;/var/tmp&amp;quot;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    ;Maximum allowed size for uploaded files.&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_admin_value[upload_max_filesize]=&amp;quot;50M&amp;quot;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_admin_value[max_input_time]=120&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_admin_value[post_max_size]=&amp;quot;50M&amp;quot;&lt;/span&gt;

&lt;span class=&quot;x&quot;&gt;    ;#### LOGS&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_admin_flag[log_errors] = on&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_admin_value[log_errors]=1&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    ;php_flag[display_errors] = on&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_admin_value[display_errors]=0&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_admin_value[display_startup_errors]=0&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_admin_value[html_errors]=0&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_admin_value[define_syslog_variables]=0&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_value[error_reporting]=6143&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    ; Maximum execution time of each script, in seconds (30)&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_value[max_input_time]=&amp;quot;120&amp;quot;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    ; Maximum amount of time each script may spend parsing request data&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_value[max_execution_time]=&amp;quot;300&amp;quot;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    ; Maximum amount of memory a script may consume (8MB)&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_value[memory_limit]=&amp;quot;100M&amp;quot;&lt;/span&gt;

&lt;span class=&quot;x&quot;&gt;    ; Sessions: IMPORTANT reactivate garbage collector on Debian!!!&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_value[session.gc_maxlifetime]=3600&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_admin_value[session.gc_probability]=1&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_admin_value[session.gc_divisor]=100&lt;/span&gt;

&lt;span class=&quot;x&quot;&gt;    ; SECURITY&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_admin_value[magic_quotes_gpc]=0&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_admin_value[register_globals]=0&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_admin_value[session.auto_start]=0&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_admin_value[mbstring.http_input]=&amp;quot;pass&amp;quot;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_admin_value[mbstring.http_output]=&amp;quot;pass&amp;quot;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_admin_value[mbstring.encoding_translation]=0&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_admin_value[expose_php]=0&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_admin_value[allow_url_fopen]=1&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_admin_value[safe_mode]=0&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_admin_value[expose_php]=0&lt;/span&gt;

&lt;span class=&quot;x&quot;&gt;    ; enforce filling PATH_INFO &amp;amp; PATH_TRANSLATED&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    ; and not only SCRIPT_FILENAME&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_admin_value[cgi.fix_pathinfo]=1&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    ; 1: will use PATH_TRANSLATED instead of SCRIPT_FILENAME&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_admin_value[cgi.discard_path]=0&lt;/span&gt;

&lt;span class=&quot;x&quot;&gt;    ; FASTCGI chrooted - HACKING SCRIPT_FILENAME&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    ; if any script in the project try to access some $_SERVER&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    ; keys that are not ok in php-fpm mode, then use this&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    ; script to alter/move the $_SERVER array&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    ; the script should be at the root of the project (before the www)&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    ; in the chrooted project&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    ;php_admin_value[auto_prepend_file]=&amp;quot;/fix_phpfpm_env.php&amp;quot;&lt;/span&gt;

&lt;span class=&quot;x&quot;&gt;    ; APC settings ###################&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    ; package given from dotdeb is recent&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    ; if you don&amp;#39;t like it:&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    ; apt-get install php-dev php-pear make libpcre3-dev; pecl install apc;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    ; then : echo &amp;quot;extension=apc.so&amp;quot; &amp;gt;&amp;gt; /etc/php5/conf.d/apc.ini&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    ; and : echo &amp;quot;extension=apc.so&amp;quot; &amp;gt;&amp;gt; /etc/php5/fpm/conf.d/apc.ini&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    ; enabling apc&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_admin_value[apc.enabled]=1&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    # allow progress upload bars&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_admin_value[apc.rfc1867]=1&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    # better require_once engine&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_admin_value[apc.include_once_override]=1&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    # make all path absolutes&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_admin_value[apc.canonicalize]=1&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    # only on PRODUCTION SERVER: do not check for file updates (0)&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    # set it to 1 in DEVELOPMENT servers&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_admin_value[apc.stat]=1&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    # Shared memory size&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    # check for max SHM in sysctl: sysctl -a|grep shmmax| awk -F&amp;#39;=&amp;#39; &amp;#39;{print $2/1024/1024 &amp;quot; Mo&amp;quot;}&amp;#39;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    # usually 32M. to get greater (like here 64Mo), do:&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    # sysctl -w kernel.shmmax=67108864;sysctl -p /etc/sysctl.conf&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_admin_value[apc.shm_size]=64M&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    # thanks facebook for these 2 ones, lazy usage of function from opcode&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    # load only required functions &amp;amp; classes on-demand. Effects should be tested&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    # for each app&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_admin_value[apc.lazy_functions]=1&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    # last time I&amp;#39;ve checked this made a WOD on Drupal...&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_admin_value[apc.lazy_classes]=0&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    # better use cli optimizations in fpm mode, no?&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;    php_admin_value[apc.enable_cli]=1&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;Application VirtualHost&lt;/h3&gt;

&lt;p&gt;Now we are going to create our Apache Virtualhost and our php-fpm project.&lt;br/&gt;
You may need to tests things while creating all theses things. So I'll give you a few commands that could help you&lt;/p&gt;

&lt;h4&gt;testing apache configuration:&lt;/h4&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt;  &lt;span class=&quot;c&quot;&gt;#loading apache env variables (see the dot-space)&lt;/span&gt;
  . /etc/apache2/envvars
  &lt;span class=&quot;c&quot;&gt;# test apache configuration&lt;/span&gt;
  apache2 -t
  &lt;span class=&quot;c&quot;&gt;# list apache virtualhosts&lt;/span&gt;
  apache2 -S
  &lt;span class=&quot;c&quot;&gt;# list apache modules&lt;/span&gt;
  apache2 -M
  &lt;span class=&quot;c&quot;&gt;# restarting php-fpm (yes, not done via apache restart)&lt;/span&gt;
  /etc/init.php5-fpm restart
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;We need to creat the Apache VirtualHost for our current project.&lt;br/&gt;
We'll put the source in our project directory &lt;code&gt;etc/&lt;/code&gt; and link it to the main apache virtualhosts repository.&lt;br/&gt;
But you could edit it directly in &lt;code&gt;/etc/apache2/sites-available&lt;/code&gt; if you want
(I'm in fact even storing the pool configuration here and linking it to &lt;code&gt;/etc/php5/fpm/pool.d&lt;/code&gt;).&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt;    touch /var/www/makina/mydrupal/etc/apache.conf
    ln -s /var/www/makina/mydrupal/etc/apache.conf /etc/apache2/site-available/101-mydrupal
    a2ensite 101-mydrupal
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;And now we need to write some content inside this &lt;code&gt;/var/www/makina/mydrupal/etc/apache.conf&lt;/code&gt;.&lt;br/&gt;
And in this Virtualhost we'll need to connect the PHP scripts to the php-fpm.
So I'll first gives you a complete VirtualHost and then we will detail how the php-fpm is managed inside.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;virtualHost&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;*:80&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;ServerName&lt;/span&gt; mydrupal.example.com
    &lt;span class=&quot;nb&quot;&gt;DocumentRoot&lt;/span&gt; &lt;span class=&quot;sx&quot;&gt;/var/www/makina/mydrupal/www&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;LogLevel&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;debug&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;#LogLevel warn&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;#LogLevel notice&lt;/span&gt;
 
    &lt;span class=&quot;c&quot;&gt;# Debug mod_rewrite&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;#RewriteEngine On&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;#RewriteLogLevel 9&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;#RewriteLog /tmp/rewritelog.log&lt;/span&gt;
 
    &lt;span class=&quot;c&quot;&gt;# classic&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;#ErrorLog /var/www/makina/mydrupal/var/log/error.log&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;#CustomLog /var/www/makina/mydrupal/var/log/access.log combined&lt;/span&gt;
    &lt;span class=&quot;c&quot;&gt;# or via cronolog&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;ErrorLog&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;|nice -n 10 /usr/bin/cronolog /var/www/makina/mydrupal/var/log/%Y/%W/%d-mydrupal-error.log&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;    CustomLog &amp;quot;&lt;/span&gt;|nice -n &lt;span class=&quot;m&quot;&gt;10&lt;/span&gt; &lt;span class=&quot;sx&quot;&gt;/usr/bin/cronolog&lt;/span&gt; &lt;span class=&quot;sx&quot;&gt;/var/www/makina/mydrupal/var/log/&lt;/span&gt;%Y/%W/%d-mydrupal-access.log&lt;span class=&quot;s2&quot;&gt;&amp;quot; combined&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt; &lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;    &amp;lt;Directory / &amp;gt;&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;            Order deny,allow&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;            deny from all&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;            Options FollowSymLinks&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;            # PREVENT .htaccess reading&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;            AllowOverride None&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt; &lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;            #.svn &amp;amp; .git directories must be avoided!!&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;            RedirectMatch 404 /\.svn(/|$)&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;            RedirectMatch 404 /\.git(/|$)&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;    &amp;lt;/Directory&amp;gt;&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt; &lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;    # phpfpm/fastcgi&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;    # Here we catch the &amp;#39;false&amp;#39; Location used to inexistent php5.external&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;    # and push it to the external FastCgi process via a socket&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;    # note: socket path is relative to FastCgiIpcDir&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;    # which is set in Main configuration /etc/apache2/mods-available/fastcgi.conf&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;    &amp;lt;IfModule mod_fastcgi.c&amp;gt;&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;        # all .php files will be pushed to a php5-fcgi handler&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;        AddHandler php5-fcgi .php&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt; &lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;        #action module will let us run a cgi script based on handler php5-fcgi&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;        Action php5-fcgi /fcgi-bin/php5.external&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt; &lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;        # and we add an Alias to the fcgi location&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;        Alias /fcgi-bin/php5.external /php5.external&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt; &lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;        # now we catch this cgi script which in fact does not exists on filesystem&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;        # we catch it on the url (Location)&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;        &amp;lt;Location /fcgi-bin/php5.external&amp;gt;&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;            # here we prevent direct access to this Location url,&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;            # env=REDIRECT_STATUS will let us use this fcgi-bin url&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;            # only after an internal redirect (by Action upper)&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;            Order Deny,Allow&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;            Deny from All&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;            Allow from env=REDIRECT_STATUS&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;        &amp;lt;/Location&amp;gt;&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt; &lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;    &amp;lt;/IfModule&amp;gt;&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;     &lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;    FastCgiExternalServer /php5.external -socket mydrupal.sock -appConnTimeout 30 -idle-timeout 60&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt; &lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;    # Project directory&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;    &amp;lt;Directory /var/www/makina/mydrupal/www&amp;gt;&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;        Order allow,deny&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;        Allow from all&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt; &lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;        # Follow symbolic links in this directory.&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;        Options +FollowSymLinks -Indexes -Multiviews&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;        # Set the default handler.&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;        DirectoryIndex index.php&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt; &lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;        # Customized error messages.&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;        ErrorDocument 404 /index.php&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt; &lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;       # Various rewrite rules.&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;        &amp;lt;IfModule mod_rewrite.c&amp;gt;&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;            RewriteEngine on&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                ######### START RULE 1##################################&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                # cleanurl is activated so ALL urls&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                # MUSt be accessed on /too/titi and MUSN&amp;#39;T be accessed on index.php?q=/toto/titi&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                # main reason is that applying url rules (like restricting /admin access is far easier&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                # in the cleanurl form than in parameter form (check commented rule on QUERY_STRING&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                # below as QUERY_STRING as no url decode done in Apache, see that it&amp;#39;s harder)&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                # WARNING: need to alter any &amp;#39;q&amp;#39; parameter that could be present&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                # on original QUERY_STRING (part after the ?), or something&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                # like /toto?q=admin could become a q=toto&amp;amp;q=admin&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                # which is finally a q=admin, so we do not restrict&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                # this rule to index.php&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                #########################################################&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                # WARNING: must prevent real internal redirect of :&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                # /toto/titi to q=/toto/titi (done in rule 2)&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                # to be forbidden, so the rule apply only&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                # if the rewriting process is starting&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                RewriteCond %{ENV:REDIRECT_STATUS} ^$&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt; &lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                #detect non-blank QUERY_STRING (some parameters are present after the ?&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                RewriteCond %{QUERY_STRING} . [NC]&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt; &lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                # simplier one: we prevent any query with a q= parameter&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                RewriteCond %{QUERY_STRING} (^|&amp;amp;|%26|%20)(q|Q|%71|%51)(=|%3D). [NC]&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt; &lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                # 403 FORBIDDEN !&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                RewriteRule .* - [F,L]&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                ########## END RULE 1 ###################&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt; &lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                ########## START RULE 2 ###################&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                # cleanurl handling&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                # for things which aren&amp;#39;t real files or dir then&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                # take the given url and giv it to index.php?q=...&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                ###########################################&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                # all url that didn&amp;#39;t match ALL previous rewriteCond are still there&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                # squeeze real files or directories, if they really exists&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                # then Drupal won&amp;#39;t be called  &lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                RewriteCond %{REQUEST_FILENAME} !-f&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                RewriteCond %{REQUEST_FILENAME} !-d&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt; &lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                # do not handle the favicon with Drupal bootstrap&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                RewriteCond %{REQUEST_URI} !=/favicon.ico&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt; &lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                # This one is needed in php-fpm mode to avoid infinite redirects&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                RewriteCond %{REQUEST_FILENAME} !=/var/www/makina/mydrupal/www/fcgi-bin/php5.external&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                # put everything still there to Drupal index.php&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                # [L]= stop rewriting here for matching rules&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                # [QSA]=Appends any query string created in the rewrite target&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                # to any query string that was in the original request URL&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                RewriteRule ^(.*)$ index.php?q=$1 [L,QSA]&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;                ########## END RULE 2 ###################&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;        &amp;lt;/IfModule&amp;gt;&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt; &lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;        ### DRUPAL ###&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;        # Protect files and directories from prying eyes.&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;        &amp;lt;FilesMatch &amp;quot;&lt;/span&gt;\.(engine|inc|info|install|make|module|profile|test|po|sh|.*sql|theme|tpl(\.php)?|xtmpl)$|^(\..*|Entries.*|Repository|Root|Tag|Template)$&lt;span class=&quot;s2&quot;&gt;&amp;quot;&amp;gt;&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;          Order allow,deny&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;        &amp;lt;/FilesMatch&amp;gt;&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;         &lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;        # Make Drupal handle any 404 errors.&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;        ErrorDocument 404 /index.php&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;        # Force simple error message for requests for non-existent favicon.ico.&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;        &amp;lt;Files favicon.ico&amp;gt;&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;          # There is no end quote below, for compatibility with Apache 1.3.&lt;/span&gt;
&lt;span class=&quot;s2&quot;&gt;          ErrorDocument 404 &amp;quot;&lt;/span&gt;The requested file favicon.ico was not found.
        &lt;span class=&quot;nt&quot;&gt;&amp;lt;/Files&amp;gt;&lt;/span&gt;
         
        &lt;span class=&quot;c&quot;&gt;# Requires mod_expires to be enabled.&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;&amp;lt;IfModule&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;mod_expires.c&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;c&quot;&gt;# Enable expirations.&lt;/span&gt;
            &lt;span class=&quot;nb&quot;&gt;ExpiresActive&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;On&lt;/span&gt;
            &lt;span class=&quot;c&quot;&gt;# Cache all files for 2 weeks after access (A).&lt;/span&gt;
            &lt;span class=&quot;nb&quot;&gt;ExpiresDefault&lt;/span&gt; A1209600
            &lt;span class=&quot;nt&quot;&gt;&amp;lt;FilesMatch&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;\.php$&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
                &lt;span class=&quot;c&quot;&gt;# Do not allow PHP scripts to be cached unless they explicitly send cache&lt;/span&gt;
                &lt;span class=&quot;c&quot;&gt;# headers themselves. Otherwise all scripts would have to overwrite the&lt;/span&gt;
                &lt;span class=&quot;c&quot;&gt;# headers set by mod_expires if they want another caching behavior. This may&lt;/span&gt;
                &lt;span class=&quot;c&quot;&gt;# fail if an error occurs early in the bootstrap process, and it may cause&lt;/span&gt;
                &lt;span class=&quot;c&quot;&gt;# problems if a non-Drupal PHP file is installed in a subdirectory.&lt;/span&gt;
                &lt;span class=&quot;nb&quot;&gt;ExpiresActive&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;Off&lt;/span&gt;
            &lt;span class=&quot;nt&quot;&gt;&amp;lt;/FilesMatch&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;&amp;lt;/IfModule&amp;gt;&lt;/span&gt;

        &lt;span class=&quot;c&quot;&gt;# Rules to correctly serve gzip compressed CSS and JS files.&lt;/span&gt;
          &lt;span class=&quot;c&quot;&gt;# Requires both mod_rewrite and mod_headers to be enabled.&lt;/span&gt;
          &lt;span class=&quot;nt&quot;&gt;&amp;lt;IfModule&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;mod_headers.c&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;c&quot;&gt;# Serve gzip compressed CSS files if they exist and the client accepts gzip.&lt;/span&gt;
            &lt;span class=&quot;nb&quot;&gt;RewriteCond&lt;/span&gt; %{HTTP:Accept-encoding} gzip
            &lt;span class=&quot;nb&quot;&gt;RewriteCond&lt;/span&gt; %{REQUEST_FILENAME}\.gz -s
            &lt;span class=&quot;nb&quot;&gt;RewriteRule&lt;/span&gt; ^(.*)\.css $1\.css\.gz [QSA]
 
            &lt;span class=&quot;c&quot;&gt;# Serve gzip compressed JS files if they exist and the client accepts gzip.&lt;/span&gt;
            &lt;span class=&quot;nb&quot;&gt;RewriteCond&lt;/span&gt; %{HTTP:Accept-encoding} gzip
            &lt;span class=&quot;nb&quot;&gt;RewriteCond&lt;/span&gt; %{REQUEST_FILENAME}\.gz -s
            &lt;span class=&quot;nb&quot;&gt;RewriteRule&lt;/span&gt; ^(.*)\.js $1\.js\.gz [QSA]
         
            &lt;span class=&quot;c&quot;&gt;# Serve correct content types, and prevent mod_deflate double gzip.&lt;/span&gt;
            &lt;span class=&quot;nb&quot;&gt;RewriteRule&lt;/span&gt; \.css\.gz$ - [T=text/css,E=no-gzip:1]
            &lt;span class=&quot;nb&quot;&gt;RewriteRule&lt;/span&gt; \.js\.gz$ - [T=text/javascript,E=no-gzip:1]
         
            &lt;span class=&quot;nt&quot;&gt;&amp;lt;FilesMatch&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;(\.js\.gz|\.css\.gz)$&amp;quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
              &lt;span class=&quot;c&quot;&gt;# Serve correct encoding type.&lt;/span&gt;
              &lt;span class=&quot;nb&quot;&gt;Header&lt;/span&gt; append Content-Encoding gzip
              &lt;span class=&quot;c&quot;&gt;# Force proxies to cache gzipped &amp;amp; non-gzipped css/js files separately.&lt;/span&gt;
              &lt;span class=&quot;nb&quot;&gt;Header&lt;/span&gt; append Vary Accept-Encoding
            &lt;span class=&quot;nt&quot;&gt;&amp;lt;/FilesMatch&amp;gt;&lt;/span&gt;
          &lt;span class=&quot;nt&quot;&gt;&amp;lt;/IfModule&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;/Directory&amp;gt;&lt;/span&gt;
 
   &lt;span class=&quot;nt&quot;&gt;&amp;lt;Directory&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;/var/www/makina/mydrupal/var/tmp&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;AllowOverride&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;None&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;Order&lt;/span&gt; allow,deny
        &lt;span class=&quot;nb&quot;&gt;Allow&lt;/span&gt; from &lt;span class=&quot;k&quot;&gt;all&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;# avoid execution of PHP scripts in upload directory&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;AddType&lt;/span&gt; text/plain .php
        &lt;span class=&quot;nb&quot;&gt;AddType&lt;/span&gt; text/plain .phps
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;/Directory&amp;gt;&lt;/span&gt;
 

   &lt;span class=&quot;nt&quot;&gt;&amp;lt;Directory&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;/var/www/makina/mydrupal/www/sites/default/files&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;AllowOverride&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;None&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;Order&lt;/span&gt; allow,deny
        &lt;span class=&quot;nb&quot;&gt;Allow&lt;/span&gt; from &lt;span class=&quot;k&quot;&gt;all&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;# avoid execution of PHP scripts in uploaded files&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;AddType&lt;/span&gt; text/plain .php
        &lt;span class=&quot;nb&quot;&gt;AddType&lt;/span&gt; text/plain .phps
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;/Directory&amp;gt;&lt;/span&gt;
 
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;Location&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;/cron.php&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;Order&lt;/span&gt; deny,allow
        &lt;span class=&quot;nb&quot;&gt;deny&lt;/span&gt; from &lt;span class=&quot;k&quot;&gt;all&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;allow&lt;/span&gt; from &lt;span class=&quot;m&quot;&gt;127.0.0.1&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;/Location&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;/VirtualHost&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This VirtualHost contains some parts of the &lt;a href=&quot;/Drupal/English/2011/09/01/better_rewrite_rules_for_drupal/&quot;&gt;previous article&lt;/a&gt;
(like extended rewrite rules) but the main php-fpm things are:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;an &lt;strong&gt;handler php5-fcgi&lt;/strong&gt; for all &lt;code&gt;.php&lt;/code&gt; files&lt;/li&gt;
&lt;li&gt;an &lt;strong&gt;action&lt;/strong&gt; catching this php5-fcgi telling apache to push that to a file &lt;strong&gt;/fcgi-bin/php5.external&lt;/strong&gt; (keep cool, all theses things are virtual)&lt;/li&gt;
&lt;li&gt;an &lt;strong&gt;alias&lt;/strong&gt; catching this &lt;strong&gt;/fcgi-bin/php5.external&lt;/strong&gt; and pushing it to the url &lt;strong&gt;/php5.external&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;a &lt;strong&gt;Location&lt;/strong&gt; directive, handling only the &lt;strong&gt;/php5.external&lt;/strong&gt; url, where we enforce the fact this url cannot be accessed directly, only via internal redirects (so from all the previous points here)&lt;/li&gt;
&lt;li&gt;The connection of a &lt;strong&gt;virtual file name php.external&lt;/strong&gt; to a &lt;strong&gt;fastcgi service&lt;/strong&gt;, via a given socket. It's the line containing &lt;code&gt;FastCgiExternalServer&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So that's all. Any HTTP request for something not static or rejected ends to Drupal's index.php,
which is then redirected internally to the virtual external file (php.external),
where it's connected to a socket mydrupal.sock which is relative to the &lt;code&gt;FastCgiIpcDir&lt;/code&gt; we defined previously,
so it's &lt;code&gt;/var/www/makina/mydrupal/var/fcgi/mydrupal.sock&lt;/code&gt;. &lt;br/&gt;
This is the socket used for the communication channel between php-fpm and Apache.&lt;br/&gt;
In the php-fpm pool configuration we defined this same socket with the listen command
(without prefix: &lt;code&gt;/var/www/makina/mydrupal/var/fcgi/mydrupal.sock&lt;/code&gt; and with the chroot and prefix: &lt;code&gt;listen = var/fcgi/mydrupal.sock&lt;/code&gt;).&lt;/p&gt;

&lt;h3&gt;File access rights&lt;/h3&gt;

&lt;p&gt;We need to apply some rights for the apache user.&lt;br/&gt;
Basically the www-user needs &lt;strong&gt;read access&lt;/strong&gt; to the Web Document Root and some &lt;strong&gt;write&lt;/strong&gt; rights on the &lt;code&gt;sites/default/files&lt;/code&gt; directory.&lt;/p&gt;

&lt;p&gt;Here is a list of commands that should do the trick, could certainly be done in other ways (like more restrictive, I'll update it one day).&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt; &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;apply ownership&amp;quot;&lt;/span&gt;
 chown -R root:www-data /var/www/makina/mydrupal/*
 &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;default directories read rights&amp;quot;&lt;/span&gt;
 find /var/www/makina/mydrupal/www &lt;span class=&quot;se&quot;&gt;\(&lt;/span&gt; -type d -wholename &lt;span class=&quot;s2&quot;&gt;&amp;quot;/var/www/makina/mydrupal/www/sites/default/files&amp;quot;&lt;/span&gt; -prune &lt;span class=&quot;se&quot;&gt;\)&lt;/span&gt; -o -type d -exec chmod 2750 &lt;span class=&quot;o&quot;&gt;{}&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\;&lt;/span&gt;
 &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;default files read rights&amp;quot;&lt;/span&gt;
 find /var/www/makina/mydrupal/www  &lt;span class=&quot;se&quot;&gt;\(&lt;/span&gt; -type f -wholename &lt;span class=&quot;s2&quot;&gt;&amp;quot;/var/www/makina/mydrupal/www/sites/default/files&amp;quot;&lt;/span&gt; -prune &lt;span class=&quot;se&quot;&gt;\)&lt;/span&gt; -o -type f -exec chmod 0640 &lt;span class=&quot;o&quot;&gt;{}&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\;&lt;/span&gt;
 &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;directories write rights&amp;quot;&lt;/span&gt;
 find /var/www/makina/mydrupal/www/sites/default/files -type d -exec chmod 2770 &lt;span class=&quot;o&quot;&gt;{}&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\;&lt;/span&gt;
 &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;files write rights&amp;quot;&lt;/span&gt;
 find /var/www/makina/mydrupal/www/sites/default/files -type f -exec chmod 0660 &lt;span class=&quot;o&quot;&gt;{}&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\;&lt;/span&gt;
 chown root:www-data /var/www/makina/mydrupal/
 chown root:www-data /var/www/makina/mydrupal/var/fcgi
 chmod 2770 /var/www/makina/mydrupal/var/fcgi
 chown -R root:www-data /var/www/makina/mydrupal/var/tmp
 chmod 2770 /var/www/makina/mydrupal/var/tmp
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;Starting &amp;amp; Stoping Apache &amp;amp; PHP&lt;/h3&gt;

&lt;p&gt;Remember that php-fpm is not anymore linked to apache, so you'have an init script for php as well.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt;    /etc/init.d/php5-fpm &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;start|stop&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Exactly like mysql or apache2. You may check that the /etc/rc*/ files are there for the startup scripts&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt;    ls -alh /etc/rc*.d/???php5-fpm
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Final steps, Database &amp;amp; Settings&lt;/h2&gt;

&lt;p&gt;No surprises here, I'm quite sure you know how to perform all theses steps. But that's a step by step, so here are the last ones&lt;/p&gt;

&lt;p&gt;Well, in fact you may have one surprise in the settings.php&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt;    apt-get install mysql-server-5.1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Create database and user for application (alter the default passwords and users of course):&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;sql&quot;&gt;    &lt;span class=&quot;n&quot;&gt;mysql&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;u&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;root&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;DATABASE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mydrupal&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;CHARACTER&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;SET&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;utf8&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;COLLATE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;utf8_bin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;GRANT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;ALL&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;PRIVILEGES&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;ON&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mydrupal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;TO&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mydrupaluser&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;localhost&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;IDENTIFIED&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;BY&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;mydrupaluserpassord&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FLUSH&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;PRIVILEGES&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Alter application conf to use real database user and paths. For drupal it's usually in &lt;code&gt;[project root]/www/sites/default/settings.php&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Import the project dump if it's already available, or get to the &lt;code&gt;http://mydrupal.example.com/install.php&lt;/code&gt; url (or use &lt;code&gt;drush install&lt;/code&gt;).&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt;   mysql -u mydrupaluser --password&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;mydrupaluserpassord&amp;quot;&lt;/span&gt; --character-set&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;utf8 mydrupal &amp;lt; /var/www/makina/mydrupal/sql/dump.sql
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;Where's my surprise in the settings.php?&lt;/h3&gt;

&lt;p&gt;Yes, if you defined previously the temporary directory in the settings file, which is a very good place to define it
(I'm not a very good fan of configuration stored in database), you may have something like:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;php&quot;&gt;&lt;span class=&quot;x&quot;&gt;    $conf[&amp;#39;file_directory_temp&amp;#39;] = &amp;#39;/var/www/makina/mydrupal/var/tmp&amp;#39;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Or even&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;php&quot;&gt;&lt;span class=&quot;x&quot;&gt;    $conf[&amp;#39;file_directory_temp&amp;#39;] = &amp;#39;/tmp&amp;#39;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;But now we're in a chroot, the new path is:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;php&quot;&gt;&lt;span class=&quot;x&quot;&gt;    $conf[&amp;#39;file_directory_temp&amp;#39;] = &amp;#39;/var/tmp&amp;#39;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;And the same thing apply for any filesystem related setting in drupal (but you should not have a lot of them).&lt;/p&gt;

&lt;h2&gt;Update. Avoid chroot symlink hack with doc_root php setting?&lt;/h2&gt;

&lt;p&gt;A very nice backtrack.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://auntitled.blogspot.com/2011/10/chroot-php-fpm-and-apache.html&quot;&gt;http://auntitled.blogspot.com/2011/10/chroot-php-fpm-and-apache.html&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The autor finally found a useful usage of php &lt;a href=&quot;http://www.php.net/manual/en/ini.core.php#ini.doc-root&quot;&gt;doc_root&lt;/a&gt; setting and explain it could help avoiding the fake document root symnlink inside the chroot.&lt;/p&gt;

&lt;h3&gt;Closely Related articles&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;/Drupal/English/2013/05/16/Warning_chrooted_php_fpm_and_apc/&quot;&gt;Warning Chrooted php-fpm and Apc with multiple pools&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/Drupal/English/2011/09/01/better_rewrite_rules_for_drupal/&quot;&gt;Better Rewrite Rules for Drupal&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/Drupal/English/2011/09/02/Tune_your_php_settings_for_drupal/&quot;&gt;Tune your php settings for Drupal&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

</description>
				<published>2011-09-03 00:00:00 +0200</published>
				<link>http://regilero.github.io/Drupal/English/2011/09/03/Install_drupal_in_php_fpm_fastcgi_and_apache_chroot/</link>
			</item>
		
			<item>
				<title>Tune your php settings for Drupal</title>
				<description>&lt;p&gt;In this article we'll study how to tune the &lt;code&gt;php.ini&lt;/code&gt; settings for a Drupal host,
how to manage variations of theses settings &lt;strong&gt;per Virtalhosts&lt;/strong&gt;,
and of course how to do it without the ugly &lt;code&gt;.htaccess&lt;/code&gt; file.&lt;/p&gt;

&lt;h2&gt;Get a Drupal VirtualHost&lt;/h2&gt;

&lt;p&gt;Why am I saying &lt;code&gt;.htaccess&lt;/code&gt; files are ugly and you should have a VirtualHost for your Drupal?&lt;br/&gt;
Because &lt;code&gt;.htaccess&lt;/code&gt; files are slowing down your Apache, and everything set by Drupal in
the .htaccess can be safely put in the VirtualHost. &lt;br/&gt;
Check &lt;a href=&quot;/Drupal/English/2011/09/01/better_rewrite_rules_for_drupal/&quot;&gt;this previous article&lt;/a&gt; for details
(first part is about removing the .htaccess).&lt;/p&gt;

&lt;p&gt;Now having a VirtualHost you can handle several parallel Drupal installations on the same host
and you will be able to securize this by adding restrictions on the available directories
for each separate VirtualHost.&lt;br/&gt;
We will see that we will also be able to handle &lt;strong&gt;different PHP configurations&lt;/strong&gt; for each VirtualHost.&lt;/p&gt;

&lt;h2&gt;Several configurations? But I only have one php.ini!&lt;/h2&gt;

&lt;p&gt;Yes.&lt;/p&gt;

&lt;p&gt;Only one php.ini is loaded by PHP, but you can alter the PHP settings in apache configuration
by using &lt;code&gt;php_value&lt;/code&gt;, &lt;code&gt;php_admin_value&lt;/code&gt;, &lt;code&gt;php_flag&lt;/code&gt; and &lt;code&gt;php_admin_flag&lt;/code&gt; directives.&lt;br/&gt;
You could also alter the PHP settings in PHP code with &lt;code&gt;ini_set()&lt;/code&gt; instructions.
But the &lt;code&gt;php_admin_value&lt;/code&gt; and php_admin&lt;em&gt;&lt;em&gt;flag differs from the simpliest one by the fact any
setting set with the **&quot;&lt;/em&gt;admin&lt;/em&gt;&quot;&lt;strong&gt; commands &lt;/strong&gt;cannot be overriden** by any &lt;code&gt;ini_set()&lt;/code&gt; call in the code.&lt;/p&gt;

&lt;p&gt;So this means you will be able to set the PHP settings to the value you need for each VirtualHost,
just think about the &lt;code&gt;open_basedir&lt;/code&gt; restriction, each Drupal installation can have an &lt;code&gt;open_basedir&lt;/code&gt;
that forbids any access to another parallel Drupal website on the same host.&lt;/p&gt;

&lt;h2&gt;What are the PHP settings enforced by default Drupal .htaccess?&lt;/h2&gt;

&lt;p&gt;First let's see what is the default php settings that Drupal is asking for in Drupal6:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;ifmodule&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;mod_php5.c=&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
   &lt;span class=&quot;nb&quot;&gt;php_value&lt;/span&gt; magic_quotes_gpc                &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;
   &lt;span class=&quot;nb&quot;&gt;php_value&lt;/span&gt; register_globals                &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;
   &lt;span class=&quot;nb&quot;&gt;php_value&lt;/span&gt; session.auto_start              &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;
   &lt;span class=&quot;nb&quot;&gt;php_value&lt;/span&gt; mbstring.http_input             pass
   &lt;span class=&quot;nb&quot;&gt;php_value&lt;/span&gt; mbstring.http_output            pass
   &lt;span class=&quot;nb&quot;&gt;php_value&lt;/span&gt; mbstring.encoding_translation   &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;/ifmodule&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;And in Drupal7:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;ifmodule&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;mod_php5.c=&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
   &lt;span class=&quot;nb&quot;&gt;php_flag&lt;/span&gt; magic_quotes_gpc                 &lt;span class=&quot;k&quot;&gt;off&lt;/span&gt;
   &lt;span class=&quot;nb&quot;&gt;php_flag&lt;/span&gt; magic_quotes_sybase              &lt;span class=&quot;k&quot;&gt;off&lt;/span&gt;
   &lt;span class=&quot;nb&quot;&gt;php_flag&lt;/span&gt; register_globals                 &lt;span class=&quot;k&quot;&gt;off&lt;/span&gt;
   &lt;span class=&quot;nb&quot;&gt;php_flag&lt;/span&gt; session.auto_start               &lt;span class=&quot;k&quot;&gt;off&lt;/span&gt;
   &lt;span class=&quot;nb&quot;&gt;php_value&lt;/span&gt; mbstring.http_input             pass
   &lt;span class=&quot;nb&quot;&gt;php_value&lt;/span&gt; mbstring.http_output            pass
   &lt;span class=&quot;nb&quot;&gt;php_flag&lt;/span&gt; mbstring.encoding_translation    &lt;span class=&quot;k&quot;&gt;off&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;/ifmodule&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Not much differences. &lt;br/&gt;
The &lt;code&gt;0&lt;/code&gt; becames &lt;code&gt;off&lt;/code&gt;, that mean the same, except if you use php &lt;code&gt;ini_get()&lt;/code&gt; functions in your scripts
(&lt;a href=&quot;http://www.makina-corpus.org/blog/how-retrieve-boolean-values-php-s-configuration&quot;&gt;see here how bad is ini_get()&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;Drupal7 adds the &lt;code&gt;magic_quotes_sybase&lt;/code&gt; de-activation, which is a good rule that you can backport to Drupal6,
as if this setting is on, then magic quoting will happen.&lt;br/&gt;
Magic quotes are bad, http input stream is not the right place to escape strings for &lt;code&gt;SQL&lt;/code&gt;,
you need to do it before any SQL input, but this is the only right place
(so quite dep in the code, and magic quoting does not protect you as much as database provided escape functions),
else you will even be magic-quoting the uploaded files...&lt;/p&gt;

&lt;p&gt;&lt;code&gt;register_globals&lt;/code&gt; is &lt;code&gt;off&lt;/code&gt;, very dangerous setting when it's On.&lt;br/&gt;
For mbstrings settings I'll trust Drupal when they say they want it this way.&lt;/p&gt;

&lt;p&gt;But that's a quite short php tuning.&lt;/p&gt;

&lt;h2&gt;Where to put the files?&lt;/h2&gt;

&lt;p&gt;So we said we wanted several Drupal, running in parallel projects
(We're not talking about Drupal multi-site handling, which is another problem,
we're talking about Drupal projects). And we wanted to protect each one from the others.&lt;br/&gt;
The things to secure are:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;temporary files&lt;/strong&gt; (by default everyone share the same path in &lt;code&gt;/tmp&lt;/code&gt;, not very clean, the less secure application you run with this apache will give you the security level of this &lt;code&gt;/tmp&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;uploaded files&lt;/strong&gt; while they're uploaded&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;filesystem&lt;/strong&gt; access, by default any PHP application as the power to read any file the web user can see&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;But in term of projects we would certainly also like to have configuration files,
administrative scripts, and documentations, maybe logs as well.&lt;/p&gt;

&lt;p&gt;The project tree can be a quite long debate, so I'll give you one as an example,
then the settings in this article will use this tree, but you can alter it I wont cry.
So for a project named &lt;strong&gt;mydrupal&lt;/strong&gt; accessed via &lt;strong&gt;http://mydrupal.example.com&lt;/strong&gt;
(use your &lt;code&gt;/etc/hosts&lt;/code&gt; to map it to &lt;code&gt;127.0.0.1&lt;/code&gt; in dev):&lt;/p&gt;

&lt;pre&gt;
 -/
  \-var/
    \-www/
      \-mydrupal/
         # project root
        \-etc/
          # here goes the configuration files, like for example you Apache Virtualhost
          # linked in /etc/apache2/sites-available/42-mydrupal.example.com (debian)
        \-www/
          # here goes Drupal sources, this is the Web Directory Root (DocumentRoot)
           \-sites
             \-default
               # here is Drupal settings.php
                \-files
             \-all
                \-files
        \-bin/
          # here goes your managment scripts
        \-doc/
          # project documentation
        \-var/
          \-log/
            # apache logs for this project.
            # Directory may be linked to /var/log/apache2/mydrupal.example.com
            # for log rotation, or use cronolog
          \-tmp/
            # this is the temporary directory for that project
&lt;/pre&gt;


&lt;p&gt;You may need to write some scripts to maintain ownership and rights on this tree. Hee are some hints:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;the web user (www-data) needs read access on all files on the &lt;code&gt;/var/www/mydrupal/www&lt;/code&gt; subtree&lt;/li&gt;
&lt;li&gt;the web user needs the &quot;x&quot; right on each parent directory (&lt;code&gt;/var/www/mydrupal&lt;/code&gt;, &lt;code&gt;/var/www/&lt;/code&gt;, &lt;code&gt;/var&lt;/code&gt;)&lt;/li&gt;
&lt;li&gt;default rights for directories should be &quot;2775&quot; with ownserhip or group to the web user&lt;/li&gt;
&lt;li&gt;default rights for files should be &quot;0664&quot; with ownserhip or group to the web user&lt;/li&gt;
&lt;li&gt;on some directories the web user needs &lt;strong&gt;write access&lt;/strong&gt;, the files subdirectories under &lt;code&gt;&quot;/var/www/mydrupal/www/sites/[all|default|foo]&quot;&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;for a &lt;em&gt;tmp&lt;/em&gt; directory you can use &lt;code&gt;&quot;chmod 1777&quot;&lt;/code&gt;, the &lt;strong&gt;1&lt;/strong&gt; is important, else use &lt;code&gt;&quot;chmod 2775&quot;&lt;/code&gt; with &lt;code&gt;&quot;www-data:www-data&quot;&lt;/code&gt; ownership.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Usually chmod command use 3 digits, when using 4 the first one as some meanings,
the &quot;2&quot; for directories means that new files and directories created there will inherit the user and group
of the directory, this is really important for the &lt;code&gt;&quot;files/&quot;&lt;/code&gt; subdirectory where Drupal is sometimes
creating new subdirectories.&lt;/p&gt;

&lt;p&gt;To use a different temporary directory than &lt;code&gt;/tmp&lt;/code&gt; we'll have to alter the Drupal configuration and some of
the PHP settings. For Drupal settings you simply need to add this line in the settings.php file:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;php&quot;&gt;&lt;span class=&quot;x&quot;&gt;# Drupal 6&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;$conf[&amp;#39;file_directory_temp&amp;#39;] = &amp;#39;/var/www/mydrupal/var/tmp&amp;#39;;&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;# Drupal 7&lt;/span&gt;
&lt;span class=&quot;x&quot;&gt;$conf[&amp;#39;file_temporary_path&amp;#39;] = &amp;#39;/var/www/mydrupal/var/tmp&amp;#39;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Let's add some PHP settings&lt;/h2&gt;

&lt;p&gt;So we keep the existing settings (take the Drupal7 version). And now we add some more.&lt;/p&gt;

&lt;h4&gt;Upload&lt;/h4&gt;

&lt;p&gt;First we'll put some default settings for File upload management:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;nb&quot;&gt;php_admin_flag&lt;/span&gt;  file_uploads            &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; upload_tmp_dir          &lt;span class=&quot;s2&quot;&gt;&amp;quot;/var/www/mydrupal/var/tmp&amp;quot;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#Maximum allowed size for uploaded files.&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; upload_max_filesize     &lt;span class=&quot;s2&quot;&gt;&amp;quot;50M&amp;quot;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; max_input_time          &lt;span class=&quot;m&quot;&gt;120&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; post_max_size           &lt;span class=&quot;s2&quot;&gt;&amp;quot;50M&amp;quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;We are using our new temporary directory,
limit the size of any POST request to 50M,
same for the uploaded files,
and allow 2 minutes for the client to push these 50M before disconnecting.&lt;/p&gt;

&lt;h4&gt;Logs&lt;/h4&gt;

&lt;p&gt;Now let's handle PHP logs, first if we are not in development mode,
we'll prevent Drupal from allowing messages to be outputed.
If you grep &lt;code&gt;display_errors&lt;/code&gt; in Drupal source code you'll see that the administrator
can allow error output on the page, very dangerous in production, with an &lt;code&gt;&quot;admin_value&quot;&lt;/code&gt;
here it won't be allowed.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; display_errors          &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; display_startup_errors  &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; html_errors             &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; log_errors              &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; define_syslog_variables &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#E_ALL &amp;amp; ~E_NOTICE -&amp;gt; 6135&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#E_ALL -&amp;gt; 6143&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#E_ALL^E_STRICT -&amp;gt; 8191&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# really all -&amp;gt; -1&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_value&lt;/span&gt; error_reporting               &lt;span class=&quot;m&quot;&gt;6135&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;You cannot use &lt;code&gt;E_ALL&lt;/code&gt; notation, we're not in PHP execution environment and the PHP defines
are not defined, so we need to use the numerical value of theses options&lt;/p&gt;

&lt;h4&gt;Security&lt;/h4&gt;

&lt;p&gt;Here are the most important settings, first I'll list them:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; open_basedir    &lt;span class=&quot;s2&quot;&gt;&amp;quot;.:/var/www/mydrupal/www:/var/www/mydrupal/var/tmp:/usr/share/php/:/usr/share/php5/&amp;quot;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_value&lt;/span&gt;       include_path    &lt;span class=&quot;s2&quot;&gt;&amp;quot;.:/usr/lib/php5/20090626+lfs:/var/www/mydrupal/www:/var/www/mydrupal/www/include:/usr/share/php/:/usr/share/php5/&amp;quot;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; expose_php      &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# you may need to allow url_fopen, but by default we dissallow it&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; allow_url_fopen &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# Do not show detailled headers with apache, apache modules, and php version&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; expose_php      &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# safe_mode is more buggy than no safe mode&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; safe_mode       &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Now, let's explain them from the end to the top.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;&quot;safe_mode&quot;&lt;/strong&gt; is not activated, using the PHP safe_mode is in fact not a &quot;safe&quot; thing and as proven more security problems
than not using it, it will soon be a deprecated option (well, it is deprecated in PHP 5.3).&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;&quot;expose_php&quot;&lt;/strong&gt; is a not-known-enough PHP setting that set a default header in the HTTP answer if you
do not disable it. In my Apache Virtualhost I've been reading the security file,
and I've set the &lt;code&gt;&quot;ServerToken Prod&quot;&lt;/code&gt; setting to avoid disclaiming Apache version in the HTTP headers,
cool, it's only saying &quot;Apache&quot; and not &quot;Apache.2.2 (debian ...).&lt;br/&gt;
Now if I do not set this expose_php php settings PHP will add this awfull header:&lt;/p&gt;

&lt;pre&gt;
    X-Powered-By: PHP/5.2.10-2ubuntu6.10
&lt;/pre&gt;


&lt;p&gt;Funny thing the official documentation say you can only alter it in php.ini, well it works in a VirtualHost&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;&quot;allow_url_fopen&quot;&lt;/strong&gt;, you may need to allow this if you need to perform includes to some other websites.&lt;br/&gt;
By default I prefer disallowing this setting, as it's the starting point of a lot of security attacks
(bad filtered includes for example).&lt;br/&gt;
When developpers really needs it, they need to buy some beers if they want this setting altered.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;`&quot;include_path&quot;&lt;/strong&gt; this is not complelty related to security (but ùaitain it close to open_basedir, easier to maintain).
It's the path where PHP will search when you gives it a filename to include which is not &lt;strong&gt;absolute&lt;/strong&gt;.&lt;br/&gt;
You should keep this list quite short. So having your project path here, and not the others,
is quite important, do not forget the dot, it means the &lt;strong&gt;&quot;current directory&quot;&lt;/strong&gt;.&lt;br/&gt;
And if you use PHP extensions (like, maybe, apc) you may need to help includes in the places
where these common extensions are shared.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;&quot;open_basedir&quot;&lt;/strong&gt; this is &lt;strong&gt;the most important setting&lt;/strong&gt;. And maybe the one giving you some errors after activation.
PHP will not be able to work in a directory which is not listed there.&lt;br/&gt;
So you'll need your project web directory (the &lt;code&gt;www&lt;/code&gt; inside the project) but also the temporary directory
(not &lt;code&gt;/tmp&lt;/code&gt; for us) and the shared libraries directories. &lt;br/&gt;
The important thing is to prevent inclusion of your OS's &lt;code&gt;/etc&lt;/code&gt; and of other projects files (like with &lt;code&gt;/tmp&lt;/code&gt;)&lt;/p&gt;

&lt;h4&gt;Some other useful things&lt;/h4&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;c&quot;&gt;# Maximum amount of time each script may spend parsing request data&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_value&lt;/span&gt; max_execution_time            &lt;span class=&quot;s2&quot;&gt;&amp;quot;300&amp;quot;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# Maximum amount of memory a script may consume&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_value&lt;/span&gt; memory_limit                  &lt;span class=&quot;s2&quot;&gt;&amp;quot;32M&amp;quot;&lt;/span&gt;
 
&lt;span class=&quot;c&quot;&gt;# Sessions: IMPORTANT reactivate garbage collector on Debian!!!&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_value&lt;/span&gt; session.gc_maxlifetime        &lt;span class=&quot;m&quot;&gt;3600&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; session.gc_probability  &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; session.gc_divisor      &lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;So here after 300s (4minutes) a PHP script will be killed.&lt;br/&gt;
Then we limit the memory usage of any Apache process running this website to 32M.&lt;br/&gt;
Some bad Drupal developpers will cry and ask for 128M, but, hey, who can buy 13Go of RAM just to handle
100 parallel HTTP requests?.&lt;br/&gt;
You may need to alter that for Drupal, which is an heavy RAM-eater. But you may also read my next article
about php-fpm (and ask Makina-Coprus for an audit, why the hell your Drupal needs 128M?)&lt;/p&gt;

&lt;p&gt;Notice that we've used &lt;strong&gt;&quot;php_value&quot;&lt;/strong&gt; and not &lt;strong&gt;&quot;php_admin_value&quot;&lt;/strong&gt; for some of these settings,
it means that for a given Drupal method, for a given HTTP request, deep in the code, you may use &lt;strong&gt;ini_set()&lt;/strong&gt;
functions to alter theses settings (like asking for 128M of RAM for one request or allowing for more time).&lt;/p&gt;

&lt;p&gt;Last point as a comment which says all, on Debian the PHP garbage collector is inactivated
(to use a debian script cleaning the &lt;code&gt;/var/lib/php5&lt;/code&gt; session directory).&lt;br/&gt;
Problem, Drupal is not using PHP default session management, and needs the garbage collector
call to perform session cleanups. If you forgot that, you may get a session table in Drupal
growing until your &lt;code&gt;/var/lib/mysql&lt;/code&gt; partition gets full (and this may let you in a quite bad
situation -- hopefully the drupal server will maybe start to be quite slow when requesting
the millions of rows session table and you will see it before)&lt;/p&gt;

&lt;h3&gt;Apc and Memcache settings?&lt;/h3&gt;

&lt;p&gt;Want some more? Here are some settings for classical APC or memchache usage (via php-memcache, not php-memcached).&lt;/p&gt;

&lt;p&gt;For APC some settings musn't be altered on each VirtualHost,
they're shared, so they should be global to the Apache server. &lt;br/&gt;
Alter theses settings in the real php.ini or /etc/php5/conf.d/apc.ini file:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;c&quot;&gt;# Shared Memory&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# These settings MUS&amp;#39;NT be ALTERED ON A PER-VIRTUALHOST basis&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# BUT THEY&amp;#39;RE IMPORTANT, by default you&amp;#39;ll get only 30M for the whole&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# opcode+user cache, very short, very dangerous (apc emptying cache when full)&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# SO YOU MUST ALTER DEFAULT APC CONFIGURATION on SHARED MEMORY&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;apc&lt;/span&gt;.&lt;span class=&quot;err&quot;&gt;shm_segments=1&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;apc&lt;/span&gt;.&lt;span class=&quot;err&quot;&gt;shm_size=128&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;apc&lt;/span&gt;.&lt;span class=&quot;err&quot;&gt;mmap_file_mask=/apc&lt;/span&gt;.&lt;span class=&quot;err&quot;&gt;shm&lt;/span&gt;.&lt;span class=&quot;nb&quot;&gt;XXXXXX&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Here we ask for 128M of shared memory.&lt;br/&gt;
The default is 30M because most OS will not allow you to ask for 128M or 256M.&lt;br/&gt;
To allow 128M Put in &lt;code&gt;/etc/sysctl.conf&lt;/code&gt; at least theses numbers (and load them in sysctl):&lt;/p&gt;

&lt;pre&gt;
kernel.shmmax=134217728
kernel.shmall=2097152
&lt;/pre&gt;


&lt;p&gt;Now for the Virtualhost here are some settings:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;nb&quot;&gt;php_admin_flag&lt;/span&gt;  apc.enabled                     &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; 
&lt;span class=&quot;c&quot;&gt;# file upload progress bar available&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; apc.rfc1867                     &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;
 
&lt;span class=&quot;c&quot;&gt;# ON a VirtualHost basis we can tune theses APC settings&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# want to gain speed? ------------------&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# Optimisation of include/require_once calls&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; apc.include_once_override       &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# transform paths in absolute ones (no effect if apc.stat is not 0), files from stream wrappers (extended includes)&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# won&amp;#39;t be cached if this is activated as they cannot be used with php&amp;#39;s realpath()&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_flag&lt;/span&gt;  apc.canonicalize                &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# In production set it to 0, then file changes won&amp;#39;t be observed before apache is restarted,&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# significant boost, else file time is stated at each access (needed at 1 in dev)&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_flag&lt;/span&gt; apc.stat                         &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# avoid problems with rsync or svn not modifying mtime but only ctime&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# so if you&amp;#39;re in production set this to 1, like for the previous one&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_flag&lt;/span&gt; apc.stat_ctime                   &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;
 
&lt;span class=&quot;c&quot;&gt;# deprecated option: apc.optimization not available anymore&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#php_admin_flag apc.optimization               0&lt;/span&gt;
 
&lt;span class=&quot;c&quot;&gt;# indication on number of files (ZF=1300, nude Drupal 7=1000)&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; apc.num_files_hint              &lt;span class=&quot;s2&quot;&gt;&amp;quot;2000&amp;quot;&lt;/span&gt;
 
&lt;span class=&quot;c&quot;&gt;# indication on the number of cache variables&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; apc.user_entries_hint           &lt;span class=&quot;s2&quot;&gt;&amp;quot;0&amp;quot;&lt;/span&gt;
 
&lt;span class=&quot;c&quot;&gt;# cache lifetime managmenent ----------------&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# time (s) we can stay on the cache even when the cache is full -- Cache full count --&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# that means Garbage Collector is never inactivating theses datas before this time is over&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# &amp;gt;0 -&amp;gt; old data could stay in the cache while new data want&amp;#39;s to come, if no data is deprecated&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# 7200 -&amp;gt; entries older than 2 hours will be thrown to make some place&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# 0 -&amp;gt; emptying full cache when full&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; apc.ttl                         &lt;span class=&quot;s2&quot;&gt;&amp;quot;3600&amp;quot;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; apc.user_ttl                    &lt;span class=&quot;s2&quot;&gt;&amp;quot;3600&amp;quot;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# this one is the same but you should note this this prevent Garbage collecting after each source change.&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; apc.gc_ttl                      &lt;span class=&quot;s2&quot;&gt;&amp;quot;3600&amp;quot;&lt;/span&gt;
 
&lt;span class=&quot;c&quot;&gt;# What to cache ? ----------------------------&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# could be used to prevent some caching on specific files&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# but it&amp;#39;s better to cache often used files, isn&amp;#39;t it? at least in production&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# php_admin_value apc.filters                     &amp;quot;-config.php-.ini&amp;quot;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#default to 1M, files bigger than that won&amp;#39;t be cached&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; apc.max_file_size               &lt;span class=&quot;s2&quot;&gt;&amp;quot;5M&amp;quot;&lt;/span&gt;
 
&lt;span class=&quot;c&quot;&gt;# various things -------------------------------&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# only one process caching a same file (beter than apc.slam_defense)&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_flag&lt;/span&gt; apc.write_lock                   &lt;span class=&quot;k&quot;&gt;On&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# prevents caching half written files (by cp for example) by waiting x seconds for new files caching. set it to 0 if using only rsync or mv&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; apc.apc.file_update_protection  &lt;span class=&quot;s2&quot;&gt;&amp;quot;2&amp;quot;&lt;/span&gt;
 
&lt;span class=&quot;c&quot;&gt;# newest versions of APC only&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# optimisations from Facebook, adding a lazy loding capabilities, so you can parse a lot of files&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# and only used things are cached&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# need to be tested&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# php_admin_value apc.lazy_functions               1&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# php_admin_value apc.lazy_classes                 1&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;As stated in the comments, in production you should set the apc.stat &amp;amp; apc.stat_ctime flags to 1.
It will be a lot faster, but APC will not even try to see if the file has been updated on disk.&lt;/p&gt;

&lt;p&gt;And for memcache here are some default settings that you could use:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;c&quot;&gt;# Memcache settings (php-memcache, not php-memcached)&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# should we try other servers?&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; memcache.allow_failover        &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; memcache.max_failover_attempts &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# how many copies of the session on different servers (to avoid loosing session on server crash) ?&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; memcache.session_redundancy    &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# may be the same behavior but for all data&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; memcache.redundancy            &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# protocol, undocumented, don&amp;#39;t kwown what is available instead of ascii&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; memcache.protocol              ascii
&lt;span class=&quot;c&quot;&gt;# Data will be transferred in chunks of this size(8192 by default, or 32768 since v3.0.0)&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; memcache.chunk_size            &lt;span class=&quot;m&quot;&gt;32768&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# default port to connect memcached&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; memcache.default_port          &lt;span class=&quot;m&quot;&gt;11211&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# consistent is better than default, avoid hash keys being remaped when a new server join&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; memcache.hash_strategy         consistent
&lt;span class=&quot;c&quot;&gt;# hash can be crc32 or fnv&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; memcache.hash_function         crc32
&lt;span class=&quot;c&quot;&gt;# undocumented&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; memcache.compress_threshold    &lt;span class=&quot;m&quot;&gt;2000&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# undocumented ...&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; memcache.maxreclevel           &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; memcache.maxfiles              &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; memcache.archivememlim         &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; memcache.maxfilesize           &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; memcache.maxratio              &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;
 
&lt;span class=&quot;c&quot;&gt;# session management by memcache.&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# needs memcache &amp;gt; 3.0.4 to get session locking, else you may have&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# some race conditions with ajax or any parallel query execution in&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# the same requests&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# Here we use the not-yet-official session proxy drupal module to handle this&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# you may check also with memcached module&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; session.save_handler            memcache
&lt;span class=&quot;nb&quot;&gt;php_admin_value&lt;/span&gt; session.save_path               &lt;span class=&quot;s2&quot;&gt;&amp;quot;tcp://127.0.0.1:11211&amp;quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;Closely Related articles&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;/Drupal/English/2011/09/01/better_rewrite_rules_for_drupal/&quot;&gt;Better Rewrite Rules for Drupal&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/Drupal/English/2011/09/03/Install_drupal_in_php_fpm_fastcgi_and_apache_chroot/&quot;&gt;Drupal with Apache &amp;amp; chrooted php-fpm&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

</description>
				<published>2011-09-02 00:00:00 +0200</published>
				<link>http://regilero.github.io/Drupal/English/2011/09/02/Tune_your_php_settings_for_drupal/</link>
			</item>
		
			<item>
				<title>Better rewriteRules for Drupal</title>
				<description>&lt;p&gt;Drupal comes with a default set of &lt;code&gt;Rewrite Rules&lt;/code&gt; in the &lt;code&gt;.htaccess&lt;/code&gt; file given by the project.&lt;/p&gt;

&lt;p&gt;In this article I'll try to provides some recipes for an enhanced mod-rewrite set.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;getting rid of .htaccess&lt;/li&gt;
&lt;li&gt;forbid usage of direct requests to &lt;code&gt;index.php?q=foo&lt;/code&gt; (when clean url is activated)&lt;/li&gt;
&lt;li&gt;forbid usage of 'new' unwanted PHP scripts appearing in the website (attackers?)&lt;/li&gt;
&lt;/ul&gt;


&lt;h3&gt;Oh my God, a .htaccess!&lt;/h3&gt;

&lt;p&gt;So this will be the first thing, a &lt;strong&gt;must-do&lt;/strong&gt;. Drupal Apache configuration is on a &lt;code&gt;.htaccess&lt;/code&gt; file, and there is a reason for that.
On most places you wont be allowed to alter apache configuration, as &lt;strong&gt;you do not own the server&lt;/strong&gt;, and the &lt;code&gt;.htaccess&lt;/code&gt; file is the
only way for this PHP application to set some apache Directives.&lt;br/&gt;
But let's say this is &lt;strong&gt;your&lt;/strong&gt; server, you have &lt;strong&gt;access to Apache configuration&lt;/strong&gt;, then a &lt;code&gt;.htaccess&lt;/code&gt; is the &lt;strong&gt;worst place to put
some configurations details&lt;/strong&gt;.&lt;br/&gt;
For each received requests Apache must check existence of &lt;code&gt;.htaccess&lt;/code&gt; files on the requested file directory and on all the parent
directories, this means a lot of file access, so it's quite &lt;strong&gt;slow&lt;/strong&gt;. If you own the server you do not need or want this slowdown.&lt;/p&gt;

&lt;p&gt;The rule is quite simple &lt;strong&gt;&quot;Everything found in a &lt;code&gt;.htaccess&lt;/code&gt; in directory &lt;code&gt;/this/is/my/dir&lt;/code&gt; can be set in a &lt;code&gt;&amp;lt;Directory /this/is/my/dir&amp;gt;&amp;lt;/Directory&amp;gt;&lt;/code&gt;
section in an apache Virtualhost or global configuration.&quot;&lt;/strong&gt;.&lt;br/&gt;
So first create your &lt;strong&gt;VirtualHost&lt;/strong&gt; for this Drupal website (please do not use global configuration,
you do not need to share directives for all your websites). Then we'll make 2 things:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;prevent the read of any &lt;code&gt;.htaccess&lt;/code&gt; from the filesystem root, so for all the descendant of &lt;code&gt;/&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;transfer the &lt;code&gt;.htaccess&lt;/code&gt; content in a &lt;code&gt;Directory&lt;/code&gt; directive&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;For the first thing simply add this (wel I've added the &lt;code&gt;.svn&lt;/code&gt; and &lt;code&gt;.git&lt;/code&gt; things as well):&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;Directory&lt;/span&gt;  &lt;span class=&quot;s&quot;&gt;/  &lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;Order&lt;/span&gt; deny,allow
    &lt;span class=&quot;nb&quot;&gt;deny&lt;/span&gt; from &lt;span class=&quot;k&quot;&gt;all&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;Options&lt;/span&gt; FollowSymLinks
    &lt;span class=&quot;c&quot;&gt;# PREVENT .htaccess reading&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;AllowOverride&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;None&lt;/span&gt;
 
    &lt;span class=&quot;c&quot;&gt;#.svn &amp;amp; .git directories must be avoided!!&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;RedirectMatch&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;404&lt;/span&gt; /\.svn(/|$)
    &lt;span class=&quot;nb&quot;&gt;RedirectMatch&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;404&lt;/span&gt; /\.git(/|$)
&lt;span class=&quot;nt&quot;&gt;&amp;lt;/Directory&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Notice that this does not concern the &lt;code&gt;'/'&lt;/code&gt; url (that would be &lt;code&gt;&amp;lt;Location /&amp;gt;&lt;/code&gt;) but the &lt;code&gt;'/'&lt;/code&gt; &lt;strong&gt;directory on the server&lt;/strong&gt;,
means the &lt;code&gt;'C:\'&lt;/code&gt; if you were a windows user.&lt;br/&gt;
&lt;code&gt;Location&lt;/code&gt; directives works on the url, &lt;code&gt;Directory&lt;/code&gt; directives works on the &lt;strong&gt;filesystem tree&lt;/strong&gt; (absolute path).&lt;/p&gt;

&lt;p&gt;Then add another &lt;code&gt;Directory&lt;/code&gt; directive, with the absolute path of your project web root
(this should be the same as the &lt;code&gt;DocumentRoot&lt;/code&gt; directive of this Virtualhost). And put inside the &lt;code&gt;.htaccess&lt;/code&gt; content.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;Directory&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;/var/www/mydrupalproject/www&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;#Order allow,deny&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;Allow&lt;/span&gt; from &lt;span class=&quot;k&quot;&gt;all&lt;/span&gt;
 
        &lt;span class=&quot;c&quot;&gt;# Follow symbolic links in this directory.&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;Options&lt;/span&gt; +FollowSymLinks -Indexes -Multiviews
         
        &lt;span class=&quot;c&quot;&gt;# Set the default handler.&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;DirectoryIndex&lt;/span&gt; index.php
 
        &lt;span class=&quot;c&quot;&gt;# Protect files and directories from prying eyes.&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;&amp;lt;FilesMatch&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&amp;quot;\.(engine|inc|info|install|make|module|profile|test|po|sh|.*sql|theme|tpl(\.php)?|xtmpl)$|^(\..*|Entries.*|Repository|Root|Tag|Template)$&amp;quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
          &lt;span class=&quot;nb&quot;&gt;Order&lt;/span&gt; allow,deny
        &lt;span class=&quot;nt&quot;&gt;&amp;lt;/FilesMatch&amp;gt;&lt;/span&gt;
         
        &lt;span class=&quot;c&quot;&gt;# Force simple error message for requests for non-existent favicon.ico.&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;&amp;lt;Files&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;favicon.ico&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
          &lt;span class=&quot;c&quot;&gt;# There is no end quote below, for compatibility with Apache 1.3.&lt;/span&gt;
          &lt;span class=&quot;nb&quot;&gt;ErrorDocument&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;404&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;&amp;quot;&lt;/span&gt;The requested file favicon.ico was not found.
        &lt;span class=&quot;nt&quot;&gt;&amp;lt;/Files&amp;gt;&lt;/span&gt;

        &lt;span class=&quot;nb&quot;&gt;etc&lt;/span&gt;
        (...)
         
&lt;span class=&quot;nt&quot;&gt;&amp;lt;/Directory&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;What does this as to do with &lt;strong&gt;mod-rewrite&lt;/strong&gt;? Well mod-rewrites behave quite the same in a &lt;code&gt;Directory&lt;/code&gt; directive and in a &lt;code&gt;.htaccess&lt;/code&gt;,
but faster here, and without the need of any &lt;code&gt;rewriteBase&lt;/code&gt; prefix.&lt;br/&gt;
You could even use mod-rewrite in the VirtualHost, in a global way, not in the &lt;code&gt;Directory&lt;/code&gt; section, that would even be faster.&lt;br/&gt;
But for Drupal rules we need the &lt;code&gt;SCRIPT_FILENAME&lt;/code&gt; and even using &lt;code&gt;LUA&lt;/code&gt; hacks on mod-rewrite we would not get a big gain.
So we'll keep the mod-rewrite rules in this Directory &lt;code&gt;/var/www/mydrupalproject/www&lt;/code&gt; section.&lt;/p&gt;

&lt;h3&gt;Let's check what are the default rules&lt;/h3&gt;

&lt;p&gt;So, if we do not care about the final mod-rewrite rules about gzip contents the main rules defined by Drupal are:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;c&quot;&gt;# always activate modRewrite on this directory&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# (do not forget it, even if you activated it on the Virtualhost)&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;RewriteEngine&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;on&lt;/span&gt;
 
&lt;span class=&quot;c&quot;&gt;# test the requested document is not a real file (like a css or js or even index.php or update.php)&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;RewriteCond&lt;/span&gt; %{REQUEST_FILENAME} !-f
 
&lt;span class=&quot;c&quot;&gt;# test the requested document is not a real directory&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;RewriteCond&lt;/span&gt; %{REQUEST_FILENAME} !-d
 
&lt;span class=&quot;c&quot;&gt;# test the requested document is not the favicon.ico (if you do not have one,&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# else it would have been catched by the first test). As we do not want to launch&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# the whole Drupal environment to imply return a 404 for the favicon.&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# you could see other apache rules for this with the File directive&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;RewriteCond&lt;/span&gt; %{REQUEST_URI} !=/favicon.ico
 
&lt;span class=&quot;c&quot;&gt;# still there, ok so take the whole request things (without the hostname) and give it to&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# the index.php file in the &amp;#39;q&amp;#39; GET argument. Then stop the rewriting process (L) and add any&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# GET argument after a ? in the request after this q argument (QSA)&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;RewriteRule&lt;/span&gt; ^(.*)$ index.php?q=$1 [L,QSA]
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;in Drupal 6. And Drupal7 added a new rule before this one which is:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;c&quot;&gt;# catch anything starting with a dot and return a 403 Forbidden&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;RewriteRule&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;(^|/)\.&amp;quot;&lt;/span&gt; - [F]
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The only goal of this rule is to avoid access on directory with a dot in the name (such as .git or .svn).&lt;br/&gt;
So if you used the &lt;code&gt;Redirect&lt;/code&gt; instructions on the root directory section as I did you do not need to activate this rule.
Always remember that simple &lt;code&gt;Redirect&lt;/code&gt;, &lt;code&gt;RedirectMatch&lt;/code&gt;, &lt;code&gt;Alias&lt;/code&gt;, &lt;code&gt;File&lt;/code&gt;, &lt;code&gt;FileMatch&lt;/code&gt; directives in Apache may perform really
faster than a &lt;code&gt;rewriteRule&lt;/code&gt;, check this official &lt;a href=&quot;http://httpd.apache.org/docs/current/rewrite/avoid.html&quot;&gt;&quot;when not to use mod-rewrite&quot; section&lt;/a&gt; in mod-rewrite documentation.&lt;/p&gt;

&lt;p&gt;So, this default &lt;strong&gt;'everything not existing to index.php'&lt;/strong&gt; rule does the job, of course.&lt;br/&gt;
When &lt;strong&gt;clean url&lt;/strong&gt; is not activated all your url are already in the &lt;code&gt;index.php?q=foo&lt;/code&gt; form and when clean url is activated
this rule make the transformation.&lt;/p&gt;

&lt;p&gt;But we still have some things to make better:&lt;/p&gt;

&lt;h2&gt;We have clean url, we want to force usage of clean urls&lt;/h2&gt;

&lt;p&gt;Now that you have activated clean url in Drupal (or you should, really).&lt;br/&gt;
Instead of requesting &lt;code&gt;http://example.com/index.php?q=/admin&lt;/code&gt; you can request &lt;code&gt;http://example.com/admin&lt;/code&gt;.&lt;br/&gt;
That's cool, and you could apply some url-based settings with your proxy or directly in apache,
let's say everything in &lt;code&gt;/admin&lt;/code&gt; or &lt;code&gt;/user&lt;/code&gt; is restricted to some IP only, etc.&lt;/p&gt;

&lt;p&gt;But &lt;strong&gt;nothings prevents a malicious user to use the direct &lt;code&gt;?q=foo&lt;/code&gt; form of the url&lt;/strong&gt;.
And if we're talking about security, access to &lt;code&gt;/admin&lt;/code&gt; could be done via several urls:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;http://example.com/index.php?q=/admin&lt;/li&gt;
&lt;li&gt;http://example.com/index.php?q=/////admin&lt;/li&gt;
&lt;li&gt;http://example.com/index.php? %71=/////%61dmin&lt;/li&gt;
&lt;li&gt;http://example.com/index.php?q=titi&amp;amp; %71=/////%61dmin&lt;/li&gt;
&lt;li&gt;...&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Benoit once tried to prevent all theses access with mod-rewrite in this &lt;a href=&quot;http://www.makina-corpus.org/blog/how-prevent-access-drupal-admin-url-apache-and-mod-rewrite&quot;&gt;article&lt;/a&gt;.
But a condition filtering theses requests, only on &lt;code&gt;/admin&lt;/code&gt;, would be (AFAIK):&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;nb&quot;&gt;RewriteCond&lt;/span&gt; %{QUERY_STRING} (^|&amp;amp;|%26|%20)(q|Q|%71|%51)(=|%3D)(/|%2F)+?(a|A|%61|%41)(d|D|%64|%44)(m|M|%6D|%4D)(i|I|%69|%49)(n|N|%6E|%4E)(/|%2F|&amp;amp;|%26|$) [NC]
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Which is pretty &lt;strong&gt;awfull&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;The &lt;strong&gt;real solution&lt;/strong&gt; is &lt;strong&gt;to prevent any direct via the &lt;code&gt;q=xxx&lt;/code&gt; argument&lt;/strong&gt;.&lt;br/&gt;
But that mean as well without restricting the real final Drupal request on &lt;code&gt;index.php&lt;/code&gt; with this &lt;code&gt;q=xxx&lt;/code&gt; argument. This is the way to do it:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;c&quot;&gt;# always activate modRewrite on this directory&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# (do not forget it, even if you activated it on the Virtualhost)&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;RewriteEngine&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;on&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;######### START RULE 1 ##################################&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# clean url is activated so ALL urls&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# MUST be accessed on /too/titi and MUSN&amp;#39;T be accessed on index.php?q=/toto/titi&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# main reason is that applying url rules (like restricting /admin access is far easier&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# in the clean url form than in parameter form&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# WARNING: need to alter any &amp;#39;q&amp;#39; parameter that could be present&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# on original QUERY_STRING (part after the ?), or something&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# like /toto?q=admin could become a q=toto&amp;amp;q=admin&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# which is finally a q=admin, so we do not restrict&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# this rule to index.php&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#########################################################&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# WARNING: must prevent real internal redirect of :&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# /toto/titi to q=/toto/titi (done in rule 2)&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# to be forbidden, so the rule apply only&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# if the rewriting process is starting&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;RewriteCond&lt;/span&gt; %{ENV:REDIRECT_STATUS} ^$
 
&lt;span class=&quot;c&quot;&gt;#detect non-blank QUERY_STRING (some parameters are present after the ?)&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# else we have nothing to fear about blank queries&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;RewriteCond&lt;/span&gt; %{QUERY_STRING} . [NC]
 
&lt;span class=&quot;c&quot;&gt;# we prevent any query with a q= parameter&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;RewriteCond&lt;/span&gt; %{QUERY_STRING} (^|&amp;amp;|%26|%20)(q|Q|%71|%51)(=|%3D). [NC]
 
&lt;span class=&quot;c&quot;&gt;# 403 FORBIDDEN !&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;RewriteRule&lt;/span&gt; .* - [F,L]
&lt;span class=&quot;c&quot;&gt;########## END RULE 1 ###################&lt;/span&gt;
 
&lt;span class=&quot;c&quot;&gt;########## START RULE 2 ###################&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# Clean url handling&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# for things which aren&amp;#39;t real files or dir then&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# take the given url and giv it to index.php?q=...&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;###########################################&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# all url that didn&amp;#39;t match ALL previous rewriteCond are still there&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# squeeze real files or directories, if they really exists&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# then Drupal won&amp;#39;t be called&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;RewriteCond&lt;/span&gt; %{REQUEST_FILENAME} !-f
&lt;span class=&quot;nb&quot;&gt;RewriteCond&lt;/span&gt; %{REQUEST_FILENAME} !-d
 
&lt;span class=&quot;c&quot;&gt;# do not handle the favicon with Drupal bootstrap&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;RewriteCond&lt;/span&gt; %{REQUEST_URI} !=/favicon.ico
 
&lt;span class=&quot;c&quot;&gt;# put everything still there to Drupal index.php&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# [L]= stop rewriting here for matching rules&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# [QSA]=Appends any query string created in the rewrite target&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# to any query string that was in the original request URL&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;RewriteRule&lt;/span&gt; ^(.*)$ index.php?q=$1 [L,QSA]
&lt;span class=&quot;c&quot;&gt;########## END RULE 2 ###################&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Without the comments, for reference:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;nb&quot;&gt;RewriteEngine&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;on&lt;/span&gt;
 
&lt;span class=&quot;nb&quot;&gt;RewriteCond&lt;/span&gt; %{ENV:REDIRECT_STATUS} ^$
&lt;span class=&quot;nb&quot;&gt;RewriteCond&lt;/span&gt; %{QUERY_STRING} . [NC]
&lt;span class=&quot;nb&quot;&gt;RewriteCond&lt;/span&gt; %{QUERY_STRING} (^|&amp;amp;|%26|%20)(q|Q|%71|%51)(=|%3D). [NC]
&lt;span class=&quot;nb&quot;&gt;RewriteRule&lt;/span&gt; .* - [F,L]
 
&lt;span class=&quot;nb&quot;&gt;RewriteCond&lt;/span&gt; %{REQUEST_FILENAME} !-f
&lt;span class=&quot;nb&quot;&gt;RewriteCond&lt;/span&gt; %{REQUEST_FILENAME} !-d
&lt;span class=&quot;nb&quot;&gt;RewriteCond&lt;/span&gt; %{REQUEST_URI} !=/favicon.ico
&lt;span class=&quot;nb&quot;&gt;RewriteRule&lt;/span&gt; ^(.*)$ index.php?q=$1 [L,QSA]
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;WTF: what is this hackme.php file in this javascript library?&lt;/h3&gt;

&lt;p&gt;So, Drupal needs only direct access to the index.php file, usually.&lt;br/&gt;
We could see as well some other php files that could be used to bootstrap Drupal:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;cron.php&lt;/li&gt;
&lt;li&gt;xmlrpc.php&lt;/li&gt;
&lt;li&gt;install.php&lt;/li&gt;
&lt;li&gt;update.php&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Remember the Condition &lt;code&gt;RewriteCond %{REQUEST_FILENAME} !-f&lt;/code&gt;?&lt;br/&gt;
That means any request done directly on one of these 4 files will be allowed.&lt;br/&gt;
You should really use some Location directives to restrict access to &lt;code&gt;cron.php&lt;/code&gt; to &lt;code&gt;127.0.0.1&lt;/code&gt;,
and maybe filter &lt;code&gt;update.php&lt;/code&gt; and &lt;code&gt;install.php&lt;/code&gt; to some IP as well.&lt;br/&gt;
And do you need &lt;code&gt;xmlrpc.php&lt;/code&gt;? I'm not saying these files have known security issues, but if someone
someday fond one ... And for the &lt;code&gt;cron.php&lt;/code&gt; file, this is a good script to request to perform a
nice &lt;code&gt;DOS&lt;/code&gt; with a few requests. This is an example of restrictions for cron.php:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;c&quot;&gt;# Limit cron.php access to localhost only&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;Location&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;/cron.php&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;Order&lt;/span&gt; deny,allow
    &lt;span class=&quot;nb&quot;&gt;deny&lt;/span&gt; from &lt;span class=&quot;k&quot;&gt;all&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;allow&lt;/span&gt; from &lt;span class=&quot;m&quot;&gt;127.0.0.1&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;/Location&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;But if you think you'll never need to access the other files (or that you will alter apache configuation when needed),
you can also add in the VirtualHost (see, no need of mod-rewrite for simple redirects):&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt; &lt;span class=&quot;nb&quot;&gt;Redirect&lt;/span&gt; temp &lt;span class=&quot;sx&quot;&gt;/update.php&lt;/span&gt; http://www.example.com/index.php
 &lt;span class=&quot;nb&quot;&gt;Redirect&lt;/span&gt; temp &lt;span class=&quot;sx&quot;&gt;/install.php&lt;/span&gt; http://www.example.com/index.php
 &lt;span class=&quot;nb&quot;&gt;Redirect&lt;/span&gt; temp &lt;span class=&quot;sx&quot;&gt;/xmlrpc.php&lt;/span&gt; http://www.example.com/index.php
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;But now, let's perform a little find on your Drupal project to see if some other php files aren't there in the web directory
root (so allowing direct access):&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt;find /var/www/mydrupalproject/www -name &lt;span class=&quot;se&quot;&gt;\*&lt;/span&gt;.php
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Ouch, at least &lt;strong&gt;62 files&lt;/strong&gt;, from a basic &lt;strong&gt;nude&lt;/strong&gt; Drupal.&lt;br/&gt;
We're not in a Zend Framework project here (result would be 1), every library is on the document root, like in the 90's !&lt;br/&gt;
So... well each of these files can be requested, but the code is clean and they will not hurt you.
But now you should check very carefully this list, are all these PHP files done by Drupal coders?&lt;br/&gt;
The bad news is that you can sometime find php file with javascript libraries, containg 10 or 20 lines of PHP to make some demos
in the &lt;code&gt;/example&lt;/code&gt; subdirectory of the js lib. And things in these files can be very awfull in term of security.&lt;br/&gt;
On a production server you may also find some new php files, coming from an infected FTP software, that's really bad,
in a short time google will prevent any browser access to your website!&lt;/p&gt;

&lt;p&gt;So the solution? &lt;strong&gt;prevent any access to a php file which is not one of index.php, cron.php, update.php and install.php (and maybe xmlrpc.php)&lt;/strong&gt;&lt;br/&gt;
Just add this last rule:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;c&quot;&gt;########## START RULE 3 ###################&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# deny direct access to php files which aren&amp;#39;t&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# index.php or update.php or install.php or xmlrpc.php or cron.php&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# (like an injected phpinfo.php)&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;###########################################&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;RewriteCond&lt;/span&gt; %{ENV:REDIRECT_STATUS} ^$
&lt;span class=&quot;nb&quot;&gt;RewriteCond&lt;/span&gt; %{REQUEST_FILENAME} -f
&lt;span class=&quot;nb&quot;&gt;RewriteCond&lt;/span&gt; %{REQUEST_FILENAME} .*\.php
&lt;span class=&quot;nb&quot;&gt;RewriteCond&lt;/span&gt; %{REQUEST_FILENAME} !(update\.php|index\.php|install\.php|xmlrpc\.php|cron\.php)
&lt;span class=&quot;nb&quot;&gt;RewriteRule&lt;/span&gt; .* - [F,L]
&lt;span class=&quot;c&quot;&gt;########## END RULE 3 ###################&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;Need to debug? Questions?&lt;/h3&gt;

&lt;p&gt;First, notice that you should &lt;strong&gt;not&lt;/strong&gt; use &lt;strong&gt;Rule1&lt;/strong&gt; while clean url is not activated
(as it forbid direct usage of Drupal without clean url urls).&lt;br/&gt;
If you want to make some more rules, or debug what mod-rewrite is doing for one request add theses settings in the VirtualHost
(&lt;strong&gt;not&lt;/strong&gt; on the &lt;code&gt;Directory&lt;/code&gt; section like the rules):&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;nb&quot;&gt;RewriteEngine&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;on&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# debug mod_rewrite&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;RewriteLogLevel&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;9&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;RewriteLog&lt;/span&gt; &lt;span class=&quot;sx&quot;&gt;/tmp/rewritelog.log&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Then a &lt;code&gt;&quot;tail -f /tmp/rewritelog.log&quot;&lt;/code&gt; will show you a lot of things.
Do not do that on a production server.&lt;br/&gt;
You may get too much informations when using a classical browser, you'll get the gzipped content, extra rules applied,
and all static file requests.&lt;br/&gt;
Check &lt;a href=&quot;/Apache/English/2009/11/05/use_rewrite_map_to_prevent_proxying_for_some_static_contents/&quot;&gt;this previous article&lt;/a&gt; on how to perform a single request for a single page with a one-liner.&lt;/p&gt;

&lt;p&gt;For any other help check theses links (or comment, or send me an email)&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://httpd.apache.org/docs/current/rewrite/&quot;&gt;Mod rewrites pages (all languages)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://serverfault.com/&quot;&gt;Server Fault (en)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://stackoverflow.com/&quot;&gt;Stack Overflow (en)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://drupal.stackexchange.com/&quot;&gt;Drupal Answers (en)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;h3&gt;Closely Related articles&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;/Drupal/English/2011/09/02/Tune_your_php_settings_for_drupal/&quot;&gt;Tune your php settings for Drupal&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/Drupal/English/2011/09/03/Install_drupal_in_php_fpm_fastcgi_and_apache_chroot/&quot;&gt;Drupal with Apache &amp;amp; chrooted php-fpm&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

</description>
				<published>2011-09-01 00:00:00 +0200</published>
				<link>http://regilero.github.io/Drupal/English/2011/09/01/better_rewrite_rules_for_drupal/</link>
			</item>
		
			<item>
				<title>Requêtes récursives avec PostgreSQL 8.4 (WITH RECURSIVE)</title>
				<description>&lt;p&gt;Si vous avez déjà touché à un Oracle vous connaissez peut-être le mot clef &lt;code&gt;CONNECT BY&lt;/code&gt; qui permet d'effectuer des &lt;strong&gt;requêtes arborescentes&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;Les requêtes arborescentes sont très pratiques pour extraire des données sous forme &lt;strong&gt;d'arbre&lt;/strong&gt;, pour, par exemple,
remplir le jeu de données d'un arbre de type &lt;a href=&quot;http://www.jstree.com/&quot;&gt;jstree&lt;/a&gt; ou autre &lt;a href=&quot;http://plugins.jquery.com/?s=tree&quot;&gt;plugin jquery d'arbre&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Pour faire simple dès que vous avez une table avec une &lt;strong&gt;relation parent qui est une jointure sur elle-même&lt;/strong&gt; vous avez des chances
 d'avoir besoin de requêtes arborescentes. &lt;br/&gt;
Sans cela vous risquez de partir sur des algorithmes assez complexe dans votre language de traitement de données (python, PHP, jsqp, etc).
Et c'est fort dommage quand le SGBD peut vous sauver la vie.&lt;br/&gt;
Or donc sous postgreSQL il n'y avait pas d'équivalent du &lt;code&gt;connect by&lt;/code&gt;, pas de requête arborescente.
Il faudra que dans un billet futur je vous montre mes petits triggers qui permettent de pallier à ça, mais il n'y a rien de simple là-dedans.
Mais depuis la version &lt;code&gt;8.4&lt;/code&gt;, le mot clef &lt;strong&gt;&quot;WITH RECURSIVE&quot;&lt;/strong&gt; nous permet de faire des requêtes récursives.&lt;br/&gt;
Nous allons donc voir comment cela se manipule avec un exemple concret.&lt;/p&gt;

&lt;h2&gt;L'exemple: des dossiers et fichiers&lt;/h2&gt;

&lt;p&gt;Nous allons partir d'une table qui représente l'ensemble des fichiers et répertoires du disque dur, et essayer de faire des requêtes ordonnées
dessus.&lt;/p&gt;

&lt;p&gt;Donc on commence par &lt;strong&gt;la structure de la table qui va acceuillir toutes ces données&lt;/strong&gt;, je mets tout ça dans une base &lt;code&gt;test&lt;/code&gt; accessible avec un user
&lt;code&gt;testuser&lt;/code&gt; et un mot de passe qui va bien:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;sql&quot;&gt;&lt;span class=&quot;k&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;TYPE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILETYPE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;AS&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ENUM&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;file&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;directory&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;create&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;table&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
   &lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;              &lt;span class=&quot;nb&quot;&gt;SERIAL&lt;/span&gt;              &lt;span class=&quot;k&quot;&gt;not&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
   &lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt;            &lt;span class=&quot;nb&quot;&gt;varchar&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;256&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;        &lt;span class=&quot;k&quot;&gt;not&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
   &lt;span class=&quot;n&quot;&gt;FILE_FULLNAME&lt;/span&gt;        &lt;span class=&quot;nb&quot;&gt;varchar&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1024&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;        &lt;span class=&quot;k&quot;&gt;not&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;unique&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
   &lt;span class=&quot;n&quot;&gt;FILE_TYPE&lt;/span&gt;            &lt;span class=&quot;n&quot;&gt;FILETYPE&lt;/span&gt;             &lt;span class=&quot;k&quot;&gt;not&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;file&amp;#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
   &lt;span class=&quot;n&quot;&gt;FILE_PARENT&lt;/span&gt;           &lt;span class=&quot;n&quot;&gt;INT4&lt;/span&gt;                 &lt;span class=&quot;k&quot;&gt;not&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;references&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;on&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;update&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;restrict&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;on&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;delete&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;restrict&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
   &lt;span class=&quot;k&quot;&gt;CONSTRAINT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PK_FILE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;primary&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;key&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;create&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;index&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE_FULLNAME_IDX&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;on&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;FILE_FULLNAME&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;create&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;index&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE_NAME_IDX&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;on&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;On remarque la liaison &lt;code&gt;&quot;references&quot;&lt;/code&gt; sur &lt;code&gt;FILE_PARENT&lt;/code&gt; qui pointe sur la table elle-même, c'est tout le principe.&lt;br/&gt;
Maintenant il va falloir remplir cette table. Ce n'est pas la partie la plus simple.
Le mieux serait sans doute un script python mais comme je suis un peu dingue j'ai écrit un script en bash
(vous remarquerez que je limite à 30 caractères dans le nom de directory pour restreindre l'analyse,
mais vous pouvez mettre plus si vous avez le temps d'attendre):&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt;&lt;span class=&quot;c&quot;&gt;#!/bin/bash&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;REP_SOURCE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;/&amp;quot;&lt;/span&gt;;
&lt;span class=&quot;nv&quot;&gt;BASE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;test&amp;quot;&lt;/span&gt;;
&lt;span class=&quot;nv&quot;&gt;HOST&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;localhost&amp;quot;&lt;/span&gt;;
&lt;span class=&quot;nv&quot;&gt;USER&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;testuser&amp;quot;&lt;/span&gt;;
&lt;span class=&quot;nv&quot;&gt;MAXLENGHT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;30;

&lt;span class=&quot;c&quot;&gt;# trap ctrl-c and call ctrl_c()&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;trap &lt;/span&gt;ctrl_c INT

&lt;span class=&quot;k&quot;&gt;function &lt;/span&gt;ctrl_c&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;** Trapped CTRL-C&amp;quot;&lt;/span&gt;;
    &lt;span class=&quot;nb&quot;&gt;exit &lt;/span&gt;1;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;function &lt;/span&gt;normalize &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;$1&amp;quot;&lt;/span&gt;|sed &lt;span class=&quot;s2&quot;&gt;&amp;quot;s/\&amp;quot;/_/g&amp;quot;&lt;/span&gt;|sed &lt;span class=&quot;s2&quot;&gt;&amp;quot;s/&amp;#39;/_/g&amp;quot;&lt;/span&gt;|sed &lt;span class=&quot;s2&quot;&gt;&amp;quot;s/ /_/g&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;)&lt;/span&gt;;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;function &lt;/span&gt;treeanalyse &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;DIR&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$1&lt;/span&gt;;
    &lt;span class=&quot;c&quot;&gt;# shorten duration of this script with path greater than MAXLENGHT chars&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;expr length &lt;span class=&quot;s2&quot;&gt;&amp;quot;$DIR&amp;quot;&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$len&lt;/span&gt; -lt &lt;span class=&quot;nv&quot;&gt;$MAXLENGHT&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;; &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;#echo &amp;quot;DIR $DIR&amp;quot;&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;nDIR&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt;normalize &lt;span class=&quot;s2&quot;&gt;&amp;quot;$DIR&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;)&lt;/span&gt;;
        &lt;span class=&quot;c&quot;&gt;# files detection&lt;/span&gt;
        find &lt;span class=&quot;s2&quot;&gt;&amp;quot;$DIR&amp;quot;&lt;/span&gt; -maxdepth 1 -type f | &lt;span class=&quot;k&quot;&gt;while &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;read &lt;/span&gt;FIL ; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;            &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;FILENAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;basename &lt;span class=&quot;s2&quot;&gt;&amp;quot;$FIL&amp;quot;&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;;
            &lt;span class=&quot;nv&quot;&gt;nNAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt;normalize &lt;span class=&quot;s2&quot;&gt;&amp;quot;$FILENAME&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;)&lt;/span&gt;;
            &lt;span class=&quot;nv&quot;&gt;nFIL&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt;normalize &lt;span class=&quot;s2&quot;&gt;&amp;quot;$FIL&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;)&lt;/span&gt;;
            &lt;span class=&quot;nv&quot;&gt;SQL&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;INSERT INTO FILE (FILE_NAME,FILE_FULLNAME,FILE_TYPE,FILE_PARENT) SELECT &amp;#39;$nNAME&amp;#39;,&amp;#39;$nFIL&amp;#39;,&amp;#39;file&amp;#39;, FILE_ID FROM FILE WHERE FILE_FULLNAME=&amp;#39;$nDIR&amp;#39;;&amp;quot;&lt;/span&gt;
            &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;${SQL}&amp;quot;&lt;/span&gt; &amp;gt;&amp;gt; /tmp/insert.sql
        &lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;# directory detection&lt;/span&gt;
        find &lt;span class=&quot;s2&quot;&gt;&amp;quot;${DIR}&amp;quot;&lt;/span&gt; -maxdepth 1 -type d | &lt;span class=&quot;k&quot;&gt;while &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;read &lt;/span&gt;SUBDIR ; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;            &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;$SUBDIR&amp;quot;&lt;/span&gt;;
            &lt;span class=&quot;nv&quot;&gt;DIRNAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;basename &lt;span class=&quot;s2&quot;&gt;&amp;quot;$SUBDIR&amp;quot;&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;$SUBDIR&amp;quot;&lt;/span&gt; !&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;$DIR&amp;quot;&lt;/span&gt; -a &lt;span class=&quot;s2&quot;&gt;&amp;quot;$DIRNAME&amp;quot;&lt;/span&gt; !&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;proc&amp;quot;&lt;/span&gt; -a &lt;span class=&quot;s2&quot;&gt;&amp;quot;$DIRNAME&amp;quot;&lt;/span&gt; !&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;sys&amp;quot;&lt;/span&gt; -a &lt;span class=&quot;s2&quot;&gt;&amp;quot;$DIRNAME&amp;quot;&lt;/span&gt; !&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;mnt&amp;quot;&lt;/span&gt; -a &lt;span class=&quot;s2&quot;&gt;&amp;quot;$DIRNAME&amp;quot;&lt;/span&gt; !&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;.&amp;quot;&lt;/span&gt; -a &lt;span class=&quot;s2&quot;&gt;&amp;quot;$DIRNAME&amp;quot;&lt;/span&gt; !&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;..&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;; &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;                &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;CLEANDIRNAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$DIRNAME&lt;/span&gt;|sed &lt;span class=&quot;s2&quot;&gt;&amp;quot;s/\&amp;quot;/_/g&amp;quot;&lt;/span&gt;|sed &lt;span class=&quot;s2&quot;&gt;&amp;quot;s/&amp;#39;/_/g&amp;quot;&lt;/span&gt;|sed &lt;span class=&quot;s2&quot;&gt;&amp;quot;s/ /_/g&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;)&lt;/span&gt;;
                &lt;span class=&quot;nv&quot;&gt;nDIRNAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt;normalize &lt;span class=&quot;s2&quot;&gt;&amp;quot;$DIRNAME&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;)&lt;/span&gt;;
                &lt;span class=&quot;nv&quot;&gt;nDIR&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt;normalize &lt;span class=&quot;s2&quot;&gt;&amp;quot;$DIR&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;)&lt;/span&gt;;
                &lt;span class=&quot;nv&quot;&gt;nSUBDIR&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt;normalize &lt;span class=&quot;s2&quot;&gt;&amp;quot;$SUBDIR&amp;quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;)&lt;/span&gt;;
                &lt;span class=&quot;nv&quot;&gt;SQL&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;INSERT INTO FILE (FILE_NAME,FILE_FULLNAME,FILE_TYPE,FILE_PARENT) SELECT &amp;#39;$nDIRNAME&amp;#39;,&amp;#39;$nSUBDIR&amp;#39;,&amp;#39;directory&amp;#39;,FILE_ID FROM FILE WHERE FILE_FULLNAME=&amp;#39;$nDIR&amp;#39;;&amp;quot;&lt;/span&gt;
                &lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;${SQL}&amp;quot;&lt;/span&gt; &amp;gt;&amp;gt; /tmp/insert.sql;
                &lt;span class=&quot;nv&quot;&gt;DIRBACKUP&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$DIR&lt;/span&gt;; &lt;span class=&quot;c&quot;&gt;# prevent variable overlap in bash&lt;/span&gt;
                treeanalyse &lt;span class=&quot;nv&quot;&gt;$SUBDIR&lt;/span&gt;;
                &lt;span class=&quot;nv&quot;&gt;DIR&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$DIRBACKUP&lt;/span&gt;; &lt;span class=&quot;c&quot;&gt;# prevent variable overlap in bash&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;fi&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;        done&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;    fi&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;PARENTDIR&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;0&amp;quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;SQL&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;TRUNCATE FILE;&amp;quot;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;${SQL}&amp;quot;&lt;/span&gt; &amp;gt; /tmp/insert.sql;
&lt;span class=&quot;nv&quot;&gt;SQL&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;INSERT INTO FILE (FILE_ID,FILE_NAME,FILE_FULLNAME,FILE_TYPE,FILE_PARENT) VALUES ($PARENTDIR,&amp;#39;$REP_SOURCE&amp;#39;,&amp;#39;$REP_SOURCE&amp;#39;,&amp;#39;directory&amp;#39;,$PARENTDIR);&amp;quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;PARENTDIR&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$REP_SOURCE&lt;/span&gt;;
&lt;span class=&quot;nv&quot;&gt;DIR&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$REP_SOURCE&lt;/span&gt;;
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;${SQL}&amp;quot;&lt;/span&gt; &amp;gt;&amp;gt; /tmp/insert.sql;
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;Analysing&amp;quot;&lt;/span&gt;;
treeanalyse &lt;span class=&quot;nv&quot;&gt;$DIR&lt;/span&gt;;

&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;STARTING SQL INSERTION:&amp;quot;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#PGCOMMAND=&amp;quot;psql -d $BASE -h $HOST -U $USER --single-transaction -f &amp;quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;PGCOMMAND&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;quot;psql -d $BASE -h $HOST -U $USER -f &amp;quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$PGCOMMAND&lt;/span&gt; /tmp/insert.sql;
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;Done&amp;quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;En exécutant ce script (n'oubliez pas le chmod u+x) on obtient un gros fichier &lt;code&gt;/tmp/insert.sql&lt;/code&gt; (109 382 lignes chez moi)
qui est ensuite importé dans un grosse transaction postgreSQL si tout se passe bien.&lt;br/&gt;
Bon, il supporte encore assez mal les noms de dossiers avec ' ou des &quot; dedans, mais même si la transaction echoue vous avez
votre /tmp/insert.sql dans lequel vous pouvez peut-être supprimer les dossiers et fichiers embétants.&lt;/p&gt;

&lt;h2&gt;Tester les requêtes récursives&lt;/h2&gt;

&lt;p&gt;Voyons ensuite la requête récursive, la &lt;a href=&quot;http://www.postgresql.org/docs/8.4/static/queries-with.html&quot;&gt;documentation postgreSQL&lt;/a&gt;  nous donne un modèle:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;sql&quot;&gt;&lt;span class=&quot;k&quot;&gt;WITH&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;RECURSIVE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;AS&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;VALUES&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;UNION&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;ALL&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;WHERE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;100&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Qui sur notre table des fichiers va donner:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;sql&quot;&gt;&lt;span class=&quot;k&quot;&gt;WITH&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;RECURSIVE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rectable&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_FULLNAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_TYPE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;AS&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_FULLNAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_TYPE&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;WHERE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE_FULLNAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;/usr/local&amp;#39;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;UNION&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;ALL&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_FULLNAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_TYPE&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rectable&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;WHERE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_PARENT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_FULLNAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_TYPE&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rectable&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;BY&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE_FULLNAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Pour par exemple obtenir le sous arbre de &lt;code&gt;/usr/local&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Remarquez la façon dont la table &lt;code&gt;FILE&lt;/code&gt; se voit renommée &lt;strong&gt;3 fois&lt;/strong&gt; pour la requête, &lt;code&gt;rectable&lt;/code&gt; devient la requête récursive,
une &quot;fausse table&quot; sur laquelle on fait notre requête finale.&lt;br/&gt;
A l'intérieur nous avons une première partie qui initialise la récursion en sélectionnant une ligne de la table &lt;code&gt;FILE&lt;/code&gt;,
et après le &lt;code&gt;UNION ALL&lt;/code&gt; nous utilisons &lt;code&gt;rectable&lt;/code&gt; qui contient au départ &lt;strong&gt;l'initialisation&lt;/strong&gt; et plus tard les &lt;strong&gt;résultats&lt;/strong&gt;
des récursions passées que nous joignons avec la table &lt;code&gt;FILE&lt;/code&gt; renommée pour l'occasion &lt;code&gt;orig&lt;/code&gt;, jointe sur la relation parent.&lt;br/&gt;
C'est différent de la syntaxe du &lt;code&gt;CONNECT BY&lt;/code&gt; de oracle, mais je ne suis pas loin de penser que c'est plus élégant
(&lt;strike&gt;peut-être pas encore aussi puissant, pas de détection de cycle, de leaf ou de level
-- quoique en lisant bien la doc je dois pouvoir le faire&lt;/strike&gt;).&lt;/p&gt;

&lt;p&gt;Alors vous me direz que faire un &lt;code&gt;order by&lt;/code&gt; sur le &lt;code&gt;FILE_FULLNAME&lt;/code&gt; pour avoir la requêtre triée c'est un peu de la triche,
parce qu'on aurait pu alors tout aussi juste stocker le &lt;code&gt;FULLNAME&lt;/code&gt; et se servir du tri sans la récursion.&lt;br/&gt;
C'est un peu vrai, mais là j'ai mis le &lt;code&gt;FILE_FULLNAME&lt;/code&gt; pour faire &lt;strong&gt;joli&lt;/strong&gt;, je ne suis pas du tout obligé de stocker cette information.
Donc voici la même mais ordonnée sur la relation parent:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;sql&quot;&gt;&lt;span class=&quot;k&quot;&gt;WITH&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;RECURSIVE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rectable&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_FULLNAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_TYPE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_PARENT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;AS&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_FULLNAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_TYPE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_PARENT&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;WHERE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE_FULLNAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;/usr/local&amp;#39;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;UNION&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;ALL&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_FULLNAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_TYPE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_PARENT&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rectable&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;WHERE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_PARENT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_FULLNAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_TYPE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_PARENT&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rectable&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;BY&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE_PARENT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Problème on perd notre tri d'arbre.&lt;br/&gt;
On a d'abord les répertoires et ensuite seulement les fichiers de ces répertoires.
Si on veut trier proprement sans avoir le &lt;code&gt;FILE_FULLNAME&lt;/code&gt; il faut en fait le récréer dans la récursion:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;sql&quot;&gt;&lt;span class=&quot;k&quot;&gt;WITH&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;RECURSIVE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rectable&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_TYPE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_PARENT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rorder&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;AS&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_TYPE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_PARENT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;/&amp;#39;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;||&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rorder&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;WHERE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE_FULLNAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;/usr/local/nagios&amp;#39;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;UNION&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;ALL&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_TYPE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_PARENT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rorder&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;||&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;/&amp;#39;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;||&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rorder&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rectable&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;WHERE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_PARENT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_TYPE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_PARENT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rorder&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rectable&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;BY&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rorder&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
 &lt;span class=&quot;n&quot;&gt;file_id&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;              &lt;span class=&quot;n&quot;&gt;file_name&lt;/span&gt;               &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;file_type&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;file_parent&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;                        &lt;span class=&quot;n&quot;&gt;rorder&lt;/span&gt;                       
&lt;span class=&quot;c1&quot;&gt;---------+--------------------------------------+-----------+-------------+------------------------------------------------------&lt;/span&gt;
   &lt;span class=&quot;mi&quot;&gt;80764&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nagios&lt;/span&gt;                               &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;directory&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;       &lt;span class=&quot;mi&quot;&gt;80760&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nagios&lt;/span&gt;
   &lt;span class=&quot;mi&quot;&gt;80782&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bin&lt;/span&gt;                                  &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;directory&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;       &lt;span class=&quot;mi&quot;&gt;80764&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nagios&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bin&lt;/span&gt;
   &lt;span class=&quot;mi&quot;&gt;80785&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nagios&lt;/span&gt;                               &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;      &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;       &lt;span class=&quot;mi&quot;&gt;80782&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nagios&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bin&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nagios&lt;/span&gt;
   &lt;span class=&quot;mi&quot;&gt;80784&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nagiostats&lt;/span&gt;                           &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;      &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;       &lt;span class=&quot;mi&quot;&gt;80782&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nagios&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bin&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nagiostats&lt;/span&gt;
   &lt;span class=&quot;mi&quot;&gt;80786&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ndo2db&lt;/span&gt;                               &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;      &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;       &lt;span class=&quot;mi&quot;&gt;80782&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nagios&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bin&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ndo2db&lt;/span&gt;
   &lt;span class=&quot;mi&quot;&gt;80783&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ndomod&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;o&lt;/span&gt;                             &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;      &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;       &lt;span class=&quot;mi&quot;&gt;80782&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nagios&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;bin&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ndomod&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;o&lt;/span&gt;
   &lt;span class=&quot;mi&quot;&gt;80765&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;etc&lt;/span&gt;                                  &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;directory&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;       &lt;span class=&quot;mi&quot;&gt;80764&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nagios&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;etc&lt;/span&gt;
   &lt;span class=&quot;mi&quot;&gt;80767&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cgi&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cfg&lt;/span&gt;                              &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;      &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;       &lt;span class=&quot;mi&quot;&gt;80765&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nagios&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;etc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cgi&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cfg&lt;/span&gt;
   &lt;span class=&quot;mi&quot;&gt;80770&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;htpasswd&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;users&lt;/span&gt;                       &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;      &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;       &lt;span class=&quot;mi&quot;&gt;80765&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nagios&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;etc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;htpasswd&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;users&lt;/span&gt;
   &lt;span class=&quot;mi&quot;&gt;80766&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nagios&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cfg&lt;/span&gt;                           &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;      &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;       &lt;span class=&quot;mi&quot;&gt;80765&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nagios&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;etc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nagios&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cfg&lt;/span&gt;
   &lt;span class=&quot;mi&quot;&gt;80769&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ndo2db&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cfg&lt;/span&gt;                           &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;      &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;       &lt;span class=&quot;mi&quot;&gt;80765&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nagios&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;etc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ndo2db&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cfg&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Et là où ce type de requête devient &lt;strong&gt;magique&lt;/strong&gt;, je vais aussi pouvoir filtrer pour avoir uniquement les directory,
par exemple,
puis filtrer les résultats pour ne garder que les sous-sous répertoires qui commencent par un &lt;code&gt;&quot;.&quot;&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;sql&quot;&gt;&lt;span class=&quot;k&quot;&gt;WITH&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;RECURSIVE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rectable&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_FULLNAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_TYPE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_PARENT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;AS&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_FULLNAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_TYPE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_PARENT&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;WHERE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE_FULLNAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;/usr/local&amp;#39;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;UNION&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;ALL&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_FULLNAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_TYPE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_PARENT&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rectable&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;WHERE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_PARENT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;AND&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_TYPE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;directory&amp;#39;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_FULLNAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_TYPE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_PARENT&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rectable&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;WHERE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rectable&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;LIKE&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&amp;#39;.%&amp;#39;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;BY&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE_FULLNAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;file_id&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;file_name&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;                      &lt;span class=&quot;n&quot;&gt;file_fullname&lt;/span&gt;                      &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;file_type&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;file_parent&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;---------+-----------+---------------------------------------------------------+-----------+-------------&lt;/span&gt;
   &lt;span class=&quot;mi&quot;&gt;31058&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;deps&lt;/span&gt;     &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;usr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;local&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nagios&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;plugins&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;14&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;plugins&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;root&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;deps&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;directory&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;       &lt;span class=&quot;mi&quot;&gt;31047&lt;/span&gt;
   &lt;span class=&quot;mi&quot;&gt;31059&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;libs&lt;/span&gt;     &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;usr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;local&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nagios&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;plugins&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;14&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;plugins&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;root&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;libs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;directory&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;       &lt;span class=&quot;mi&quot;&gt;31047&lt;/span&gt;
   &lt;span class=&quot;mi&quot;&gt;31112&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;deps&lt;/span&gt;     &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;usr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;local&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nagios&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;plugins&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;14&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tap&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;deps&lt;/span&gt;          &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;directory&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;       &lt;span class=&quot;mi&quot;&gt;31105&lt;/span&gt;
   &lt;span class=&quot;mi&quot;&gt;31502&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;deps&lt;/span&gt;     &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;usr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;local&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nagios&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;plugins&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;14&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gl&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;deps&lt;/span&gt;           &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;directory&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;       &lt;span class=&quot;mi&quot;&gt;31243&lt;/span&gt;
   &lt;span class=&quot;mi&quot;&gt;31627&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;deps&lt;/span&gt;     &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;usr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;local&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nagios&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;plugins&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;14&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lib&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;deps&lt;/span&gt;          &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;directory&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;       &lt;span class=&quot;mi&quot;&gt;31565&lt;/span&gt;
   &lt;span class=&quot;mi&quot;&gt;31616&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;deps&lt;/span&gt;     &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;usr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;local&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nagios&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;plugins&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;14&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lib&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tests&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;deps&lt;/span&gt;    &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;directory&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;       &lt;span class=&quot;mi&quot;&gt;31586&lt;/span&gt;
   &lt;span class=&quot;mi&quot;&gt;31766&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;deps&lt;/span&gt;     &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;usr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;local&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nagios&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;plugins&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;14&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;plugins&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;deps&lt;/span&gt;      &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;directory&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;       &lt;span class=&quot;mi&quot;&gt;31645&lt;/span&gt;
   &lt;span class=&quot;mi&quot;&gt;31812&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;libs&lt;/span&gt;     &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;usr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;local&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;nagios&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;plugins&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;14&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;plugins&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;libs&lt;/span&gt;      &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;directory&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;       &lt;span class=&quot;mi&quot;&gt;31645&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lignes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Si vous voulez garder les fonctionnalités avancées du &lt;code&gt;CONNECT BY&lt;/code&gt; comme les détection de &lt;strong&gt;levels&lt;/strong&gt; et de &lt;strong&gt;cycles&lt;/strong&gt;
il y a (en dehors de la méthode expliquée ci-dessous) la solution des &lt;strong&gt;triggers&lt;/strong&gt; à l'insertion, que je rédigerai dès que j'en aurais le temps...&lt;br/&gt;
Mais déjà nous pouvons ajouter facilement le niveau de profondeur en nous basant sur le premier modèle:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;sql&quot;&gt;&lt;span class=&quot;k&quot;&gt;WITH&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;RECURSIVE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rectable&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_FULLNAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_TYPE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_PARENT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;level&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;AS&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_FULLNAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_TYPE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_PARENT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;level&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;WHERE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE_FULLNAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;/usr/local/nagios&amp;#39;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;UNION&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;ALL&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_FULLNAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_TYPE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_PARENT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;level&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;level&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rectable&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;WHERE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_PARENT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_FULLNAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_TYPE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_PARENT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;level&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rectable&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;BY&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE_FULLNAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Essayons de casser un peu tout ça.&lt;/h2&gt;

&lt;p&gt;Nous allons tester la &lt;strong&gt;détection de cycle&lt;/strong&gt; proposée dans la documentation.&lt;/p&gt;

&lt;pre&gt;
  80764 | nagios   | directory | 80760 | /usr/local/nagios
  80782 | bin      | directory | 80764 | /usr/local/nagios/bin
  80772 | objects  | directory | 80765 | /usr/local/nagios/etc/objects
&lt;/pre&gt;


&lt;p&gt;Créeons un &lt;strong&gt;bug&lt;/strong&gt;, On va chercher à partir de &lt;code&gt;/usr/local/nagios-80764&lt;/code&gt; et donner un répertoire parent (&lt;code&gt;/usr/local-80760&lt;/code&gt;)
comme fils d'un des sous répertoires (&lt;code&gt;/usr/local/nagios/etc/objects-80765&lt;/code&gt;)&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;sql&quot;&gt;&lt;span class=&quot;k&quot;&gt;UPDATE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;SET&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE_PARENT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;80765&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;WHERE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;80760&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Utilisons le chemin recomposé et non le &lt;code&gt;FILE_FULLNAME&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;sql&quot;&gt;&lt;span class=&quot;k&quot;&gt;WITH&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;RECURSIVE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rectable&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rorder&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_TYPE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_PARENT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;level&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;AS&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;/&amp;#39;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;||&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rorder&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_TYPE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_PARENT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;level&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;WHERE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE_FULLNAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;/usr/local/nagios&amp;#39;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;UNION&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;ALL&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rorder&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;||&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;/&amp;#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rorder&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_TYPE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_PARENT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;level&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;level&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rectable&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;WHERE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_PARENT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rorder&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_TYPE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_PARENT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;level&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rectable&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;BY&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rorder&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;==&gt; oups ça ne réponds plus (boucle infinie) faire un CTRL-C&lt;br/&gt;
On va donc ajouter la détection de cycle, notre chemin recomposé va se doubler d'un &lt;strong&gt;tableau des identifiants parcourus&lt;/strong&gt;
et nous ferons une &lt;strong&gt;recherche&lt;/strong&gt; dans cet &lt;code&gt;array&lt;/code&gt; pour détecter le cycle:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;sql&quot;&gt;&lt;span class=&quot;k&quot;&gt;WITH&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;RECURSIVE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rectable&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rorder&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_TYPE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_PARENT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;level&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;cycle&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;AS&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;/&amp;#39;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;||&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rorder&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_TYPE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_PARENT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;level&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;ARRAY&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;false&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;WHERE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE_FULLNAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;/usr/local/nagios&amp;#39;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;UNION&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;ALL&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rorder&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;||&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&amp;#39;/&amp;#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rorder&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_TYPE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_PARENT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;rec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;level&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;level&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;||&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;ANY&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rectable&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;WHERE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;orig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_PARENT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;AND&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;NOT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;cycle&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FILE_ID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_NAME&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rorder&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_TYPE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;FILE_PARENT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;level&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;cycle&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;FROM&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rectable&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;BY&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rorder&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Et ça fonctionne, on a beaucoup trop de résultats (une partie de &lt;code&gt;/usr/local&lt;/code&gt; branché dans &lt;code&gt;/usr/local/nagios/etc/configObjects&lt;/code&gt;) -- à cause du bug introduit --
mais au moins la requête réponds et ne fais pas une boucle infinie.
La détection de cycle se base ici sur l'array des Identifiants parcourus, des exemples plus complexes sont données dans la documentation
posgreSQL citée plus haut. &lt;strong&gt;Attention&lt;/strong&gt; à ne pas oublier le &lt;code&gt;AND NOT cycle&lt;/code&gt; dans la sous-requête.&lt;/p&gt;
</description>
				<published>2010-10-14 00:00:00 +0200</published>
				<link>http://regilero.github.io/PostgreSQL/Francais/2010/10/14/requetes_recursives_avec_postgresql_8_4/</link>
			</item>
		
			<item>
				<title>Nice Webapps and tools using canvas</title>
				<description>&lt;p&gt;Doing some research on HTML5/Canvas usage I found theses tools on the web:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://pencil.evolus.vn/en-US/Home.aspx&quot;&gt;Pencil Project&lt;/a&gt;: graphic editor, nice replacement for dia&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://www.websequencediagrams.com/&quot;&gt;Web Sequence Diagrams&lt;/a&gt;: simple and useful UML sequence diagrams tool, I also like the &lt;a href=&quot;http://zwibbler.com/&quot;&gt;Human Drawing editor&lt;/a&gt; from the same author, nice code.&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://typeface.neocracy.org/&quot;&gt;Typeface&lt;/a&gt; , &lt;a href=&quot;http://cufon.shoqolate.com&quot;&gt;Cufon&lt;/a&gt;, &lt;a href=&quot;http://www.netzgesta.de/dev/text/&quot;&gt;StrokeText&lt;/a&gt;: 3 libraries used to add embeded font support on a page (and for other js usage).&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://www.benjoffe.com/code/all&quot;&gt;demos there&lt;/a&gt;, I especially like the '3D walker'&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://code.google.com/p/iecanvas/&quot;&gt;http://code.google.com/p/iecanvas/&lt;/a&gt;, &lt;a href=&quot;http://code.google.com/p/explorercanvas/&quot;&gt;http://code.google.com/p/explorercanvas/&lt;/a&gt; some libs to try adding canvas support in IE&lt;/li&gt;
&lt;/ul&gt;

</description>
				<published>2010-08-16 00:00:00 +0200</published>
				<link>http://regilero.github.io/Js/English/2010/08/16/nice_webapps_and_tools_using_canvas/</link>
			</item>
		
			<item>
				<title>More on Static file redirector</title>
				<description>&lt;p&gt;So On &lt;a href=&quot;/Apache/English/2009/11/05/use_rewrite_map_to_prevent_proxying_for_some_static_contents/&quot;&gt;a previous blog entry&lt;/a&gt;
I presented the basics for a rewriteRule settings to serve some targeted plone static files directly from apache and
without proxying to Plone.&lt;/p&gt;

&lt;p&gt;This article, in short introduce apache as a proxy for most pages but as a direct file server for static ressources,
having a map of application url to filesystem real files stored in a text file and served via RewriteMap.&lt;/p&gt;

&lt;p&gt;No let's make this solution even better.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;use a &lt;strong&gt;hash map&lt;/strong&gt; for url mappings&lt;/li&gt;
&lt;li&gt;create a virtual &lt;code&gt;/static&lt;/code&gt; url and apply some cache managment rules on his contents&lt;/li&gt;
&lt;li&gt;allow the use of the &lt;code&gt;/satic/&lt;/code&gt; url directly&lt;/li&gt;
&lt;li&gt;ensure only mapped static files are served via this static directory&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So first thing to change, we used a simple text file for the mapping, mod_rewrite allows us to use a &lt;strong&gt;hash file&lt;/strong&gt;.&lt;br/&gt;
Simply change:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;nb&quot;&gt;RewriteMap&lt;/span&gt; statics txt:/var/www/proxyplone/etc/staticplonefiles.txt
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;by:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;c&quot;&gt;# RewriteMap statics txt:/var/www/proxyplone//etc/staticplonefiles.txt&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# to generate hash version of previous file use (do not forget the rm):&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# rm /var/www/proxyplone//etc/staticplonefiles.map; &lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# httxt2dbm -i /var/www/proxyplone/etc/staticplonefiles.txt -o /var/www/proxyplone/etc/staticplonefiles.map&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;RewriteMap&lt;/span&gt; statics dbm:/var/www/proxyplone/etc/staticplonefiles.map
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;And to generate the .map file simply read the comments. &lt;br/&gt;
One important point, if you do not remove the old map before generating the new one,
old entries are still in the .map, to see it without too much garbage use :&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;nb&quot;&gt;strings&lt;/span&gt; &lt;span class=&quot;sx&quot;&gt;/var/www/proxyplone/etc/staticplonefiles.map&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Ok, so now let's look the current RewriteRule,
for matched elements the rewrite is done and the file is directly served.
We would like to add some apache settings to theses files,
the solution is to add the &lt;code&gt;[PT]&lt;/code&gt; (pass-through) option to the rewrite rule.&lt;br/&gt;
Then Apache will continue to analyse the resulting url as if it were an original
requested url. &lt;br/&gt;
That mean the proxy settings for example will be applied on it.&lt;br/&gt;
So we will as well add a &lt;code&gt;/satic&lt;/code&gt; on the resulting url and prevent &lt;code&gt;/static&lt;/code&gt; to be served by the Proxy.&lt;br/&gt;
The rewriteRule is now:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;nb&quot;&gt;RewriteRule&lt;/span&gt; ^/(.*\.(ico|png|gif|jpg|jpeg|bmp|css|js)) &lt;span class=&quot;sx&quot;&gt;/static/&lt;/span&gt;${statics:$1} [NC,L,handler=default-handler,PT]
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;And we add this ProxyPass exception:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;nb&quot;&gt;ProxyPass&lt;/span&gt;       &lt;span class=&quot;sx&quot;&gt;/static&lt;/span&gt;  !
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;We now have a virtual &lt;code&gt;/static&lt;/code&gt; directory with all theses mapped contents inside.
We can use it to getBack the original DocumentRoot,
and to use an alias to point &lt;code&gt;/static&lt;/code&gt; to our webapp sources (here &lt;code&gt;/opt/plone/source&lt;/code&gt;).
And then we can add Expires settings from mod_expires on this &lt;code&gt;/static&lt;/code&gt; location... &lt;br/&gt;
well in fact mod_expires requires a Directory directive so it will be on the &lt;code&gt;/opt/plone/source&lt;/code&gt; directory.&lt;/p&gt;

&lt;p&gt;Reset DocumentRoot:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;nb&quot;&gt;DocumentRoot&lt;/span&gt; &lt;span class=&quot;sx&quot;&gt;/var/www/proxyplone/htdocs&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Remove this line:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;nb&quot;&gt;Alias&lt;/span&gt; / &lt;span class=&quot;sx&quot;&gt;/opt/plone/source/&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;And add theses settings:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;nb&quot;&gt;Alias&lt;/span&gt; &lt;span class=&quot;sx&quot;&gt;/static&lt;/span&gt; &lt;span class=&quot;sx&quot;&gt;/opt/plone/source/&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;Location&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;/static&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;Options&lt;/span&gt; FollowSymLinks
    &lt;span class=&quot;nb&quot;&gt;Order&lt;/span&gt; deny,allow
    &lt;span class=&quot;nb&quot;&gt;Allow&lt;/span&gt; from &lt;span class=&quot;k&quot;&gt;all&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;DirectoryIndex&lt;/span&gt; index.html
    &lt;span class=&quot;c&quot;&gt;# avoid execution of PHP  scripts&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;AddType&lt;/span&gt; text/plain .php
    &lt;span class=&quot;nb&quot;&gt;AddType&lt;/span&gt; text/plain .php3
    &lt;span class=&quot;nb&quot;&gt;AddType&lt;/span&gt; text/plain .phps
&lt;span class=&quot;nt&quot;&gt;&amp;lt;/Location&amp;gt;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# adding some cache handling for static files&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;Directory&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;/opt/plone/source&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;order&lt;/span&gt; allow,deny
    &lt;span class=&quot;nb&quot;&gt;allow&lt;/span&gt; from &lt;span class=&quot;k&quot;&gt;all&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;ExpiresActive&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;On&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;ExpiresDefault&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;access plus 1 month&amp;quot;&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;ExpiresByType&lt;/span&gt; text/css &lt;span class=&quot;s2&quot;&gt;&amp;quot;access plus 1 day&amp;quot;&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;ExpiresByType&lt;/span&gt; text/javascript &lt;span class=&quot;s2&quot;&gt;&amp;quot;access plus 1 day&amp;quot;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;/Directory&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;That's done. &lt;strong&gt;Now we have a big security Hole :-(&lt;/strong&gt;.&lt;br/&gt;
Most files from &lt;code&gt;/opt/plone/source&lt;/code&gt; are available via the &lt;code&gt;/static&lt;/code&gt; url. &lt;br/&gt;
As &lt;code&gt;/static&lt;/code&gt; is not proxied anymore and is now an alias on the filesystem directory where we have an allow from all ...&lt;br/&gt;
So we should add some rewriteRules to check which files are allowed via direct access on static.
And by default it should be *none&lt;strong&gt;.
But that's sad, it would be nice to promote good behaviour for theses wtf programmers which aren't admins,
we should let them use &lt;code&gt;/static&lt;/code&gt; urls for files known to be static.
And maybe one day they'll think it's a good idea to make the distinction between known static files and dynamic content... &lt;br/&gt;
So we'll ask developpers to add some entries in the &lt;/strong&gt;staticplonefiles.txt** making a mapping from static/files to real files this way (see, every entry is present 2 times):&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;c&quot;&gt;# staticplonefiles.txt&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# url =&amp;gt; real filesystem file, from an arbitray root&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;zonea/images/clean&lt;/span&gt;.&lt;span class=&quot;nb&quot;&gt;png&lt;/span&gt; foo/bar/img/clean.png
&lt;span class=&quot;err&quot;&gt;/static/foo/bar/img/clean&lt;/span&gt;.&lt;span class=&quot;nb&quot;&gt;png&lt;/span&gt; foo/bar/img/clean.png
&lt;span class=&quot;err&quot;&gt;zonea/images/logo&lt;/span&gt;.&lt;span class=&quot;nb&quot;&gt;jpg&lt;/span&gt; foo/src/module/foo/images/logo.png
&lt;span class=&quot;err&quot;&gt;/static/foo/src/module/foo/images/logo&lt;/span&gt;.&lt;span class=&quot;nb&quot;&gt;png&lt;/span&gt; foo/src/module/foo/images/logo.png
&lt;span class=&quot;err&quot;&gt;/module/bar/images/people&lt;/span&gt;.&lt;span class=&quot;nb&quot;&gt;png&lt;/span&gt; foo/src/module/bar/v1.2.5-5/images/people.png
&lt;span class=&quot;err&quot;&gt;/static/foo/src/module/bar/v1&lt;/span&gt;.&lt;span class=&quot;err&quot;&gt;2&lt;/span&gt;.&lt;span class=&quot;err&quot;&gt;5-5/images/people&lt;/span&gt;.&lt;span class=&quot;nb&quot;&gt;png&lt;/span&gt; foo/src/module/bar/v1.2.5-5/images/people.png
&lt;span class=&quot;c&quot;&gt;# ... to be continued&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;And now our 3 static examples are available as well with the /static url. Well in fact do not forget to add this rule:&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;c&quot;&gt;# Security for uri containing our /static shortcut we should check only&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# listed files from rewritemap are served, as&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# in this current case the static directory contins as well&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# some unsecure files... yep.&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;RewriteCond&lt;/span&gt; %{REQUEST_URI} ^/static/ [NC]
&lt;span class=&quot;nb&quot;&gt;RewriteCond&lt;/span&gt; ${statics:$1} =&lt;span class=&quot;s2&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# F : force forbidden 403 response&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;RewriteRule&lt;/span&gt; ^(.*)$ - [F,L]
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This will check that all directly accessed files via &lt;code&gt;/static&lt;/code&gt; are present in our mapping.
And it's all done.
Like for the previous post you should really activate &lt;code&gt;RewriteLog&lt;/code&gt; and look at what he does
for several different files, but now you should as well adjust Apache logLevel for this
VirtualHost and check the errorLog to observe what is done After the rewrite.&lt;/p&gt;

&lt;p&gt;As an example of debug here are some debug outputs for:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;a matched image&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;err&quot;&gt;(2)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;init&lt;/span&gt; rewrite engine with requested uri &lt;span class=&quot;sx&quot;&gt;/images/people.png&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;(3)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;applying&lt;/span&gt; pattern &amp;#39;^/(.*\.(ico|png|gif|jpg|jpeg|bmp|css|js))&amp;#39; to uri &amp;#39;/images/people.png&amp;#39;
&lt;span class=&quot;err&quot;&gt;(6)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;cache&lt;/span&gt; lookup FAILED, forcing new map lookup
&lt;span class=&quot;err&quot;&gt;(5)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;map&lt;/span&gt; lookup OK: map=statics[dbm] key=images/people.png -&amp;gt; val=test/img/clean.png
&lt;span class=&quot;err&quot;&gt;(4)&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;RewriteCond:&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;input=&amp;#39;test/img/clean&lt;/span&gt;.&lt;span class=&quot;err&quot;&gt;png&amp;#39;&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;pattern=&amp;#39;!=&amp;#39;&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;matched&lt;/span&gt;
(5) cache lookup OK: map=statics[dbm] key=images/people.png -&amp;gt; val=test/img/clean.png
&lt;span class=&quot;err&quot;&gt;(2)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;rewrite&lt;/span&gt; &amp;#39;/images/people.png&amp;#39; -&amp;gt; &amp;#39;/static/test/img/clean.png&amp;#39;
&lt;span class=&quot;err&quot;&gt;(2)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;remember&lt;/span&gt; &lt;span class=&quot;sx&quot;&gt;/static/test/img/clean.png&lt;/span&gt; to have Content-handler &amp;#39;default-handler&amp;#39;
&lt;span class=&quot;err&quot;&gt;(2)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;forcing&lt;/span&gt; &amp;#39;/static/test/img/clean.png&amp;#39; to get passed through to next API URI-to-filename handler
&lt;span class=&quot;err&quot;&gt;(1)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;force&lt;/span&gt; filename &lt;span class=&quot;sx&quot;&gt;/tmp/htdocs/test/img/clean.png&lt;/span&gt; to have the Content-handler &amp;#39;default-handler&amp;#39;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;ul&gt;
&lt;li&gt;index.php which wont be proxified after&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;err&quot;&gt;(2)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;init&lt;/span&gt; rewrite engine with requested uri &lt;span class=&quot;sx&quot;&gt;/index.php&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;(3)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;applying&lt;/span&gt; pattern &amp;#39;^/(.*\.(ico|png|gif|jpg|jpeg|bmp|css|js))&amp;#39; to uri &amp;#39;/index.php&amp;#39;
&lt;span class=&quot;err&quot;&gt;(3)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;applying&lt;/span&gt; pattern &amp;#39;^(.*)$&amp;#39; to uri &amp;#39;/index.php&amp;#39;
&lt;span class=&quot;err&quot;&gt;(4)&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;RewriteCond:&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;input=&amp;#39;/index&lt;/span&gt;.&lt;span class=&quot;err&quot;&gt;php&amp;#39;&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;pattern=&amp;#39;^/static/&amp;#39;&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[NC]&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;not-&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;matched&lt;/span&gt;
(1) pass through &lt;span class=&quot;sx&quot;&gt;/index.php&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;ul&gt;
&lt;li&gt;the / base uri, which will be proxified&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;err&quot;&gt;(2)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;init&lt;/span&gt; rewrite engine with requested uri /
&lt;span class=&quot;err&quot;&gt;(3)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;applying&lt;/span&gt; pattern &amp;#39;^/(.*\.(ico|png|gif|jpg|jpeg|bmp|css|js))&amp;#39; to uri &amp;#39;/&amp;#39;
&lt;span class=&quot;err&quot;&gt;(3)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;applying&lt;/span&gt; pattern &amp;#39;^(.*)$&amp;#39; to uri &amp;#39;/&amp;#39;
&lt;span class=&quot;err&quot;&gt;(4)&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;RewriteCond:&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;input=&amp;#39;/&amp;#39;&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;pattern=&amp;#39;^/static/&amp;#39;&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[NC]&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;not-&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;matched&lt;/span&gt;
(1) pass through /
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;ul&gt;
&lt;li&gt;an unmapped image&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;err&quot;&gt;(2)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;init&lt;/span&gt; rewrite engine with requested uri &lt;span class=&quot;sx&quot;&gt;/images/crystal/32/personal.png&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;(3)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;applying&lt;/span&gt; pattern &amp;#39;^/(.*\.(ico|png|gif|jpg|jpeg|bmp|css|js))&amp;#39; to uri &amp;#39;/images/crystal/32/personal.png&amp;#39;
&lt;span class=&quot;err&quot;&gt;(6)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;cache&lt;/span&gt; lookup FAILED, forcing new map lookup
&lt;span class=&quot;err&quot;&gt;(5)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;map&lt;/span&gt; lookup FAILED: map=statics[dbm] key=images/crystal/32/personal.png
&lt;span class=&quot;err&quot;&gt;(4)&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;RewriteCond:&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;input=&amp;#39;&amp;#39;&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;pattern=&amp;#39;!=&amp;#39;&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;not-&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;matched&lt;/span&gt;
(3) applying pattern &amp;#39;^(.*)$&amp;#39; to uri &amp;#39;/images/crystal/32/personal.png&amp;#39;
&lt;span class=&quot;err&quot;&gt;(4)&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;RewriteCond:&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;input=&amp;#39;/images/crystal/32/personal&lt;/span&gt;.&lt;span class=&quot;err&quot;&gt;png&amp;#39;&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;pattern=&amp;#39;^/static/&amp;#39;&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[NC]&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;not-&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;matched&lt;/span&gt;
(1) pass through &lt;span class=&quot;sx&quot;&gt;/images/crystal/32/personal.png&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;ul&gt;
&lt;li&gt;a direct access via /static for a forbidden file&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;apache&quot;&gt;&lt;span class=&quot;err&quot;&gt;(2)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;init&lt;/span&gt; rewrite engine with requested uri &lt;span class=&quot;sx&quot;&gt;/static/config/config.ini&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;(3)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;applying&lt;/span&gt; pattern &amp;#39;^/(.*\.(ico|png|gif|jpg|jpeg|bmp|css|js))&amp;#39; to uri &amp;#39;/static/config/config.ini&amp;#39;
&lt;span class=&quot;err&quot;&gt;(3)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;applying&lt;/span&gt; pattern &amp;#39;^(.*)$&amp;#39; to uri &amp;#39;/static/config/config.ini&amp;#39;
&lt;span class=&quot;err&quot;&gt;(4)&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;RewriteCond:&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;input=&amp;#39;/static/config/config&lt;/span&gt;.&lt;span class=&quot;err&quot;&gt;ini&amp;#39;&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;pattern=&amp;#39;^/static/&amp;#39;&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[NC]&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;matched&lt;/span&gt;
(6) cache lookup FAILED, forcing new map lookup
&lt;span class=&quot;err&quot;&gt;(5)&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;map&lt;/span&gt; lookup FAILED: map=statics[dbm] key=/static/config/config.ini
&lt;span class=&quot;err&quot;&gt;(4)&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;RewriteCond:&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;input=&amp;#39;&amp;#39;&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;pattern=&amp;#39;=&amp;#39;&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;matched&lt;/span&gt;
(2) forcing responsecode &lt;span class=&quot;m&quot;&gt;403&lt;/span&gt; for &lt;span class=&quot;sx&quot;&gt;/static/config/config.ini&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Quite readable isn't it? But &lt;strong&gt;do not forget to remove debug&lt;/strong&gt; for production env.&lt;/p&gt;

&lt;h3&gt;Closely Related articles&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;/Apache/English/2009/11/05/use_rewrite_map_to_prevent_proxying_for_some_static_contents/&quot;&gt;Use RewriteMap to prevent proxying for some static contents&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

</description>
				<published>2009-11-06 00:00:00 +0100</published>
				<link>http://regilero.github.io/Apache/English/2009/11/06/more_on_static_file_redirector/</link>
			</item>
		
	</channel>
</rss>
